---
import { getCollection, render } from 'astro:content';
import DocLayout from '../layouts/DocLayout.astro';
import { getLastModified } from '../lib/git-history';

// Categories that have auto-generated index pages
const autoIndexCategories = new Set([
  'algorithms',
  'computer-systems', 
  'programming-languages',
  'artificial-intelligence',
  'development-tools',
  'research-projects',
]);

export async function getStaticPaths() {
  const docs = await getCollection('docs');
  return docs
    .filter(entry => {
      // Skip category index files - they're handled by [category]/index.astro
      const parts = entry.id.split('/');
      if (parts.length === 2 && parts[1] === 'index' && autoIndexCategories.has(parts[0])) {
        return false;
      }
      return true;
    })
    .map((entry) => {
      // Remove trailing /index from the slug for index pages
      let slug = entry.id;
      if (slug.endsWith('/index')) {
        slug = slug.slice(0, -6) || 'index';
      }
      if (slug === 'index') {
        slug = '';
      }
      return {
        params: { slug },
        props: { entry },
      };
    });
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);

// Extract title from frontmatter or first heading
const title = entry.data.title || entry.id.split('/').pop()?.replace(/-/g, ' ') || 'Untitled';

// Filter headings for TOC (h2 and h3 only)
const tocHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 3);

// Normalize tags
const tags = entry.data.tags || (entry.data.tag ? (Array.isArray(entry.data.tag) ? entry.data.tag : [entry.data.tag]) : []);

// Get file path and last modified date from Git
const filePath = `src/content/docs/${entry.id}.md`;
const lastUpdated = entry.data.lastUpdated || getLastModified(filePath);
---

<DocLayout 
  title={title}
  description={entry.data.description}
  date={entry.data.date}
  category={entry.data.category}
  tags={tags}
  lastUpdated={lastUpdated}
  filePath={filePath}
  headings={tocHeadings}
>
  <Content />
</DocLayout>
