---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navbar from '../components/layout/Navbar.astro';
import ThemeToggle from '../components/ui/ThemeToggle.astro';
import { getCollection } from 'astro:content';

// Get all docs with dates
const allDocs = await getCollection('docs');
const docsWithDates = allDocs
  .filter(doc => doc.data.date)
  .sort((a, b) => {
    const dateA = a.data.date ? new Date(a.data.date).getTime() : 0;
    const dateB = b.data.date ? new Date(b.data.date).getTime() : 0;
    return dateB - dateA; // Newest first
  });

// Group by year and month
interface GroupedDocs {
  [year: string]: {
    [month: string]: typeof docsWithDates;
  };
}

const grouped: GroupedDocs = {};
for (const doc of docsWithDates) {
  const date = new Date(doc.data.date!);
  const year = date.getFullYear().toString();
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  
  if (!grouped[year]) grouped[year] = {};
  if (!grouped[year][month]) grouped[year][month] = [];
  grouped[year][month].push(doc);
}

// Get unique categories for filtering
const categories = [...new Set(docsWithDates.flatMap(doc => {
  const cat = doc.data.category;
  return cat ? (Array.isArray(cat) ? cat : [cat]) : [];
}))].sort();

const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
---

<BaseLayout title="时间线" description="按时间顺序浏览所有文章">
  <Navbar currentPath="/timeline/">
    <ThemeToggle slot="theme-toggle" />
  </Navbar>

  <main class="pt-20 px-4 md:px-6 lg:px-8 pb-16">
    <div class="max-w-4xl mx-auto">
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-[var(--color-text)] mb-4">时间线</h1>
        <p class="text-[var(--color-text-muted)]">
          共 {docsWithDates.length} 篇文章
        </p>
      </header>

      <!-- Category filter -->
      {categories.length > 0 && (
        <div class="mb-8 flex flex-wrap gap-2">
          <button
            class="filter-btn px-3 py-1.5 rounded-full text-sm font-medium transition-colors cursor-pointer bg-[var(--color-primary)] text-white"
            data-category="all"
          >
            全部
          </button>
          {categories.map(cat => (
            <button
              class="filter-btn px-3 py-1.5 rounded-full text-sm font-medium transition-colors cursor-pointer bg-[var(--color-bg-secondary)] text-[var(--color-text-muted)] hover:bg-[var(--color-border)]"
              data-category={cat}
            >
              {cat}
            </button>
          ))}
        </div>
      )}

      <!-- Timeline -->
      <div class="space-y-12">
        {Object.entries(grouped)
          .sort(([a], [b]) => parseInt(b) - parseInt(a))
          .map(([year, months]) => (
            <section data-year-section>
              <h2 class="text-2xl font-bold text-[var(--color-text)] mb-6 sticky top-20 bg-[var(--color-bg)] py-2 z-10">
                {year}
              </h2>
              
              <div class="space-y-8">
                {Object.entries(months)
                  .sort(([a], [b]) => parseInt(b) - parseInt(a))
                  .map(([month, docs]) => (
                    <div data-month-section>
                      <h3 class="text-lg font-semibold text-[var(--color-text-muted)] mb-4">
                        {monthNames[parseInt(month) - 1]}
                      </h3>
                      
                      <div class="space-y-4 pl-4 border-l-2 border-[var(--color-border)]">
                        {docs.map(doc => {
                          const categories = doc.data.category 
                            ? (Array.isArray(doc.data.category) ? doc.data.category : [doc.data.category])
                            : [];
                          
                          return (
                            <article 
                              class="timeline-entry relative pl-6"
                              data-categories={categories.join(',')}
                            >
                              <div class="absolute left-0 top-2 w-3 h-3 -translate-x-[7px] rounded-full bg-[var(--color-primary)]"></div>
                              
                              <a 
                                href={`/${doc.id}/`}
                                class="block glass rounded-lg p-4 hover:shadow-lg transition-shadow cursor-pointer"
                              >
                                <div class="flex items-start justify-between gap-4">
                                  <div>
                                    <h4 class="font-medium text-[var(--color-text)] hover:text-[var(--color-primary)] transition-colors">
                                      {doc.data.title || doc.id.split('/').pop()}
                                    </h4>
                                    {doc.data.description && (
                                      <p class="text-sm text-[var(--color-text-muted)] mt-1 line-clamp-2">
                                        {doc.data.description}
                                      </p>
                                    )}
                                  </div>
                                  <time 
                                    datetime={doc.data.date?.toISOString()}
                                    class="text-sm text-[var(--color-text-muted)] whitespace-nowrap"
                                  >
                                    {doc.data.date?.toLocaleDateString('zh-CN')}
                                  </time>
                                </div>
                                
                                {categories.length > 0 && (
                                  <div class="flex flex-wrap gap-1 mt-2">
                                    {categories.map(cat => (
                                      <span class="px-2 py-0.5 text-xs rounded bg-[var(--color-bg-secondary)] text-[var(--color-text-muted)]">
                                        {cat}
                                      </span>
                                    ))}
                                  </div>
                                )}
                              </a>
                            </article>
                          );
                        })}
                      </div>
                    </div>
                  ))}
              </div>
            </section>
          ))}
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  function initTimelineFilter() {
    const buttons = document.querySelectorAll('.filter-btn');
    const entries = document.querySelectorAll('.timeline-entry');
    const monthSections = document.querySelectorAll('[data-month-section]');
    const yearSections = document.querySelectorAll('[data-year-section]');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const category = btn.getAttribute('data-category');
        
        // Update button styles
        buttons.forEach(b => {
          b.classList.remove('bg-[var(--color-primary)]', 'text-white');
          b.classList.add('bg-[var(--color-bg-secondary)]', 'text-[var(--color-text-muted)]');
        });
        btn.classList.remove('bg-[var(--color-bg-secondary)]', 'text-[var(--color-text-muted)]');
        btn.classList.add('bg-[var(--color-primary)]', 'text-white');

        // Filter entries
        entries.forEach(entry => {
          const entryCategories = entry.getAttribute('data-categories')?.split(',') || [];
          const show = category === 'all' || entryCategories.includes(category!);
          (entry as HTMLElement).style.display = show ? '' : 'none';
        });

        // Hide empty month sections
        monthSections.forEach(section => {
          const visibleEntries = section.querySelectorAll('.timeline-entry:not([style*="display: none"])');
          (section as HTMLElement).style.display = visibleEntries.length > 0 ? '' : 'none';
        });

        // Hide empty year sections
        yearSections.forEach(section => {
          const visibleMonths = section.querySelectorAll('[data-month-section]:not([style*="display: none"])');
          (section as HTMLElement).style.display = visibleMonths.length > 0 ? '' : 'none';
        });
      });
    });
  }

  initTimelineFilter();
  document.addEventListener('astro:after-swap', initTimelineFilter);
</script>
