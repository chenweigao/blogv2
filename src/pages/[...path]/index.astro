---
/**
 * Dynamic index page generator for subfolders
 * Modern glassmorphism design
 */
import { getCollection } from 'astro:content';
import DocLayout from '../../layouts/DocLayout.astro';

export async function getStaticPaths() {
  const allDocs = await getCollection('docs');
  const folderPaths = new Set<string>();
  
  for (const doc of allDocs) {
    const parts = doc.id.split('/');
    for (let i = 1; i < parts.length; i++) {
      folderPaths.add(parts.slice(0, i).join('/'));
    }
  }
  
  const pathsWithIndex = new Set(
    allDocs.filter(doc => doc.id.endsWith('/index')).map(doc => doc.id.replace(/\/index$/, ''))
  );
  
  const topLevelCategories = new Set([
    'algorithms', 'computer-systems', 'programming-languages',
    'artificial-intelligence', 'development-tools', 'research-projects',
  ]);
  
  return [...folderPaths]
    .filter(path => {
      if (pathsWithIndex.has(path)) return false;
      if (topLevelCategories.has(path)) return false;
      if (path.includes('/image') || path.includes('/images') || 
          path.includes('/code') || path.includes('/pics') ||
          path.includes('/public') || path.includes('/_optimized') ||
          path.includes('/attachments')) return false;
      return true;
    })
    .map(path => ({ params: { path } }));
}

const { path } = Astro.params;
const pathParts = path?.split('/') || [];
const folderName = pathParts[pathParts.length - 1] || '';
const title = folderName.replace(/[-_]/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
const category = pathParts[0] || '';

const categoryAccent: Record<string, string> = {
  'algorithms': '#3b82f6',
  'computer-systems': '#8b5cf6',
  'programming-languages': '#f59e0b',
  'artificial-intelligence': '#10b981',
  'development-tools': '#ef4444',
  'research-projects': '#6366f1',
};
const accent = categoryAccent[category] || '#6366f1';

const allDocs = await getCollection('docs');
const folderDocs = allDocs.filter(doc => {
  if (!doc.id.startsWith(path + '/')) return false;
  if (doc.id.endsWith('/index')) return false;
  const relativePath = doc.id.slice(path.length + 1);
  return !relativePath.includes('/');
});

const allSubfolders = new Set<string>();
for (const doc of allDocs) {
  if (doc.id.startsWith(path + '/')) {
    const parts = doc.id.slice(path.length + 1).split('/');
    if (parts.length > 1) allSubfolders.add(parts[0]);
  }
}

const displaySubfolders = [...allSubfolders]
  .filter(f => !['image', 'images', 'code', 'pics'].some(x => f.includes(x)))
  .sort((a, b) => a.localeCompare(b, 'zh-CN'));

folderDocs.sort((a, b) => {
  if (a.data.date && b.data.date) return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
  return (a.data.title || a.id).localeCompare(b.data.title || b.id, 'zh-CN');
});

const formatName = (name: string) => name.replace(/[-_]/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
const getDocUrl = (id: string) => `/blogv2/${id.endsWith('/index') ? id.slice(0, -6) : id}/`;
const totalItems = displaySubfolders.length + folderDocs.length;
---

<DocLayout title={title}>
  <div class="space-y-10">
    <!-- Header -->
    <header class="relative overflow-hidden rounded-2xl p-8">
      <div class="absolute inset-0 opacity-20" style={`background: linear-gradient(135deg, ${accent}40, transparent 60%)`}></div>
      <div class="absolute inset-0 bg-[var(--color-bg)]/50 backdrop-blur-sm"></div>
      
      <div class="relative">
        <!-- Breadcrumb -->
        <nav class="mb-5">
          <ol class="flex items-center gap-2 text-sm flex-wrap">
            <li>
              <a href="/blogv2/" class="text-[var(--color-text-muted)] hover:text-[var(--color-text)] transition-colors cursor-pointer">
                首页
              </a>
            </li>
            {pathParts.map((part, i) => (
              <>
                <li class="text-[var(--color-text-muted)]">/</li>
                <li>
                  {i === pathParts.length - 1 ? (
                    <span class="font-medium text-[var(--color-text)]">{formatName(part)}</span>
                  ) : (
                    <a 
                      href={`/blogv2/${pathParts.slice(0, i + 1).join('/')}/`} 
                      class="text-[var(--color-text-muted)] hover:text-[var(--color-text)] transition-colors cursor-pointer"
                    >
                      {formatName(part)}
                    </a>
                  )}
                </li>
              </>
            ))}
          </ol>
        </nav>

        <div class="flex items-center gap-4">
          <div 
            class="w-12 h-12 rounded-xl flex items-center justify-center shrink-0"
            style={`background: ${accent}20; border: 1px solid ${accent}30`}
          >
            <svg class="w-6 h-6" style={`color: ${accent}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
            </svg>
          </div>
          <div>
            <h1 class="text-2xl md:text-3xl font-bold text-[var(--color-text)]">{title}</h1>
            <p class="text-[var(--color-text-muted)] mt-1">
              {displaySubfolders.length > 0 && `${displaySubfolders.length} 个目录`}
              {displaySubfolders.length > 0 && folderDocs.length > 0 && ' · '}
              {folderDocs.length > 0 && `${folderDocs.length} 篇文章`}
              {totalItems === 0 && '暂无内容'}
            </p>
          </div>
        </div>
      </div>
    </header>

    <!-- Subfolders -->
    {displaySubfolders.length > 0 && (
      <section class="space-y-4">
        <h2 class="text-lg font-semibold text-[var(--color-text)] flex items-center gap-2">
          <span class="w-1 h-5 rounded-full" style={`background: ${accent}`}></span>
          目录
        </h2>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          {displaySubfolders.map((subfolder) => (
            <a 
              href={`/blogv2/${path}/${subfolder}/`}
              class="group flex items-center gap-3 p-4 rounded-xl
                     bg-[var(--color-bg)] hover:bg-[var(--color-bg-secondary)]/50
                     border border-[var(--color-border)]/50 hover:border-[var(--color-border)]
                     shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer"
            >
              <div 
                class="w-10 h-10 rounded-lg flex items-center justify-center shrink-0
                       group-hover:scale-105 transition-transform duration-200"
                style={`background: ${accent}15`}
              >
                <svg class="w-5 h-5" style={`color: ${accent}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                </svg>
              </div>
              <span class="font-medium text-[var(--color-text)] truncate">{formatName(subfolder)}</span>
              <svg class="w-4 h-4 text-[var(--color-text-muted)] ml-auto shrink-0 group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- Articles -->
    {folderDocs.length > 0 && (
      <section class="space-y-4">
        <h2 class="text-lg font-semibold text-[var(--color-text)] flex items-center gap-2">
          <span class="w-1 h-5 rounded-full bg-[var(--color-text-muted)]/30"></span>
          文章
        </h2>
        
        <div class="space-y-2">
          {folderDocs.map((doc, i) => (
            <a 
              href={getDocUrl(doc.id)}
              class="group flex items-center gap-4 p-4 rounded-xl
                     hover:bg-[var(--color-bg-secondary)]/50
                     border border-transparent hover:border-[var(--color-border)]/50
                     transition-all duration-200 cursor-pointer"
            >
              <div class="w-8 h-8 rounded-lg flex items-center justify-center text-xs font-mono
                          bg-[var(--color-bg-secondary)] text-[var(--color-text-muted)]
                          group-hover:text-[var(--color-primary)] transition-colors shrink-0">
                {String(i + 1).padStart(2, '0')}
              </div>
              
              <div class="flex-1 min-w-0">
                <h3 class="font-medium text-[var(--color-text)] group-hover:text-[var(--color-primary)] transition-colors truncate">
                  {doc.data.title || doc.id.split('/').pop()?.replace(/-/g, ' ')}
                </h3>
                {doc.data.description && (
                  <p class="text-sm text-[var(--color-text-muted)] mt-0.5 truncate opacity-70">
                    {doc.data.description}
                  </p>
                )}
              </div>
              
              {doc.data.date && (
                <time class="text-xs text-[var(--color-text-muted)] hidden sm:block font-mono shrink-0">
                  {doc.data.date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })}
                </time>
              )}
              
              <div class="w-6 h-6 rounded-full flex items-center justify-center
                          bg-[var(--color-bg-secondary)] group-hover:bg-[var(--color-primary)]
                          transition-all duration-200 shrink-0">
                <svg class="w-3 h-3 text-[var(--color-text-muted)] group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- Empty State -->
    {totalItems === 0 && (
      <div class="flex flex-col items-center justify-center py-16 text-center">
        <div class="w-16 h-16 rounded-2xl flex items-center justify-center mb-4" style={`background: ${accent}15`}>
          <svg class="w-8 h-8" style={`color: ${accent}80`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
          </svg>
        </div>
        <p class="text-[var(--color-text-muted)]">暂无内容</p>
        <p class="text-sm text-[var(--color-text-muted)] mt-1 opacity-60">此目录下还没有文档</p>
      </div>
    )}
  </div>
</DocLayout>

<style>
  @media (prefers-reduced-motion: reduce) {
    a {
      transition: none !important;
    }
  }
</style>
