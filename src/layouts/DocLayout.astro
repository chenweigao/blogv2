---
import BaseLayout from './BaseLayout.astro';
import Navbar from '../components/layout/Navbar.astro';
import Sidebar from '../components/layout/Sidebar.astro';
import MobileMenu from '../components/layout/MobileMenu.astro';
import ThemeToggle from '../components/ui/ThemeToggle.astro';
import ArticleMeta from '../components/content/ArticleMeta.astro';
import { getCollection } from 'astro:content';
import { buildSidebar } from '../lib/sidebar';

interface Props {
  title: string;
  description?: string;
  date?: Date;
  category?: string | string[];
  tags?: string[];
  lastUpdated?: Date;
  filePath?: string;
}

const { 
  title, 
  description,
  date,
  category,
  tags = [],
  lastUpdated,
  filePath
} = Astro.props;

const currentPath = Astro.url.pathname;

// Get all docs for sidebar
const allDocs = await getCollection('docs');
const sidebarSections = buildSidebar(allDocs);

// Get current section's items
const currentSection = currentPath.split('/')[2]; // /blogv2/section/...
const currentSectionItems = sidebarSections.find(s => 
  s.title.toLowerCase().replace(/\s+/g, '-') === currentSection
)?.items || [];
---

<BaseLayout title={title} description={description}>
  <Navbar currentPath={currentPath}>
    <ThemeToggle slot="theme-toggle" />
  </Navbar>
  
  <MobileMenu items={currentSectionItems} currentPath={currentPath} />

  <div class="pt-20 px-4 md:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto flex gap-8">
      <!-- Sidebar -->
      <Sidebar items={currentSectionItems} currentPath={currentPath} />

      <!-- Main content -->
      <main id="main-content" class="flex-1 min-w-0">
        <article class="glass rounded-2xl p-6 md:p-8">
          <!-- Article header -->
          <header class="mb-8 pb-6 border-b border-[var(--color-border)]">
            <h1 class="text-3xl md:text-4xl font-bold text-[var(--color-text)] mb-4">
              {title}
            </h1>
            
            <ArticleMeta 
              date={date}
              category={category}
              tags={tags}
              lastUpdated={lastUpdated}
            />
          </header>

          <!-- Article content -->
          <div class="prose prose-slate dark:prose-invert max-w-none">
            <slot />
          </div>

          <!-- Article footer -->
          <footer class="mt-12 pt-6 border-t border-[var(--color-border)]">
            <div class="flex flex-wrap items-center justify-between gap-4 text-sm text-[var(--color-text-muted)]">
              {lastUpdated && (
                <span>
                  最后更新: {lastUpdated.toLocaleDateString('zh-CN')}
                </span>
              )}
              
              {filePath && (
                <a
                  href={`https://github.com/username/repo/edit/main/${filePath}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-1 hover:text-[var(--color-primary)] transition-colors cursor-pointer"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  在 GitHub 上编辑
                </a>
              )}
            </div>
          </footer>
        </article>
      </main>
    </div>
  </div>
</BaseLayout>

<style is:global>
  @reference "tailwindcss";
  
  /* Prose styling for markdown content */
  .prose {
    --tw-prose-body: var(--color-text);
    --tw-prose-headings: var(--color-text);
    --tw-prose-links: var(--color-primary);
    --tw-prose-code: var(--color-text);
    --tw-prose-pre-bg: var(--color-bg-secondary);
  }

  .prose h2 {
    @apply text-2xl font-bold mt-8 mb-4 pb-2 border-b border-[var(--color-border)];
  }

  .prose h3 {
    @apply text-xl font-semibold mt-6 mb-3;
  }

  .prose p {
    @apply my-4 leading-relaxed;
  }

  .prose a {
    @apply text-[var(--color-primary)] hover:underline;
  }

  .prose code:not(pre code) {
    @apply px-1.5 py-0.5 rounded bg-[var(--color-bg-secondary)] text-sm font-mono;
  }

  .prose pre {
    @apply rounded-lg p-4 overflow-x-auto my-4;
  }

  .prose ul, .prose ol {
    @apply my-4 pl-6;
  }

  .prose li {
    @apply my-1;
  }

  .prose blockquote {
    @apply border-l-4 border-[var(--color-primary)] pl-4 my-4 italic text-[var(--color-text-muted)];
  }

  .prose img {
    @apply rounded-lg my-4;
  }

  .prose table {
    @apply w-full my-4 border-collapse;
  }

  .prose th, .prose td {
    @apply border border-[var(--color-border)] px-3 py-2 text-left;
  }

  .prose th {
    @apply bg-[var(--color-bg-secondary)] font-semibold;
  }

  /* Mermaid diagram styling */
  .mermaid-wrapper {
    @apply my-6 rounded-lg overflow-hidden bg-[var(--color-bg-secondary)] p-4;
  }
  
  .mermaid-wrapper svg {
    @apply max-w-full h-auto mx-auto;
  }
</style>

<script>
  async function initMermaidDiagrams() {
    // Find all mermaid code blocks (Shiki uses data-language attribute)
    const mermaidBlocks = document.querySelectorAll('pre[data-language="mermaid"]');
    if (mermaidBlocks.length === 0) return;

    // Dynamically import mermaid
    const { default: mermaid } = await import('mermaid');
    
    // Initialize mermaid with theme based on current mode
    const isDark = document.documentElement.classList.contains('dark');
    mermaid.initialize({
      startOnLoad: false,
      theme: isDark ? 'dark' : 'default',
      securityLevel: 'loose',
    });

    // Process each mermaid block
    for (let i = 0; i < mermaidBlocks.length; i++) {
      const pre = mermaidBlocks[i] as HTMLPreElement;
      const codeElement = pre.querySelector('code');
      if (!codeElement) continue;

      // Extract text content from all spans
      const code = codeElement.textContent || '';
      const id = `mermaid-diagram-${i}`;

      try {
        const { svg } = await mermaid.render(id, code);
        
        // Create wrapper and replace pre element
        const wrapper = document.createElement('div');
        wrapper.className = 'mermaid-wrapper cursor-pointer';
        wrapper.innerHTML = svg;
        wrapper.title = '点击放大';
        
        // Add click handler for zoom
        wrapper.addEventListener('click', () => openMermaidModal(svg));
        
        pre.replaceWith(wrapper);
      } catch (err) {
        console.error('Mermaid render error:', err);
        // Keep original code block on error
      }
    }
  }

  function openMermaidModal(svg: string) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4';
    modal.innerHTML = `
      <div class="relative max-w-[90vw] max-h-[90vh] overflow-auto bg-white dark:bg-slate-800 rounded-lg p-6">
        <button class="absolute top-3 right-3 p-2 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:bg-slate-700 transition-colors cursor-pointer">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <div class="mermaid-modal-content pt-4">${svg}</div>
      </div>
    `;

    const closeModal = () => modal.remove();
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    modal.querySelector('button')?.addEventListener('click', closeModal);
    
    const escHandler = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        closeModal();
        document.removeEventListener('keydown', escHandler);
      }
    };
    document.addEventListener('keydown', escHandler);

    document.body.appendChild(modal);
  }

  // Initialize on load and after navigation
  initMermaidDiagrams();
  document.addEventListener('astro:after-swap', initMermaidDiagrams);
  
  // Re-render on theme change
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class') {
        // Small delay to let theme change complete
        setTimeout(initMermaidDiagrams, 100);
      }
    });
  });
  observer.observe(document.documentElement, { attributes: true });
</script>
