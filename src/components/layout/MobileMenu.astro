---
import { type SidebarItem } from '../../lib/sidebar';

interface Props {
  items: SidebarItem[];
  currentPath: string;
}

const { items, currentPath } = Astro.props;

const navLinks = [
  { href: '/', label: '首页', exact: true },
  { href: '/ai-systems/', label: 'AI 系统' },
  { href: '/architecture/', label: '计算机架构' },
  { href: '/fundamentals/', label: '编程基础' },
  { href: '/toolbox/', label: '工具箱' },
];

function isActive(link: { href: string; exact?: boolean }) {
  if (link.exact) return currentPath === link.href;
  return currentPath.startsWith(link.href);
}
---

<!-- Mobile menu overlay -->
<div 
  id="mobile-menu-overlay"
  class="mobile-overlay fixed inset-0 z-40 hidden lg:hidden"
  aria-hidden="true"
></div>

<!-- Mobile menu panel -->
<div 
  id="mobile-menu-panel"
  class="mobile-panel fixed top-0 right-0 bottom-0 w-80 max-w-[85vw] z-50 transform translate-x-full lg:hidden overflow-y-auto"
  role="dialog"
  aria-modal="true"
  aria-label="移动端菜单"
>
  <div class="p-4">
    <!-- Close button -->
    <div class="flex justify-end mb-4">
      <button
        id="mobile-menu-close"
        class="mobile-close-btn"
        aria-label="关闭菜单"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Main navigation -->
    <nav class="mb-6">
      <h2 class="mobile-section-title">导航</h2>
      <ul class="space-y-1">
        {navLinks.map((link) => (
          <li>
            <a
              href={link.href}
              class:list={[
                'mobile-nav-link',
                isActive(link) && 'is-active'
              ]}
            >
              {link.label}
            </a>
          </li>
        ))}
      </ul>
    </nav>

    <!-- Sidebar items -->
    {items.length > 0 && (
      <nav>
        <h2 class="mobile-section-title">当前章节</h2>
        <ul class="space-y-1">
          {items.slice(0, 10).map((item) => (
            <li>
              <a
                href={item.href}
                class="mobile-nav-link"
              >
                {item.title}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    )}
  </div>
</div>

<style>
  /* Mobile Menu - Apple/Linear Style */
  
  .mobile-overlay {
    background-color: rgba(0, 0, 0, 0.4);
    opacity: 0;
    transition: opacity 300ms ease;
    -webkit-backdrop-filter: blur(4px);
    backdrop-filter: blur(4px);
  }
  
  .mobile-overlay.is-open {
    opacity: 1;
  }
  
  .mobile-panel {
    background-color: #FBFBFD;
    transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: -8px 0 32px rgba(0, 0, 0, 0.12);
  }
  
  :global(.dark) .mobile-panel {
    background-color: #0A0A0B;
    box-shadow: -8px 0 32px rgba(0, 0, 0, 0.5);
  }
  
  .mobile-panel.is-open {
    transform: translateX(0);
  }
  
  .mobile-close-btn {
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 200ms ease, color 200ms ease;
    color: rgba(29, 29, 31, 0.55);
  }
  
  .mobile-close-btn:hover {
    background-color: rgba(0, 0, 0, 0.04);
    color: #1D1D1F;
  }
  
  :global(.dark) .mobile-close-btn {
    color: rgba(245, 245, 247, 0.55);
  }
  
  :global(.dark) .mobile-close-btn:hover {
    background-color: rgba(255, 255, 255, 0.06);
    color: #F5F5F7;
  }
  
  .mobile-section-title {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 8px;
    padding: 0 12px;
    color: rgba(29, 29, 31, 0.45);
  }
  
  :global(.dark) .mobile-section-title {
    color: rgba(245, 245, 247, 0.45);
  }
  
  .mobile-nav-link {
    display: block;
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 400;
    cursor: pointer;
    transition: background-color 200ms ease, color 200ms ease;
    color: rgba(29, 29, 31, 0.7);
    -webkit-tap-highlight-color: transparent;
  }
  
  .mobile-nav-link:hover {
    background-color: rgba(0, 0, 0, 0.04);
    color: #1D1D1F;
  }
  
  .mobile-nav-link.is-active {
    background-color: rgba(0, 0, 0, 0.06);
    color: #1D1D1F;
    font-weight: 500;
  }
  
  :global(.dark) .mobile-nav-link {
    color: rgba(245, 245, 247, 0.7);
  }
  
  :global(.dark) .mobile-nav-link:hover {
    background-color: rgba(255, 255, 255, 0.06);
    color: #F5F5F7;
  }
  
  :global(.dark) .mobile-nav-link.is-active {
    background-color: rgba(255, 255, 255, 0.1);
    color: #F5F5F7;
  }
  
  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .mobile-overlay,
    .mobile-panel,
    .mobile-close-btn,
    .mobile-nav-link {
      transition: none !important;
    }
  }
</style>

<script>
  function initMobileMenu() {
    const trigger = document.getElementById('mobile-menu-trigger');
    const overlay = document.getElementById('mobile-menu-overlay');
    const panel = document.getElementById('mobile-menu-panel');
    const close = document.getElementById('mobile-menu-close');

    if (!trigger || !overlay || !panel) {
      return;
    }

    // Remove existing listeners by cloning
    const newTrigger = trigger.cloneNode(true) as HTMLElement;
    trigger.parentNode?.replaceChild(newTrigger, trigger);

    function openMenu() {
      overlay.classList.remove('hidden');
      // Use requestAnimationFrame for smooth animation
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          overlay.classList.add('is-open');
          panel.classList.add('is-open');
        });
      });
      newTrigger.setAttribute('aria-expanded', 'true');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      overlay.classList.remove('is-open');
      panel.classList.remove('is-open');
      newTrigger.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
      
      // Wait for animation to complete
      setTimeout(() => {
        if (!overlay.classList.contains('is-open')) {
          overlay.classList.add('hidden');
        }
      }, 300);
    }

    newTrigger.addEventListener('click', (e) => {
      e.preventDefault();
      openMenu();
    });
    
    overlay.addEventListener('click', closeMenu);
    close?.addEventListener('click', closeMenu);

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !overlay.classList.contains('hidden')) {
        closeMenu();
      }
    });

    // Close on navigation
    panel.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', closeMenu);
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMobileMenu);
  } else {
    initMobileMenu();
  }
  document.addEventListener('astro:after-swap', initMobileMenu);
</script>
