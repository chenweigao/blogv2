---
import { type SidebarItem } from '../../lib/sidebar';

interface Props {
  items: SidebarItem[];
  currentPath: string;
}

const { items, currentPath } = Astro.props;

const navLinks = [
  { href: '/', label: '首页' },
  { href: '/ai-systems/', label: 'AI 系统' },
  { href: '/architecture/', label: '计算机架构' },
  { href: '/fundamentals/', label: '编程基础' },
  { href: '/toolbox/', label: '工具箱' },
];
---

<!-- Mobile menu overlay -->
<div 
  id="mobile-menu-overlay"
  class="fixed inset-0 bg-black/50 z-40 hidden opacity-0 transition-opacity duration-300 lg:hidden"
  aria-hidden="true"
></div>

<!-- Mobile menu panel -->
<div 
  id="mobile-menu-panel"
  class="fixed top-0 right-0 bottom-0 w-80 max-w-[85vw] bg-[var(--color-bg)] z-50 transform translate-x-full transition-transform duration-300 lg:hidden overflow-y-auto"
  role="dialog"
  aria-modal="true"
  aria-label="移动端菜单"
>
  <div class="p-4">
    <!-- Close button -->
    <div class="flex justify-end mb-4">
      <button
        id="mobile-menu-close"
        class="p-2 rounded-lg text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-bg-secondary)] transition-colors cursor-pointer"
        aria-label="关闭菜单"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Main navigation -->
    <nav class="mb-6">
      <h2 class="text-xs font-semibold text-[var(--color-text-muted)] uppercase tracking-wider mb-2 px-3">
        导航
      </h2>
      <ul class="space-y-1">
        {navLinks.map((link) => (
          <li>
            <a
              href={link.href}
              class:list={[
                'block px-3 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer',
                currentPath.startsWith(link.href) && link.href !== '/'
                  ? 'bg-[var(--color-primary)]/10 text-[var(--color-primary)]'
                  : 'text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-bg-secondary)]'
              ]}
            >
              {link.label}
            </a>
          </li>
        ))}
      </ul>
    </nav>

    <!-- Sidebar items -->
    {items.length > 0 && (
      <nav>
        <h2 class="text-xs font-semibold text-[var(--color-text-muted)] uppercase tracking-wider mb-2 px-3">
          当前章节
        </h2>
        <ul class="space-y-1">
          {items.slice(0, 10).map((item) => (
            <li>
              <a
                href={item.href}
                class="block px-3 py-2 rounded-lg text-sm text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-bg-secondary)] transition-colors cursor-pointer"
              >
                {item.title}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    )}
  </div>
</div>

<script>
  function initMobileMenu() {
    const trigger = document.getElementById('mobile-menu-trigger');
    const overlay = document.getElementById('mobile-menu-overlay');
    const panel = document.getElementById('mobile-menu-panel');
    const close = document.getElementById('mobile-menu-close');

    if (!trigger || !overlay || !panel) {
      console.warn('Mobile menu elements not found');
      return;
    }

    // Remove existing listeners by cloning
    const newTrigger = trigger.cloneNode(true);
    trigger.parentNode?.replaceChild(newTrigger, trigger);

    function openMenu() {
      overlay.classList.remove('hidden');
      requestAnimationFrame(() => {
        overlay.classList.remove('opacity-0');
        panel.classList.remove('translate-x-full');
      });
      newTrigger.setAttribute('aria-expanded', 'true');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      overlay.classList.add('opacity-0');
      panel.classList.add('translate-x-full');
      newTrigger.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
      
      setTimeout(() => {
        overlay.classList.add('hidden');
      }, 300);
    }

    newTrigger.addEventListener('click', openMenu);
    newTrigger.addEventListener('touchend', (e) => {
      e.preventDefault();
      openMenu();
    });
    
    overlay.addEventListener('click', closeMenu);
    close?.addEventListener('click', closeMenu);

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !overlay.classList.contains('hidden')) {
        closeMenu();
      }
    });

    // Close on navigation
    panel.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', closeMenu);
    });
  }

  initMobileMenu();
  document.addEventListener('astro:after-swap', initMobileMenu);
  document.addEventListener('DOMContentLoaded', initMobileMenu);
</script>
