---
import { isActive, isExactActive, type SidebarItem } from '../../lib/sidebar';

interface Props {
  items: SidebarItem[];
  currentPath: string;
}

const { items, currentPath } = Astro.props;

// Recursive component for nested items
function renderItem(item: SidebarItem, currentPath: string, depth: number = 0): string {
  const hasChildren = item.children && item.children.length > 0;
  const isItemActive = isActive(item.href, currentPath);
  const isItemExact = isExactActive(item.href, currentPath);
  
  if (hasChildren) {
    return `
      <li>
        <details class="group" ${isItemActive ? 'open' : ''}>
          <summary class="flex items-center justify-between px-3 py-2 rounded-lg cursor-pointer text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-bg-secondary)] transition-colors">
            <a href="${item.href}" class="flex-1 text-sm font-medium ${isItemExact ? 'text-[var(--color-primary)]' : ''}">${item.title}</a>
            <svg class="w-4 h-4 transition-transform duration-200 group-open:rotate-90 shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </summary>
          <ul class="mt-1 ml-3 pl-3 border-l border-[var(--color-border)] space-y-1">
            ${item.children!.map(child => renderItem(child, currentPath, depth + 1)).join('')}
          </ul>
        </details>
      </li>
    `;
  } else {
    return `
      <li>
        <a
          href="${item.href}"
          class="block px-3 py-1.5 rounded-lg text-sm transition-colors cursor-pointer ${
            isItemExact
              ? 'bg-[var(--color-primary)]/10 text-[var(--color-primary)] font-medium'
              : 'text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-bg-secondary)]'
          }"
          ${isItemExact ? 'aria-current="page"' : ''}
        >
          ${item.title}
        </a>
      </li>
    `;
  }
}
---

<aside class="w-64 shrink-0 hidden lg:block">
  <nav 
    class="glass rounded-2xl p-4 sticky top-20 max-h-[calc(100vh-6rem)] overflow-y-auto"
    aria-label="侧边栏导航"
    style="--glass-blur: 12px;"
  >
    <ul class="space-y-1">
      {items.map((item) => (
        <Fragment set:html={renderItem(item, currentPath, 0)} />
      ))}
    </ul>
    
    {items.length === 0 && (
      <p class="text-sm text-[var(--color-text-muted)] text-center py-4">
        暂无内容
      </p>
    )}
  </nav>
</aside>

<script>
  function initSidebarState() {
    const details = document.querySelectorAll('aside nav details');
    const storageKey = 'sidebar-collapse-state';
    
    // Load saved state
    try {
      const saved = JSON.parse(localStorage.getItem(storageKey) || '{}');
      details.forEach((detail, index) => {
        const key = detail.querySelector('summary a')?.getAttribute('href') || index.toString();
        if (saved[key] !== undefined) {
          (detail as HTMLDetailsElement).open = saved[key];
        }
      });
    } catch {}
    
    // Save state on toggle
    details.forEach((detail) => {
      detail.addEventListener('toggle', () => {
        try {
          const saved = JSON.parse(localStorage.getItem(storageKey) || '{}');
          const key = detail.querySelector('summary a')?.getAttribute('href') || '';
          saved[key] = (detail as HTMLDetailsElement).open;
          localStorage.setItem(storageKey, JSON.stringify(saved));
        } catch {}
      });
    });
    
    // Prevent link click from toggling details
    document.querySelectorAll('aside nav summary a').forEach(link => {
      link.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    });
  }
  
  initSidebarState();
  document.addEventListener('astro:after-swap', initSidebarState);
</script>
