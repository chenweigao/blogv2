---
interface Props {
  code: string;
  id?: string;
}

const { code, id = `mermaid-${Math.random().toString(36).slice(2, 9)}` } = Astro.props;
---

<div class="mermaid-container my-6">
  <div 
    class="mermaid-diagram rounded-xl overflow-hidden relative cursor-pointer transition-all duration-200 hover:shadow-lg"
    style="background: linear-gradient(135deg, var(--color-bg-secondary) 0%, var(--color-bg) 100%); border: 1px solid var(--color-border);"
    data-mermaid-code={code}
    data-mermaid-id={id}
  >
    <!-- Placeholder while loading -->
    <div class="mermaid-loading flex items-center justify-center py-12 text-[var(--color-text-muted)]">
      <div class="w-6 h-6 rounded-full border-2 border-[var(--color-border)] border-t-[var(--color-primary)] animate-spin mr-3"></div>
      加载图表中...
    </div>
    
    <!-- Rendered diagram will be inserted here -->
    <div class="mermaid-output hidden p-6"></div>
    
    <!-- Zoom hint -->
    <div class="mermaid-hint absolute bottom-2 right-3 text-xs text-[var(--color-text-muted)] opacity-0 transition-opacity duration-200 px-2 py-1 rounded-md pointer-events-none" style="background: var(--color-bg);">
      点击放大
    </div>
    
    <!-- Error display -->
    <div class="mermaid-error hidden p-6">
      <div class="text-red-500 text-sm mb-2 font-medium">图表渲染失败</div>
      <pre class="text-xs p-3 rounded-lg overflow-x-auto font-mono" style="background: var(--color-bg); color: var(--color-text-muted);"><code>{code}</code></pre>
    </div>
  </div>
</div>

<style>
  .mermaid-diagram:hover .mermaid-hint {
    opacity: 1;
  }
  
  .mermaid-output :global(svg) {
    max-width: 100%;
    height: auto;
    margin: 0 auto;
    display: block;
  }
</style>

<script>
  // Apple/Linear-inspired theme configuration for dark/light modes
  const mermaidThemes = {
    light: {
      theme: 'base',
      themeVariables: {
        primaryColor: '#F5F5F7',
        primaryTextColor: '#1D1D1F',
        primaryBorderColor: '#D2D2D7',
        secondaryColor: '#FBFBFD',
        secondaryTextColor: '#1D1D1F',
        secondaryBorderColor: '#D2D2D7',
        tertiaryColor: '#F5F5F7',
        tertiaryTextColor: '#1D1D1F',
        tertiaryBorderColor: '#D2D2D7',
        lineColor: '#86868B',
        textColor: '#1D1D1F',
        mainBkg: '#FFFFFF',
        nodeBkg: '#F5F5F7',
        nodeBorder: '#D2D2D7',
        clusterBkg: '#FBFBFD',
        clusterBorder: '#D2D2D7',
        actorBkg: '#F5F5F7',
        actorBorder: '#D2D2D7',
        actorTextColor: '#1D1D1F',
        actorLineColor: '#86868B',
        signalColor: '#1D1D1F',
        signalTextColor: '#1D1D1F',
        labelBoxBkgColor: '#F5F5F7',
        labelBoxBorderColor: '#D2D2D7',
        labelTextColor: '#1D1D1F',
        loopTextColor: '#1D1D1F',
        noteBkgColor: '#FFF9E6',
        noteBorderColor: '#E6D9A6',
        noteTextColor: '#1D1D1F',
        labelColor: '#1D1D1F',
        classText: '#1D1D1F',
        fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif',
        fontSize: '14px',
      },
    },
    dark: {
      theme: 'base',
      themeVariables: {
        primaryColor: '#2C2C2E',
        primaryTextColor: '#F5F5F7',
        primaryBorderColor: '#3A3A3C',
        secondaryColor: '#1C1C1E',
        secondaryTextColor: '#F5F5F7',
        secondaryBorderColor: '#3A3A3C',
        tertiaryColor: '#2C2C2E',
        tertiaryTextColor: '#F5F5F7',
        tertiaryBorderColor: '#3A3A3C',
        lineColor: '#8E8E93',
        textColor: '#F5F5F7',
        mainBkg: '#1C1C1E',
        nodeBkg: '#2C2C2E',
        nodeBorder: '#3A3A3C',
        clusterBkg: '#1C1C1E',
        clusterBorder: '#3A3A3C',
        actorBkg: '#2C2C2E',
        actorBorder: '#3A3A3C',
        actorTextColor: '#F5F5F7',
        actorLineColor: '#8E8E93',
        signalColor: '#F5F5F7',
        signalTextColor: '#F5F5F7',
        labelBoxBkgColor: '#2C2C2E',
        labelBoxBorderColor: '#3A3A3C',
        labelTextColor: '#F5F5F7',
        loopTextColor: '#F5F5F7',
        noteBkgColor: '#3A3A3C',
        noteBorderColor: '#48484A',
        noteTextColor: '#F5F5F7',
        labelColor: '#F5F5F7',
        classText: '#F5F5F7',
        fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif',
        fontSize: '14px',
      },
    },
  };

  // Track current theme to detect changes
  let currentTheme: 'light' | 'dark' | null = null;
  // Counter for unique IDs on re-render
  let renderCounter = 0;

  async function initMermaid(forceRerender = false) {
    const containers = document.querySelectorAll('.mermaid-diagram');
    if (containers.length === 0) return;

    const isDark = document.documentElement.classList.contains('dark');
    const newTheme = isDark ? 'dark' : 'light';
    
    // Skip if theme hasn't changed and not forcing re-render
    if (!forceRerender && currentTheme === newTheme) return;
    currentTheme = newTheme;

    const { default: mermaid } = await import('mermaid');
    const themeConfig = mermaidThemes[newTheme];
    
    mermaid.initialize({
      startOnLoad: false,
      securityLevel: 'loose',
      ...themeConfig,
    });

    for (const container of containers) {
      const code = container.getAttribute('data-mermaid-code');
      const baseId = container.getAttribute('data-mermaid-id');
      const loading = container.querySelector('.mermaid-loading') as HTMLElement;
      const output = container.querySelector('.mermaid-output') as HTMLElement;
      const error = container.querySelector('.mermaid-error') as HTMLElement;

      if (!code || !baseId || !output || !error || !loading) continue;

      // Generate unique ID for each render to avoid mermaid ID conflicts
      const uniqueId = `${baseId}-${newTheme}-${++renderCounter}`;

      // Show loading state on theme change
      loading.classList.remove('hidden');
      output.classList.add('hidden');
      error.classList.add('hidden');

      try {
        const { svg } = await mermaid.render(uniqueId, code);
        output.innerHTML = svg;
        loading.classList.add('hidden');
        output.classList.remove('hidden');
        
        // Remove old click handlers and add new one
        const newContainer = container.cloneNode(true) as HTMLElement;
        container.parentNode?.replaceChild(newContainer, container);
        
        // Re-query elements after clone
        const newOutput = newContainer.querySelector('.mermaid-output') as HTMLElement;
        newOutput.innerHTML = svg;
        newOutput.classList.remove('hidden');
        (newContainer.querySelector('.mermaid-loading') as HTMLElement)?.classList.add('hidden');
        
        newContainer.addEventListener('click', () => {
          openMermaidModal(svg);
        });
      } catch (err) {
        console.error('Mermaid render error:', err);
        loading.classList.add('hidden');
        error.classList.remove('hidden');
      }
    }
  }

  function openMermaidModal(svg: string) {
    // Create a temporary container to measure SVG dimensions
    const container = document.createElement('div');
    container.style.cssText = 'position: absolute; visibility: hidden; pointer-events: none;';
    container.innerHTML = svg;
    document.body.appendChild(container);
    
    const svgEl = container.querySelector('svg');
    const width = svgEl?.getAttribute('width') || svgEl?.viewBox?.baseVal?.width || 800;
    const height = svgEl?.getAttribute('height') || svgEl?.viewBox?.baseVal?.height || 600;
    container.remove();

    // Convert SVG to data URL for PhotoSwipe
    const svgBlob = new Blob([svg], { type: 'image/svg+xml' });
    const svgUrl = URL.createObjectURL(svgBlob);

    // Import and use PhotoSwipe
    Promise.all([
      import('photoswipe/lightbox'),
      import('photoswipe'),
    ]).then(([{ default: PhotoSwipeLightbox }, pswpModule]) => {
      const lightbox = new PhotoSwipeLightbox({
        dataSource: [{
          src: svgUrl,
          width: Number(width) * 2,
          height: Number(height) * 2,
        }],
        showHideAnimationType: 'fade',
        pswpModule: () => pswpModule,
        bgOpacity: 0.92,
        padding: { top: 20, bottom: 20, left: 20, right: 20 },
        wheelToZoom: true,
        pinchToClose: true,
        closeOnVerticalDrag: true,
      });

      lightbox.on('destroy', () => {
        URL.revokeObjectURL(svgUrl);
      });

      lightbox.init();
      lightbox.loadAndOpen(0);
    });
  }

  // Initialize on load
  initMermaid(true);
  
  // Re-init after Astro navigation
  document.addEventListener('astro:after-swap', () => {
    currentTheme = null;
    initMermaid(true);
  });
  
  // Re-render on theme change with debounce
  let themeChangeTimeout: number;
  const observer = new MutationObserver((mutations) => {
    for (const mutation of mutations) {
      if (mutation.attributeName === 'class') {
        clearTimeout(themeChangeTimeout);
        themeChangeTimeout = window.setTimeout(() => {
          initMermaid(true);
        }, 50);
        break;
      }
    }
  });
  observer.observe(document.documentElement, { attributes: true });
</script>
