---
/**
 * Image Lightbox Component
 * Uses PhotoSwipe for full-featured lightbox with gestures
 */
---

<style is:global>
  /* Article images - responsive with max-width constraint */
  .prose img {
    cursor: zoom-in;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1.5rem auto;
    display: block;
  }

  /* Don't force small images to be full width */
  .prose img:not([width]) {
    width: auto;
    max-width: min(100%, 720px);
  }

  /* Images with explicit width should respect it */
  .prose img[width] {
    width: auto;
    max-width: 100%;
  }

  .prose img:hover {
    transform: scale(1.01);
    box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.2);
  }

  /* Image captions */
  .prose figure {
    margin: 1.5rem 0;
    text-align: center;
  }

  .prose figcaption {
    margin-top: 0.75rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  @media (prefers-reduced-motion: reduce) {
    .prose img {
      transition: none;
    }
  }
</style>

<script>
  import PhotoSwipe from 'photoswipe';
  import 'photoswipe/style.css';

  function initPhotoSwipe() {
    const images = Array.from(document.querySelectorAll('.prose img')) as HTMLImageElement[];
    if (images.length === 0) return;

    // Build gallery data from all images
    const galleryItems = images.map((img) => ({
      src: img.dataset.src || img.src,
      width: img.naturalWidth || 1200,
      height: img.naturalHeight || 800,
      alt: img.alt || '',
      element: img,
    }));

    images.forEach((img, index) => {
      // Skip if already initialized
      if (img.dataset.pswpInit) return;
      img.dataset.pswpInit = 'true';

      img.addEventListener('click', (e) => {
        e.preventDefault();

        const pswp = new PhotoSwipe({
          dataSource: galleryItems.map(item => ({
            src: item.src,
            width: item.width,
            height: item.height,
            alt: item.alt,
          })),
          index: index, // Start from clicked image
          showHideAnimationType: 'zoom',
          bgOpacity: 0.92,
          padding: { top: 20, bottom: 20, left: 20, right: 20 },
          wheelToZoom: true,
          pinchToClose: true,
          closeOnVerticalDrag: true,
          // Zoom animation from/to clicked image
          getThumbBoundsFn: (idx) => {
            const targetImg = galleryItems[idx]?.element;
            if (targetImg) {
              const rect = targetImg.getBoundingClientRect();
              return { x: rect.left, y: rect.top, w: rect.width };
            }
            return { x: 0, y: 0, w: 0 };
          },
        });

        pswp.init();
      });
    });
  }

  // Initialize after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPhotoSwipe);
  } else {
    initPhotoSwipe();
  }
  
  document.addEventListener('astro:after-swap', initPhotoSwipe);
</script>
