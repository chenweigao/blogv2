---
/**
 * Image Lightbox Component
 * Uses PhotoSwipe for full-featured lightbox with gestures
 */
---

<style is:global>
  /* Make article images zoomable */
  .prose img {
    cursor: zoom-in;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .prose img:hover {
    transform: scale(1.01);
    box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.2);
  }

  @media (prefers-reduced-motion: reduce) {
    .prose img {
      transition: none;
    }
  }
</style>

<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox';
  import 'photoswipe/style.css';

  let lightbox: PhotoSwipeLightbox | null = null;

  function initPhotoSwipe() {
    // Cleanup existing instance
    if (lightbox) {
      lightbox.destroy();
      lightbox = null;
    }

    // Get all images in prose content
    const images = document.querySelectorAll('.prose img') as NodeListOf<HTMLImageElement>;
    if (images.length === 0) return;

    // Create gallery data
    const items: { src: string; width: number; height: number; alt: string; element: HTMLImageElement }[] = [];
    
    images.forEach((img, index) => {
      // Skip small images (icons, badges)
      if (img.naturalWidth < 100 || img.naturalHeight < 100) return;

      const src = img.dataset.src || img.src;
      items.push({
        src,
        width: img.naturalWidth || 1200,
        height: img.naturalHeight || 800,
        alt: img.alt || '',
        element: img,
      });

      // Add click handler
      img.addEventListener('click', (e) => {
        e.preventDefault();
        const itemIndex = items.findIndex(item => item.element === img);
        if (itemIndex >= 0 && lightbox) {
          lightbox.loadAndOpen(itemIndex);
        }
      });
    });

    if (items.length === 0) return;

    // Initialize PhotoSwipe
    lightbox = new PhotoSwipeLightbox({
      dataSource: items.map(item => ({
        src: item.src,
        width: item.width,
        height: item.height,
        alt: item.alt,
      })),
      showHideAnimationType: 'zoom',
      pswpModule: () => import('photoswipe'),
      bgOpacity: 0.92,
      padding: { top: 20, bottom: 20, left: 20, right: 20 },
      wheelToZoom: true,
      pinchToClose: true,
      closeOnVerticalDrag: true,
    });

    lightbox.init();
  }

  // Initialize
  initPhotoSwipe();
  document.addEventListener('astro:after-swap', initPhotoSwipe);
</script>
