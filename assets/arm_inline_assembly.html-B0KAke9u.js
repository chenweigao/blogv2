import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,d as n,o as h}from"./app-11Vuyqh7.js";const l={};function k(t,s){return h(),a("div",null,s[0]||(s[0]=[n(`<h2 id="_1-asm" tabindex="-1"><a class="header-anchor" href="#_1-asm"><span>1. __asm</span></a></h2><p>Example<sup class="footnote-ref"><a href="#footnote1">[1]</a><a class="footnote-anchor" id="footnote-ref1"></a></sup>:</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">include</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">stdio.h</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> i</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> j</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> res </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  __asm</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">ADD %[result], %[input_i], %[input_j]</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    : </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">result</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> &quot;=r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    : [input_i] &quot;r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">, [input_j] &quot;r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">j</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  );</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> res</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> b </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> c </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  c </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  printf</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">Result of </span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> + </span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> = </span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;">%d</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们仔细研究上述的例子，可以看到，其内嵌了一条 <code>ADD</code> 指令，其语法如下所示：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">__asm </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">volatile</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> /* Basic inline assembly syntax */</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>其中的 code 就是我们需要内嵌的汇编代码，其中 <code>[volatile]</code> 是可选的，后续我们再对此进行说明。</p><p>如果将 code 展开的话，如下所示：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">/* Extended inline assembly syntax */</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">__asm </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">volatile</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">code_template </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">       :</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> output_operand_list </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">      [</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">: input_operand_list </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">      [</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">: clobbered_register_list</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]]</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  )</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们总共有 3 个 <strong>”:“</strong>, 每一个后面都有不同的含义，下面对其进行具体说明。（注意 <em>[]</em> 符号包含住表示的是这个参数是可选的）</p><h3 id="_1-1-output" tabindex="-1"><a class="header-anchor" href="#_1-1-output"><span>1.1. output</span></a></h3><p>第一个 ：冒号后面跟汇编代码的输出；有几个细节需要注意：</p><ul><li>&quot;=r&quot; 而不是 &quot;r&quot;, 在输出中</li><li><code>%[variable]</code> 的 % 是在最前面的</li></ul><h3 id="_1-2-input" tabindex="-1"><a class="header-anchor" href="#_1-2-input"><span>1.2. input</span></a></h3><p>第二个后面跟汇编代码的输入，如下所示：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">__asm</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">ADD R0, %[input_i], %[input_j]</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    :</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  /* This is an empty output operand list */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    : </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">input_i</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> &quot;r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">, [input_j] &quot;r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">j</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  );</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这个例子中，我们将 <code>input_i</code> 和 <code>input_j</code> 的值相加放入寄存器 <code>R0</code> 中，每一个 input 都使用逗号分隔开，三个字段 <code>[input_i] &quot;r&quot; (i)</code> 的含义分别是符号名称，约束字符串和 C 表达式。</p><h3 id="_1-3-clobbered-register-list" tabindex="-1"><a class="header-anchor" href="#_1-3-clobbered-register-list"><span>1.3. clobbered_register_list</span></a></h3><p>这个里面指定寄存器，嵌入式汇编代码中指定的寄存器可能会产生冲突，因此需要把这些寄存器列举出来，表示其可以在编译的时候被重命名。</p><h2 id="_2-real-example" tabindex="-1"><a class="header-anchor" href="#_2-real-example"><span>2. Real Example</span></a></h2><h3 id="_2-1-prfm" tabindex="-1"><a class="header-anchor" href="#_2-1-prfm"><span>2.1. prfm</span></a></h3><p>下面例子是实战中写的汇编示例，使用了 <code>prfm</code> 指令：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">  #if</span><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;"> defined</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">__arm__</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> j</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    __asm__</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> _</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">_volatile__</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">      &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">add %[result], %[input_i], %[input_j]</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\n\\t</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">      : </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">result</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> &quot;+r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">      : [input_i] &quot;r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">, [input_j] &quot;r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">j</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  __asm__ </span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">__volatile__</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">prfm pldl2strm, [%[ptr], #256]</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    :</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    : </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> &quot;r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">ref</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  );</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">  #</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">endif</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-builtin-prefetch" tabindex="-1"><a class="header-anchor" href="#_2-2-builtin-prefetch"><span>2.2. __builtin_prefetch()</span></a></h3><p><code>__builtin_prefetch()</code> 接口的使用，我们列举几个 art 的例子，看一下大佬门是怎么使用预取，保证提前量，或者将预取的功效发挥到最大的：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">mark_stack_pos_ </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> prefetch_fifo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> kFifoSize</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">    mirror</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">Object</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> const</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> mark_stack_obj </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> mark_stack_</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">--</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">mark_stack_pos_</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">].</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">AsMirrorPtr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    DCHECK</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">mark_stack_obj </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    __builtin_prefetch</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">mark_stack_obj</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    prefetch_fifo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">push_back</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">mark_stack_obj</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">UNLIKELY</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">prefetch_fifo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">obj </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> prefetch_fifo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">front</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">prefetch_fifo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">pop_front</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码的预取位置在 <code>push_back</code> 前面，因为堆栈操作需要一定的时延，所以说利用这个时延在堆栈之前进行预取。</p><p>其次就是利用 fifo 数据结构，但是在实践中使用该方法，并无太大的增益。</p><h3 id="_2-3-prefetch-in-for-loop" tabindex="-1"><a class="header-anchor" href="#_2-3-prefetch-in-for-loop"><span>2.3. prefetch in for loop</span></a></h3><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">uint8_t*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> begin </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> reinterpret_cast&lt;uint8_t*&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">new_run</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> headerSizes</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">idx</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> num_of_bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> kPrefetchStride</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    __builtin_prefetch</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">begin </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> i</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果需要保证提前量，可以如下例子：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> bytes_freed </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> num_ptrs</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">    mirror</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">Object</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> ptrs</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> look_ahead </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 8</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">kPrefetchDuringDlMallocFreeList </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> look_ahead </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> num_ptrs</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">      // The head of chunk for the allocation is sizeof(size_t) behind the allocation.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">      __builtin_prefetch</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">reinterpret_cast&lt;char*&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ptrs</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">i </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> look_ahead</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">])</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    bytes_freed </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> AllocationSizeNonvirtual</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-mrs-pmu" tabindex="-1"><a class="header-anchor" href="#_2-4-mrs-pmu"><span>2.4. mrs pmu</span></a></h3><p>下面这个是读取 PMU 寄存器中的数据的示例：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> inline</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> uint64_t</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> arch_counter_get_cntpct</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    uint64_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cval </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#if</span><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;"> defined</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">__aarch64__</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  __asm__</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> _</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">_volatile__</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // &quot;mrs %[res], PMCCNTR_EL0&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">mrs %[res], CNTVCT_EL0</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    : </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> &quot;=r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">cval</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    :</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  );</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // LOG(INFO) &lt;&lt; &quot;[PREFETCH], COUNTER IS &quot; &lt;&lt; cval;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">endif</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cval</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>CNTVCT_EL0</code> 寄存器为一个不需要开启用户态访问权限也能访问到的寄存器。</p><h3 id="_2-5-tsc" tabindex="-1"><a class="header-anchor" href="#_2-5-tsc"><span>2.5. TSC</span></a></h3><p>这里引出了 TSC 的相关知识：</p><p><strong>核心原理</strong></p><ul><li>TSC 是一个 64 位寄存器（<code>IA32_TIME_STAMP_COUNTER</code>），直接集成在 CPU 中。</li><li>每个 CPU 核独立拥有自己的 TSC，其值随处理器时钟周期递增。</li><li>在传统的 <strong>固定频率 CPU</strong> 中，TSC 递增速率等于 CPU 主频（例如 3 GHz → 每纳秒增加 3 次）。</li><li>现代 CPU（如 Intel Nehalem 后）支持 <strong>恒定 TSC（Constant TSC）</strong>，即使 CPU 因节能降频（如 C-states/P-states），TSC 仍以固定速率递增（基于标称基频）。</li></ul><p><strong>读取指令</strong>：</p><ul><li>x86：通过 <code>RDTSC</code> 或 <code>RDTSCP</code>（原子性更强）指令读取。</li><li>ARM：对应 <code>CNTVCT_EL0</code> 系统寄存器（需特权访问）。</li></ul><p>x86 读取的例子：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">rdtsc</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">          ; 将 TSC 低32位存入 EAX，高32位存入 EDX</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">shl</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> rdx</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">32</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    ; RDX 左移32位</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">or</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> rax</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;">rdx</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    ; RAX = 完整的64位 TSC 值</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-6-memcpy" tabindex="-1"><a class="header-anchor" href="#_2-6-memcpy"><span>2.6. memcpy</span></a></h3><p>下面这个是嵌入 <code>memecpy</code> 的例子：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#if</span><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;"> defined</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">__aarch64__</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;"> defined</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">xxx</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> ()</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // copy len 16</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    __asm__</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> _</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">_volatile__</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">ldp x5, x4 ,[%[src], #8]</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\n\\t</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">stp x5, x4 ,[%[dst], #8]</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\n\\t</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    :</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    : </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">src</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> &quot;r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">from_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">, [dst] &quot;r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">to_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    : &quot;x4&quot;, &quot;x5&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> ()</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> {</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // copy length 24</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    __asm__ </span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">__volatile__</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">ldp x5, x4 ,[%[src], #8]</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\n\\t</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">ldr x6 ,[%[src], #24]</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\n\\t</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">stp x5, x4 ,[%[dst], #8]</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\n\\t</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">str x6 ,[%[dst], #24]</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\n\\t</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    :</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    : </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">src</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> &quot;r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">from_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">, [dst] &quot;r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">to_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    : &quot;x4&quot;, &quot;x5&quot;, &quot;x6&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> ()</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> {</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // copy length 32</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    __asm__ </span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">__volatile__</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">ldp x5, x4 ,[%[src], #8]</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\n\\t</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">ldp x7, x6 ,[%[src], #24]</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\n\\t</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">stp x5, x4 ,[%[dst], #8]</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\n\\t</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">stp x7, x6 ,[%[dst], #24]</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\n\\t</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    :</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    : </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">src</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> &quot;r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">from_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">, [dst] &quot;r&quot; </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">to_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    : &quot;x4&quot;, &quot;x5&quot;, &quot;x6&quot;, &quot;x7&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    memcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">xxx</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">else</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">	// some code</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">endif</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>例子比较长，但是可以供参考，这是比较完备的举例。</p><h2 id="_3-reference" tabindex="-1"><a class="header-anchor" href="#_3-reference"><span>3. Reference</span></a></h2><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="footnote1" class="footnote-item"><p><a href="https://developer.arm.com/documentation/100748/0616/Using-Assembly-and-Intrinsics-in-C-or-C---Code/Writing-inline-assembly-code" target="_blank" rel="noopener noreferrer">ARM 官方文档</a> <a href="#footnote-ref1" class="footnote-backref">↩︎</a></p></li></ol></section>`,50)]))}const d=i(l,[["render",k]]),r=JSON.parse('{"path":"/architecture/arm/arm_inline_assembly.html","title":"ISA: Arm In-line Assembly","lang":"zh-CN","frontmatter":{"title":"ISA: Arm In-line Assembly","date":"2022-12-03T00:00:00.000Z","category":["Arm"],"description":"1. __asm Example[1]: 我们仔细研究上述的例子，可以看到，其内嵌了一条 ADD 指令，其语法如下所示： 其中的 code 就是我们需要内嵌的汇编代码，其中 [volatile] 是可选的，后续我们再对此进行说明。 如果将 code 展开的话，如下所示： 我们总共有 3 个 ”:“, 每一个后面都有不同的含义，下面对其进行具体说明。（注...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"ISA: Arm In-line Assembly\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2022-12-03T00:00:00.000Z\\",\\"dateModified\\":\\"2025-05-07T09:27:16.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Someone\\",\\"url\\":\\"https://www.weigao.cc\\"}]}"],["meta",{"property":"og:url","content":"https://vueblog.weigao.cc/architecture/arm/arm_inline_assembly.html"}],["meta",{"property":"og:site_name","content":"weigao"}],["meta",{"property":"og:title","content":"ISA: Arm In-line Assembly"}],["meta",{"property":"og:description","content":"1. __asm Example[1]: 我们仔细研究上述的例子，可以看到，其内嵌了一条 ADD 指令，其语法如下所示： 其中的 code 就是我们需要内嵌的汇编代码，其中 [volatile] 是可选的，后续我们再对此进行说明。 如果将 code 展开的话，如下所示： 我们总共有 3 个 ”:“, 每一个后面都有不同的含义，下面对其进行具体说明。（注..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-05-07T09:27:16.000Z"}],["meta",{"property":"article:published_time","content":"2022-12-03T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-05-07T09:27:16.000Z"}]]},"git":{"createdTime":1670039195000,"updatedTime":1746610036000,"contributors":[{"name":"weigao chen","username":"","email":"weigao_1995@yeah.net","commits":3},{"name":"chenweigao","username":"chenweigao","email":"297859260@qq.com","commits":2,"url":"https://github.com/chenweigao"},{"name":"weigao","username":"weigao","email":"weigao.cwg","commits":2,"url":"https://github.com/weigao"}]},"readingTime":{"minutes":4,"words":1201},"filePathRelative":"architecture/arm/arm_inline_assembly.md","excerpt":"<h2>1. __asm</h2>\\n<p>Example<sup class=\\"footnote-ref\\"><a href=\\"#footnote1\\">[1]</a><a class=\\"footnote-anchor\\" id=\\"footnote-ref1\\"></a></sup>:</p>\\n<div class=\\"language-cpp line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"cpp\\" style=\\"--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff\\"><pre class=\\"shiki shiki-themes github-light nord vp-code\\"><code><span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold\\">#</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">include</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#ECEFF4\\"> &lt;</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\">stdio.h</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#ECEFF4\\">&gt;</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">int</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\"> add</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">int</span><span style=\\"--shiki-light:#E36209;--shiki-dark:#D8DEE9\\"> i</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">,</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\"> int</span><span style=\\"--shiki-light:#E36209;--shiki-dark:#D8DEE9\\"> j</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">{</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">  int</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> res </span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">=</span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#B48EAD\\"> 0</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">  __asm</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\"> (</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#ECEFF4\\">\\"</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\">ADD %[result], %[input_i], %[input_j]</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#ECEFF4\\">\\"</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">    : </span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">[</span><span style=\\"--shiki-light:#E36209;--shiki-dark:#D8DEE9\\">result</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">]</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> \\"=r\\" </span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF\\">res</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">    : [input_i] \\"r\\" </span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF\\">i</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">, [input_j] \\"r\\" </span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF\\">j</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">  );</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">  return</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> res</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">}</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">int</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\"> main</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">void</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">{</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">  int</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> a </span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">=</span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#B48EAD\\"> 1</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">  int</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> b </span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">=</span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#B48EAD\\"> 2</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">  int</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> c </span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">=</span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#B48EAD\\"> 0</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">  c </span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">=</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\"> add</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">a</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">,</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">b</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">  printf</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#ECEFF4\\">\\"</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\">Result of </span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#A3BE8C\\">%d</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\"> + </span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#A3BE8C\\">%d</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\"> = </span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#A3BE8C\\">%d</span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#EBCB8B\\">\\\\n</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#ECEFF4\\">\\"</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">,</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> a</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">,</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> b</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">,</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> c</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">}</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{d as comp,r as data};
