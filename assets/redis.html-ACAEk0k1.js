import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as d,a as s,d as r,e as a,w as l,r as h,o as p,b as t}from"./app-11Vuyqh7.js";const k={},o={class:"table-of-contents"};function c(g,i){const e=h("router-link");return p(),d("div",null,[i[14]||(i[14]=s("h2",{id:"abstract",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#abstract"},[s("span",null,"Abstract")])],-1)),s("nav",o,[s("ul",null,[s("li",null,[a(e,{to:"#abstract"},{default:l(()=>i[0]||(i[0]=[t("Abstract")])),_:1})]),s("li",null,[a(e,{to:"#redis-简述"},{default:l(()=>i[1]||(i[1]=[t("Redis 简述")])),_:1})]),s("li",null,[a(e,{to:"#redis-原理"},{default:l(()=>i[2]||(i[2]=[t("Redis 原理")])),_:1})]),s("li",null,[a(e,{to:"#数据淘汰策略"},{default:l(()=>i[3]||(i[3]=[t("数据淘汰策略")])),_:1})]),s("li",null,[a(e,{to:"#redis-生产适用场景"},{default:l(()=>i[4]||(i[4]=[t("Redis 生产适用场景")])),_:1})]),s("li",null,[a(e,{to:"#redis-优化"},{default:l(()=>i[5]||(i[5]=[t("Redis 优化")])),_:1})]),s("li",null,[a(e,{to:"#redis-分布式锁"},{default:l(()=>i[6]||(i[6]=[t("Redis 分布式锁")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#分布式锁"},{default:l(()=>i[7]||(i[7]=[t("分布式锁")])),_:1})])])]),s("li",null,[a(e,{to:"#redis-分布式集群"},{default:l(()=>i[8]||(i[8]=[t("Redis 分布式集群")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#redis-分布式锁-1"},{default:l(()=>i[9]||(i[9]=[t("Redis 分布式锁")])),_:1})]),s("li",null,[a(e,{to:"#redis-cluster-槽"},{default:l(()=>i[10]||(i[10]=[t("Redis Cluster 槽")])),_:1})])])]),s("li",null,[a(e,{to:"#redis-py"},{default:l(()=>i[11]||(i[11]=[t("redis-py")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#strictredis"},{default:l(()=>i[12]||(i[12]=[t("StrictRedis()")])),_:1})]),s("li",null,[a(e,{to:"#append"},{default:l(()=>i[13]||(i[13]=[t("append()")])),_:1})])])])])]),i[15]||(i[15]=r(`<p>Redis(Remote Dictionary Server) server 的启动：</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">redis-server.exe</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> redis.windows.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>安装 redis-py:</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> redis</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><a href="https://redis-py.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">官方文档</a></p><blockquote><p>redis 提供两个类 Redis 和 StrictRedis 用于实现 Redis 的命令，StrictRedis 用于实现大部分官方的命令，并使用官方的语法和命令，Redis 是 StrictRedis 的子类，用于向后兼容旧版本的 redis-py。</p></blockquote><p>可以使用 Redis 可视化工具 <strong>RDM(redis deaktop manager)</strong></p><h2 id="redis-简述" tabindex="-1"><a class="header-anchor" href="#redis-简述"><span>Redis 简述</span></a></h2><p>什么是 Redis？有什么优缺点？</p><ul><li>Redis本质上是一个 key-value 类型的内存数据库，整个数据库都在内存中加载，通过异步操作可以持久化到磁盘中</li><li>Redis的性能十分出色，是已知的性能最快的 key-value DB(每秒大概处理10W次IO操作)</li><li>Redis 拥有丰富的数据结构（5 种，分别是 string, list, hash, set, zset）</li><li>Redis 丰富的数据结构给了它很多的应用，如 celery 就可以维护一个高性能的消息队列(list)</li><li>不同于 memcached, redis 的单个 value 可以保存的最大数据限制是 1GB(memcached 是 1M)</li><li>缺点在于 redis 的数据存储受到物理内存的限制，不能做海量的数据场景</li></ul><h2 id="redis-原理" tabindex="-1"><a class="header-anchor" href="#redis-原理"><span>Redis 原理</span></a></h2><h2 id="数据淘汰策略" tabindex="-1"><a class="header-anchor" href="#数据淘汰策略"><span>数据淘汰策略</span></a></h2><p>当达到内存最大限制的时候，Redis 会采用一些策略(maxmemory-policy配置), 来进行数据淘汰：</p><ol><li>noeviction：默认策略，不淘汰，达到最大的内存限制的时候，如果再请求更多的数据，直接报错</li><li>allkeys-lru：LRU 策略，删除最近最少使用的 key, 针对于所有的key</li><li>volatile-lru：设置的 expire 的key使用 LRU</li><li>allkeys-random：随机删除一部分key</li><li>volatile-random：对设置的 expire 的key随机删除</li><li>volatile-ttl：对设置 expire 的key使用，优先删除剩余时间短的key</li></ol><p>对于这六种数据淘汰策略的使用场景可以归纳为：</p><ol><li>如果分为热数据和冷数据的场景（所有key中有一部分经常被读写），使用 LRU 方法</li><li>如果是循环读所有的 key, 那么就使用 allkeys-random 策略</li></ol><h2 id="redis-生产适用场景" tabindex="-1"><a class="header-anchor" href="#redis-生产适用场景"><span>Redis 生产适用场景</span></a></h2><ol><li>session cache 会话缓存 一般业界使用 memcached, 但是 redis 多了持久化功能，可以维护严格要求一致性的缓存</li><li>FPC 全页缓存</li><li>redis queues 如 celery 队列可以使用 redis作为broker</li><li>排行榜、计数器 使用了 redis 中的递增和递减操作</li><li>原子操作、事务操作 事务是一个单独的隔离操作，事务中的所有命令都会序列化、按顺序地执行； 事务在执行的过程中不会被其他客户端发送过来的命令打断； 事务是一个原子操作，事务中的所有命令要么全部被执行，要么全部不执行。 事务相关的命令：<code>MULTI, EXEC, DISCARD, WATCH</code></li></ol><h2 id="redis-优化" tabindex="-1"><a class="header-anchor" href="#redis-优化"><span>Redis 优化</span></a></h2><ol><li><p>设置key的过期时间 使用<code>expire</code>命令，如果想要永久有效，那么就使用 <code>presist</code>.</p></li><li><p>使用散列表 比如说有一个场景，需要存储用户的账户、密码等信息，尽量不给每一个字段去设置单独的key, 而是将他们一起存储于一张散列表里面。</p></li></ol><h2 id="redis-分布式锁" tabindex="-1"><a class="header-anchor" href="#redis-分布式锁"><span>Redis 分布式锁</span></a></h2><h3 id="分布式锁" tabindex="-1"><a class="header-anchor" href="#分布式锁"><span>分布式锁</span></a></h3><p>分布式的流行使得原单机部署情况下的并发控制策略失效。</p><p>分布式锁大致分为三种：</p><ol><li>数据库乐观锁</li><li>基于 redis 的分布式锁</li><li>基于 ZooKeeper 的分布式锁</li></ol><p>分布式锁的实现条件：</p><ol><li>互斥性，任何时候只能有一个客户端持有锁</li><li>可靠性，尽量避免死锁</li><li>一致性，锁只能由加锁人解锁，不能产生A的加锁被B用户解锁的情况</li></ol><h2 id="redis-分布式集群" tabindex="-1"><a class="header-anchor" href="#redis-分布式集群"><span>Redis 分布式集群</span></a></h2><p>目前已知的可以通过 proxy 来实现</p><h3 id="redis-分布式锁-1" tabindex="-1"><a class="header-anchor" href="#redis-分布式锁-1"><span>Redis 分布式锁</span></a></h3><p>基本上实现如下，主要使用三个命令：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"># SETNX</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">SETNX</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> key</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> val</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"># EXPIRE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">expire</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> key</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> timeout</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"># DELETE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">delete</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> key</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>redis 锁的实现思路基本上是：</p><ol><li>setnx加锁，并设置超时时间，这时候锁的 value 值就是一个随机生成的 UUID</li><li>获取锁和超时时间</li><li>释放锁的时候根据 UUID 判断，而后 DELETE 删除（注意这里要注意原子性）</li></ol><h3 id="redis-cluster-槽" tabindex="-1"><a class="header-anchor" href="#redis-cluster-槽"><span>Redis Cluster 槽</span></a></h3><h2 id="redis-py" tabindex="-1"><a class="header-anchor" href="#redis-py"><span>redis-py</span></a></h2><h3 id="strictredis" tabindex="-1"><a class="header-anchor" href="#strictredis"><span>StrictRedis()</span></a></h3><p>初始化 Redis:</p><div class="language-py line-numbers-mode" data-highlighter="shiki" data-ext="py" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> redis </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> StrictRedis</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> create_redis_client</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">():</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    redis_client </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#88C0D0;"> StrictRedis</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">            host</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">            port</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">6379</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">            password</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;">None</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> redis_client</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也可以使用 <code>Redis()</code> 类初始化，如果遇到了向后兼容的问题。</p><h3 id="append" tabindex="-1"><a class="header-anchor" href="#append"><span>append()</span></a></h3><div class="language-py line-numbers-mode" data-highlighter="shiki" data-ext="py" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">redis_client</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#88C0D0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果 key 不存在则创建。</p>`,43))])}const m=n(k,[["render",c]]),b=JSON.parse('{"path":"/blogs/Database/redis.html","title":"Redis and redis-py","lang":"zh-CN","frontmatter":{"title":"Redis and redis-py","date":"2019-09-03T00:00:00.000Z","category":["Database"],"tag":["database","python"],"description":"Abstract Redis(Remote Dictionary Server) server 的启动： 安装 redis-py: 官方文档 redis 提供两个类 Redis 和 StrictRedis 用于实现 Redis 的命令，StrictRedis 用于实现大部分官方的命令，并使用官方的语法和命令，Redis 是 StrictRedis 的子...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Redis and redis-py\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2019-09-03T00:00:00.000Z\\",\\"dateModified\\":\\"2022-09-27T15:26:02.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Someone\\",\\"url\\":\\"https://www.weigao.cc\\"}]}"],["meta",{"property":"og:url","content":"https://vueblog.weigao.cc/blogs/Database/redis.html"}],["meta",{"property":"og:site_name","content":"weigao"}],["meta",{"property":"og:title","content":"Redis and redis-py"}],["meta",{"property":"og:description","content":"Abstract Redis(Remote Dictionary Server) server 的启动： 安装 redis-py: 官方文档 redis 提供两个类 Redis 和 StrictRedis 用于实现 Redis 的命令，StrictRedis 用于实现大部分官方的命令，并使用官方的语法和命令，Redis 是 StrictRedis 的子..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2022-09-27T15:26:02.000Z"}],["meta",{"property":"article:tag","content":"python"}],["meta",{"property":"article:tag","content":"database"}],["meta",{"property":"article:published_time","content":"2019-09-03T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2022-09-27T15:26:02.000Z"}]]},"git":{"createdTime":1644237761000,"updatedTime":1664292362000,"contributors":[{"name":"chenweigao","username":"chenweigao","email":"297859260@qq.com","commits":5,"url":"https://github.com/chenweigao"}]},"readingTime":{"minutes":3.85,"words":1156},"filePathRelative":"blogs/Database/redis.md","excerpt":"<h2>Abstract</h2>\\n\\n<p>Redis(Remote Dictionary Server) server 的启动：</p>\\n<div class=\\"language-sh line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"sh\\" style=\\"--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff\\"><pre class=\\"shiki shiki-themes github-light nord vp-code\\"><code><span class=\\"line\\"><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">redis-server.exe</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\"> redis.windows.conf</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{m as comp,b as data};
