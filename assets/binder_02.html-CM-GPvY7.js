import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,d as n,o as l}from"./app-11Vuyqh7.js";const e="/assets/buffers-DqNAhbak.png",h={};function t(k,s){return l(),a("div",null,s[0]||(s[0]=[n(`<h2 id="概览" tabindex="-1"><a class="header-anchor" href="#概览"><span>概览</span></a></h2><p>Binder 内存管理指的是：管理 binder mmap 映射的这块<strong>缓冲区</strong>。其中有两个关键的数据结构：</p><p><strong>binder_alloc</strong>：缓冲区分配器，对每个使用 binder 进行 IPC 通信的进程，事先建立一个缓冲区；</p><p><strong>binder_buffer</strong>: 描述缓冲区的数据结构</p><p>本文先对这两个关键的数据结构进行研究，然后再逐一分析使用这些数据结构的相关函数和算法。</p><h2 id="数据结构分析" tabindex="-1"><a class="header-anchor" href="#数据结构分析"><span>数据结构分析</span></a></h2><h3 id="binder-alloc" tabindex="-1"><a class="header-anchor" href="#binder-alloc"><span>binder_alloc</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_alloc </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> mutex mutex</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // 指向调用 mmap 时分配的 vm_area_struct（描述用户空间的虚拟地址）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> vm_area_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">vma</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // 该进程的用户空间及相关信息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> mm_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">vma_vm_mm</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // vm_area_struct 的起始地址</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    void</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // 一个双向循环链表</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> list_head buffers</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // 红黑树，管理所有可分配的 binder_buffer, 按 buffer 大小排序</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> rb_root free_buffers</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // 管理所有已分配的 binder_buffer, 按 buffer 的起始的用户空间虚拟地址排序</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> rb_root allocated_buffers</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> free_async_space</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // 数组，每个元素对应一个物理页，用于物理页回收</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_lru_page </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">pages</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // 整个缓冲区大小</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> buffer_size</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> buffer_free</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> pid</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> pages_high</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>vm_area_struct</code> 数据结构用于描述用户空间的虚拟地址，其中包括虚拟地址相关的信息。</p><p>在缓冲区初始化或者分配以后，内存中会多出如下几个数据结构：</p><figure><img src="`+e+`" alt="binder_alloc" tabindex="0" loading="lazy"><figcaption>binder_alloc</figcaption></figure><p>需要注意，其中 allocated_buffers 红黑树此时是一个空树。</p><h3 id="binder-buffer" tabindex="-1"><a class="header-anchor" href="#binder-buffer"><span>binder_buffer</span></a></h3><p>binder_buffer 数据结构用于表示缓冲区：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_buffer </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    /*  表示链表中的一个节点；将 binder_buffer 插入 binder_alloc 的 buffer 链表时，</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">     *  就是将该 entry 插入链表中；遍历链表的时候           </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">     *  拿到该 entry, 可通过 API 获取对应的 binder_buffer </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> list_head entry</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> /* free and allocated entries by address */</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // 在红黑树中 binder_buff 的表示：free_buffers 和 allocated_buffers </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> rb_node rb_node</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> /* free entry by size or allocated entry */</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">                /* by address */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    unsigned</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> free:</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // 标识该 buffer 是空闲的</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    unsigned</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> allow_user_free:</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    unsigned</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> async_transaction:</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    unsigned</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> debug_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">29</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_transaction </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">transaction</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // 与该缓冲区关联的 binder_transaction</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_node </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">target_node</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // 与该缓冲区关联的 binder_node</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> data_size</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // transaction 数据的大小</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> offsets_size</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // offsets 数组的大小</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> extra_buffers_size</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // 其他对象的空间大小</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    void</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">user_data</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // 用户空间的虚拟地址，指向该缓冲区的起始位置</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    pid</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // 所属进程的 id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="mmap-的两个函数" tabindex="-1"><a class="header-anchor" href="#mmap-的两个函数"><span>mmap 的两个函数</span></a></h2><p>有两个函数和 mmap 和上述的两个数据结构息息相关：</p><p><strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Fcs.android.com%2Fandroid%2F_%2Fandroid%2Fkernel%2Fcommon%2F%2B%2Fandroid13-5.15%3Adrivers%2Fandroid%2Fbinder_alloc.c%3Bbpv%3D0%3Bbpt%3D0%3Bl%3D739" target="_blank" rel="noopener noreferrer">binder_alloc_mmap_handler()</a></strong>：用户分配空间，参数 struct binder_alloc *alloc 和 struct vm_area_struct *vma</p><p><strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Fcs.android.com%2Fandroid%2F_%2Fandroid%2Fkernel%2Fcommon%2F%2B%2Fandroid13-5.15%3Adrivers%2Fandroid%2Fbinder_alloc.c%3Bl%3D1207%3Bbpv%3D0%3Bbpt%3D0" target="_blank" rel="noopener noreferrer">binder_alloc_copy_user_to_buffer()</a></strong>：将客户端的数据 copy 到缓冲区，逐个物理页处理。</p><ol><li><p>通过 kmap 建立内核空间虚拟地址和物理页的映射</p></li><li><p>通过 copy_from_user 按页拷贝</p></li><li><p>通过 kunmap 取消映射</p></li></ol><h3 id="binder-alloc-mmap-handler" tabindex="-1"><a class="header-anchor" href="#binder-alloc-mmap-handler"><span>binder_alloc_mmap_handler()</span></a></h3><p>todo</p><h3 id="binder-alloc-copy-user-to-buffer" tabindex="-1"><a class="header-anchor" href="#binder-alloc-copy-user-to-buffer"><span>binder_alloc_copy_user_to_buffer()</span></a></h3><p>其代码如下：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * binder_alloc_copy_user_to_buffer() - copy src user to tgt user</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">@alloc:</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> binder_alloc for this proc</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * (指向 binder_alloc 数据结构)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">@buffer:</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> binder buffer to be accessed</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * （指向 binder_buff 数据结构）从缓存区中划分出一小块，用于接收客户端数据；</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * buffer 是否已经分配物理内存？取决于 kzmalloc</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">@buffer_offset:</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> offset into @buffer data</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">@from:</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> userspace pointer to source buffer</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">@bytes:</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> bytes to copy</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * Copy bytes from source userspace to target buffer.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * Return: bytes remaining to be copied</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> long</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">binder_alloc_copy_user_to_buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_alloc </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">alloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">				 struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">				 binder_size_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> buffer_offset</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">				 const</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">				 size_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">check_buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">alloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> buffer_offset</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	while</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> ret</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> page </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">page</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">		pgoff_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> pgoff</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		void</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">kptr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">		page </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_alloc_get_page</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">alloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">					     buffer_offset</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">pgoff</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">		size </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> min_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> PAGE_SIZE </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> pgoff</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">		kptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> kmap</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">page</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> pgoff</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">		ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> copy_from_user</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">kptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> from</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">		kunmap</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">page</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ret</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> bytes </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> size </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> ret</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">		bytes </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">-=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">		from </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">		buffer_offset </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">	}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	return</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="caller-binder-transaction" tabindex="-1"><a class="header-anchor" href="#caller-binder-transaction"><span>caller: binder_transaction()</span></a></h4><p>binder_alloc_copy_user_to_buffer 函数在 binder_transaction 中被调用。</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">binder_alloc_copy_user_to_buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">				&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">target_proc</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">alloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">				t</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">				(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">					(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">uintptr_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tr</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">data.ptr.buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">				tr</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">data_size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重点关注其中的 buffer, 来自于 <strong>t-&gt;buffer</strong>, t 是一个 <em>struct</em> binder_transaction *t, binder_transaction 中有一个 binder_buffer 类型的成员变量; 其赋值的语句如下：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">t </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> kzalloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> GFP_KERNEL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>第一个参数，含义为 size</li><li>第二个参数，含义为分配的内存类型</li></ul><p><code>kzalloc</code> 函数的定义和实现如下：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * kzalloc - allocate memory. The memory is set to zero.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">@size:</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> how many bytes of memory are required.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">@flags:</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> the type of memory to allocate (see kmalloc).</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> inline</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">kzalloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">size_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;"> gfp_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> kmalloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __GFP_ZERO</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>kzalloc()</code> 分配一个指定大小的内存块，并将其初始化为 0。它类似于 <code>kmalloc()</code>，但会自动将分配的内存清零，以避免敏感数据泄露。</p><p>如果分配成功，则返回指向分配内存块的指针。注意，这个函数分配的是内核中的虚拟内存。</p><div class="hint-container tip"><p class="hint-container-title">关于 malloc 内存分配</p><p>malloc 内存分配的时候，内核会给申请者分配一个物理页，如果不够的话，再触发缺页异常。</p></div><hr><p>接下来再看 tr-&gt;data.ptr.buffer 的含义，这是第四个参数 <em>@from: userspace pointer to source buffer</em>；tr 是 binder_transaction 自带的参数，类型为 binder_transaction_data, 数据结构如下：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	union</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		struct</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">			/* transaction data */</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">			binder_uintptr_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">			/* offsets from buffer to flat_binder_object structs */</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">			binder_uintptr_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	offsets</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">		}</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">		__u8	</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9FF;">buf</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">	}</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后一个参数也是来自于 tr.</p><h4 id="callee" tabindex="-1"><a class="header-anchor" href="#callee"><span>callee</span></a></h4>`,41)]))}const d=i(h,[["render",t]]),E=JSON.parse('{"path":"/java/android/binder_02.html","title":"Binder 内存管理","lang":"zh-CN","frontmatter":{"title":"Binder 内存管理","date":"2023-07-18T00:00:00.000Z","tag":["kernel","Android","Binder"],"category":["Android","Kernel"],"description":"概览 Binder 内存管理指的是：管理 binder mmap 映射的这块缓冲区。其中有两个关键的数据结构： binder_alloc：缓冲区分配器，对每个使用 binder 进行 IPC 通信的进程，事先建立一个缓冲区； binder_buffer: 描述缓冲区的数据结构 本文先对这两个关键的数据结构进行研究，然后再逐一分析使用这些数据结构的相关函...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Binder 内存管理\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2023-07-18T00:00:00.000Z\\",\\"dateModified\\":\\"2023-07-18T14:42:53.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Someone\\",\\"url\\":\\"https://www.weigao.cc\\"}]}"],["meta",{"property":"og:url","content":"https://vueblog.weigao.cc/java/android/binder_02.html"}],["meta",{"property":"og:site_name","content":"weigao"}],["meta",{"property":"og:title","content":"Binder 内存管理"}],["meta",{"property":"og:description","content":"概览 Binder 内存管理指的是：管理 binder mmap 映射的这块缓冲区。其中有两个关键的数据结构： binder_alloc：缓冲区分配器，对每个使用 binder 进行 IPC 通信的进程，事先建立一个缓冲区； binder_buffer: 描述缓冲区的数据结构 本文先对这两个关键的数据结构进行研究，然后再逐一分析使用这些数据结构的相关函..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2023-07-18T14:42:53.000Z"}],["meta",{"property":"article:tag","content":"Binder"}],["meta",{"property":"article:tag","content":"Android"}],["meta",{"property":"article:tag","content":"kernel"}],["meta",{"property":"article:published_time","content":"2023-07-18T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2023-07-18T14:42:53.000Z"}]]},"git":{"createdTime":1689672259000,"updatedTime":1689691373000,"contributors":[{"name":"weigao chen","username":"","email":"weigao_1995@yeah.net","commits":2},{"name":"chenweigao","username":"chenweigao","email":"297859260@qq.com","commits":1,"url":"https://github.com/chenweigao"}]},"readingTime":{"minutes":4.3,"words":1290},"filePathRelative":"java/android/binder_02.md","excerpt":"<h2>概览</h2>\\n<p>Binder 内存管理指的是：管理 binder mmap 映射的这块<strong>缓冲区</strong>。其中有两个关键的数据结构：</p>\\n<p><strong>binder_alloc</strong>：缓冲区分配器，对每个使用 binder 进行 IPC 通信的进程，事先建立一个缓冲区；</p>\\n<p><strong>binder_buffer</strong>: 描述缓冲区的数据结构</p>\\n<p>本文先对这两个关键的数据结构进行研究，然后再逐一分析使用这些数据结构的相关函数和算法。</p>\\n<h2>数据结构分析</h2>\\n<h3>binder_alloc</h3>","autoDesc":true}');export{d as comp,E as data};
