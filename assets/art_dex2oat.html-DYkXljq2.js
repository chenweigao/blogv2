import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as s,d as t,o as e}from"./app-11Vuyqh7.js";const n={};function h(p,i){return e(),s("div",null,i[0]||(i[0]=[t(`<h2 id="abstract" tabindex="-1"><a class="header-anchor" href="#abstract"><span>Abstract</span></a></h2><p>本文主要研究 art 中的 dex2oat 模块。</p><p>写作本文的目的在于，笔者在研究 <code>getCharNoCheck</code> 的 native 实现的时候，发现其调用的路径是与 dex2oat 有关的，所以对这个模块进行简单的研究；</p><p>第一阶段本文主要研究，Andriod 运行时 art 加载 oat 文件的过程分析，写作时间2022年10月28日；</p><p>第二阶段主要对本文进行补充，包括 oat 文件结构的研究；</p><h2 id="art-oat" tabindex="-1"><a class="header-anchor" href="#art-oat"><span>Art &amp; oat</span></a></h2><h3 id="oat-文件的产生" tabindex="-1"><a class="header-anchor" href="#oat-文件的产生"><span>oat 文件的产生</span></a></h3><p>首先需要弄明白，oat 文件是如何产生的？首先是 Art 虚拟机的创建过程，我们在前文已经进行了研究。</p><p>@todo</p><h3 id="dex2oat-什么时候被触发" tabindex="-1"><a class="header-anchor" href="#dex2oat-什么时候被触发"><span>dex2oat 什么时候被触发</span></a></h3><p>dex2oat 进程的启动，可以分为两类：</p><ol><li><p>Installd 进程触发的 dex2oat</p><ul><li><p>应用安装；包括普通安装和通过 shellCmd 安装，安装一个 app 的过程中需要编译 dex 文件，会通知 Installd 来触发一个 dex2oat 进程</p></li><li><p>开机扫描，开机过程中，PMS 扫描已安装 app 过程，判断需要优化时，则会对 installd 发出通知</p></li><li><p>BackgroundDexOptService，空闲时段或者开机之后触发的 Backgroud 的 Job，会通知 installd 进行dex2oat</p></li><li><p>OTADexoptService, 疑似 OTA 过程中触发</p></li></ul></li><li><p>由 app 中直接调用的 dex2oat；App 进程 fork 出一个子进程，子进程用来执行 dex2oat, 编译相关的 dex, 父进程进行 waitpid 等待，等待完成后再运行其他逻辑。</p><ul><li><p>微信安装后的首次启动，有 dex2oat 的调用；</p></li><li><p>淘宝安装后的首次搜索，有 dex2oat 的调用</p></li></ul></li></ol><h2 id="dex2oat-code" tabindex="-1"><a class="header-anchor" href="#dex2oat-code"><span>dex2oat code</span></a></h2><h3 id="main" tabindex="-1"><a class="header-anchor" href="#main"><span>main()</span></a></h3><p>dex2oat 的 main 函数定义如下：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// art/dex2oat/dex2oat.cc</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> argc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> char**</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> argv</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> static_cast&lt;int&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">art</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Dex2oat</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">argc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> argv</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // Everything was done, do an explicit exit here to avoid running Runtime destructors that take</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // time (bug 10645725) unless we&#39;re a debug or instrumented build or running on a memory tool.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // Note: The Dex2Oat class should not destruct the runtime in this case.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">art</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">kIsDebugBuild </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> !</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">art</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">kIsPGOInstrumentation </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> !</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">art</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">kRunningOnMemoryTool</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">    art</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">FastExit</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">result</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> result</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 main 函数中，调用了 <code>Dex2oat</code>；</p>`,17)]))}const d=a(n,[["render",h]]),k=JSON.parse('{"path":"/java/art/art_dex2oat.html","title":"ART dex2oat","lang":"zh-CN","frontmatter":{"title":"ART dex2oat","date":"2022-10-28T00:00:00.000Z","tag":["jvm","java"],"category":["JAVA"],"description":"Abstract 本文主要研究 art 中的 dex2oat 模块。 写作本文的目的在于，笔者在研究 getCharNoCheck 的 native 实现的时候，发现其调用的路径是与 dex2oat 有关的，所以对这个模块进行简单的研究； 第一阶段本文主要研究，Andriod 运行时 art 加载 oat 文件的过程分析，写作时间2022年10月28日...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"ART dex2oat\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2022-10-28T00:00:00.000Z\\",\\"dateModified\\":\\"2024-12-14T07:57:48.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Someone\\",\\"url\\":\\"https://www.weigao.cc\\"}]}"],["meta",{"property":"og:url","content":"https://vueblog.weigao.cc/java/art/art_dex2oat.html"}],["meta",{"property":"og:site_name","content":"weigao"}],["meta",{"property":"og:title","content":"ART dex2oat"}],["meta",{"property":"og:description","content":"Abstract 本文主要研究 art 中的 dex2oat 模块。 写作本文的目的在于，笔者在研究 getCharNoCheck 的 native 实现的时候，发现其调用的路径是与 dex2oat 有关的，所以对这个模块进行简单的研究； 第一阶段本文主要研究，Andriod 运行时 art 加载 oat 文件的过程分析，写作时间2022年10月28日..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-12-14T07:57:48.000Z"}],["meta",{"property":"article:tag","content":"java"}],["meta",{"property":"article:tag","content":"jvm"}],["meta",{"property":"article:published_time","content":"2022-10-28T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-12-14T07:57:48.000Z"}]]},"git":{"createdTime":1666937748000,"updatedTime":1734163068000,"contributors":[{"name":"weigao chen","username":"","email":"weigao_1995@yeah.net","commits":2},{"name":"chenweigao","username":"chenweigao","email":"297859260@qq.com","commits":2,"url":"https://github.com/chenweigao"},{"name":"weigao","username":"weigao","email":"weigao.cwg","commits":1,"url":"https://github.com/weigao"}]},"readingTime":{"minutes":1.74,"words":522},"filePathRelative":"java/art/art_dex2oat.md","excerpt":"<h2>Abstract</h2>\\n<p>本文主要研究 art 中的 dex2oat 模块。</p>\\n<p>写作本文的目的在于，笔者在研究 <code>getCharNoCheck</code> 的 native 实现的时候，发现其调用的路径是与 dex2oat 有关的，所以对这个模块进行简单的研究；</p>\\n<p>第一阶段本文主要研究，Andriod 运行时 art 加载 oat 文件的过程分析，写作时间2022年10月28日；</p>\\n<p>第二阶段主要对本文进行补充，包括 oat 文件结构的研究；</p>\\n<h2>Art &amp; oat</h2>\\n<h3>oat 文件的产生</h3>","autoDesc":true}');export{d as comp,k as data};
