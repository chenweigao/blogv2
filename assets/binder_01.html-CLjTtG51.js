import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,d as n,o as h}from"./app-11Vuyqh7.js";const l={};function k(p,s){return h(),a("div",null,s[0]||(s[0]=[n(`<p>æœ¬æ–‡ä¸»è¦è®²è¿° Binder æµç¨‹ä¸­çš„å„ä¸ªé˜¶æ®µï¼Œèµ·åˆ°ä¸€ä¸ª Overview çš„ç›®çš„ã€‚</p><h2 id="phases-overview" tabindex="-1"><a class="header-anchor" href="#phases-overview"><span>Phases Overview</span></a></h2><p>æˆ‘ä»¬æƒ³å¯¹ binder åšæ€§èƒ½ä¼˜åŒ–ï¼ˆè¿™å—éƒ¨åˆ†å¦‚æœåç»­è¾ƒä¸ºå®Œå–„çš„è¯å¯ä»¥è€ƒè™‘ç‹¬ç«‹å‡ºå»ï¼‰ï¼Œå¯ä»¥ä»å‡ ä¸ª phase è¿›è¡Œåˆ†è§£ï¼š</p><ul><li>ğŸ‡ğŸ‡ phase 1: app to BpBinder: ä» app åˆ° Binder å®¢æˆ·ç«¯ã€‚</li><li>phase 2: BpBinder to driver</li><li>phase 3: driver send logic</li><li>ğŸ‡ğŸ‡ phase 4: driver to BBinder</li><li>ğŸ‡ğŸ‡ phase 5: BBinder to server</li><li>phase 6: server logic</li><li>phase 7: server back BBinder</li><li>phase 8: BBinder back driver</li><li>phase 9: driver reply logic</li><li>phase 10: driver back BpBinder</li><li>phase 11: BpBinder back app</li></ul><p>ä¸ºæ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬å¼•ç”¨ä¸‹é¢çš„å›¾æ¥è¿›è¡Œå‚è€ƒè¯´æ˜ã€‚</p><figure><img src="http://gityuan.com/images/binder/binder_start_service/binder_ipc_arch.jpg" alt="binder phases" tabindex="0" loading="lazy"><figcaption>binder phases</figcaption></figure><h2 id="phase-1" tabindex="-1"><a class="header-anchor" href="#phase-1"><span>Phase 1</span></a></h2><p><strong>App to BpBinder</strong>, å›¾ä¸­çš„ AMP clinet åˆ° BpBinder çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸»è¦å‘ç”Ÿäº†ä»¥ä¸‹äº‹æƒ…ï¼š</p><p>åœ¨ APP ä¾§ï¼Œè°ƒç”¨ <code>startService()</code>, åœ¨è°ƒç”¨è¯¥å‡½æ•°ä¹‹é—´ï¼Œä¼šè°ƒç”¨åˆ°å…¶ä»–çš„é€»è¾‘ï¼Œæˆ‘ä»¬åˆ†åˆ«ç»™å‡ºä¸€ä¸ª OHOS çš„ç¤ºä¾‹å’Œ Android çš„ç¤ºä¾‹ã€‚</p><h3 id="ohos" tabindex="-1"><a class="header-anchor" href="#ohos"><span>OHOS</span></a></h3><p>åˆ—ä¸¾äº†ä¸¤ç§æ–¹å¼ï¼šæœŸçº¦å’Œå›è°ƒå‡½æ•°ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;"> rpc</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">@ohos.rpc</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// ä½¿ç”¨æœŸçº¦</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> option</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">MessageOption</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">MessageParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> reply</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">MessageParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// å¾€ data é‡Œå†™å…¥å‚æ•°</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">proxy</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">sendRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> option</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">result</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">result</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">errCode</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> !=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">            console</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">send request failed, errCode: </span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> result</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">errCode</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // ä»result.replyé‡Œè¯»å–ç»“æœ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        console</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">send request got exception: </span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> e</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">reclaim</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">reclaim</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨æœŸçº¦çš„æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯å®Œæˆäº†å‡ ä»¶äº‹æƒ…ã€‚é¦–å…ˆæ˜¯å¾€ Parcel å¯¹è±¡ä¸­å†™å…¥å‚æ•°ï¼Œè€Œåæ˜¯è°ƒç”¨ proxy çš„ sendRequest æ–¹æ³•ï¼Œå¾—åˆ°æœåŠ¡ç«¯çš„å›å¤åè¿›è¡Œå¤„ç†ã€‚</p><p>æˆ‘ä»¬æ‰€è¯´çš„ App to BpBinder çš„è¿‡ç¨‹å°±æ˜¯ï¼šå®¢æˆ·ç«¯æ•°æ®å°è£… â€“&gt; è°ƒç”¨ BpBinder(åœ¨ OHOS ä¸­ç§°ä½œ Proxy) æä¾›çš„æ–¹æ³•ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// ä½¿ç”¨å›è°ƒå‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> sendRequestCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">result</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            try</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">result</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">errCode</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> !=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">                    console</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">send request failed, errCode: </span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> result</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">errCode</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                    return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">                }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">                // ä» result.reply é‡Œè¯»å–ç»“æœ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">            }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> finally</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">                result</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">reclaim</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">                result</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">reclaim</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> option</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">MessageOption</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">MessageParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> reply</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">MessageParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// å¾€ data é‡Œå†™å…¥å‚æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">proxy</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">sendRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> option</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> sendRequestCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨å›è°ƒå‡½æ•°çš„è¿‡ç¨‹è¾ƒä¸ºç®€å•ï¼Œç›´æ¥æ˜¯å°è£…æ•°æ® â€“&gt; å‘é€è¯·æ±‚ï¼ˆåœ¨æˆ‘ä»¬ phase 1 çš„è¿‡ç¨‹ä¸­ï¼‰</p><h3 id="android" tabindex="-1"><a class="header-anchor" href="#android"><span>Android</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;"> ComponentName</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> startService</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;">IApplicationThread</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> caller</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;">                                  Intent</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> service</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> resolvedType</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;">                                  String</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> callingPackage</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> userId</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    throws RemoteException </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // è·å–æˆ–åˆ›å»º Parcel å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;">    Parcel</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> Parcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">obtain</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;">    Parcel</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> reply</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> Parcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">obtain</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">writeInterfaceToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">IActivityManager</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">descriptor</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">writeStrongBinder</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">caller </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> caller</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">asBinder</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> :</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    service</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">writeToParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // å†™å…¥ Parcel æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">writeString</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">resolvedType</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">writeString</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">callingPackage</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">writeInt</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">userId</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // é€šè¿‡ Binder ä¼ é€’æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    mRemote</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">transact</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">START_SERVICE_TRANSACTION</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // è¯»å–åº”ç­”æ¶ˆæ¯çš„å¼‚å¸¸æƒ…å†µ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">readException</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // æ ¹æ® reply æ•°æ®æ¥åˆ›å»º ComponentName å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;">    ComponentName</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> ComponentName</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">readFromParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">recycle</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">recycle</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> res</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å’Œ JS çš„è¿‡ç¨‹åŸºæœ¬ä¸Šä¸€è‡´ï¼ŒæŒ‘é€‰å…¶ä¸­ä¸€äº›ç»†èŠ‚è¿›è¡Œè¯´æ˜ï¼š</p><p>â¡ï¸â¡ï¸ Parcel.obtain() å®Œæˆäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿä»ç¼“å­˜æ± ä¸­è·å–ä¸€ä¸ª Parcel å¯¹è±¡ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> static</span><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;"> Parcel</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> obtain</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // sOwnedPool ä¸º Parcel å¯¹è±¡çš„ç¼“å­˜æ± </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    final</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;"> Parcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> pool</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> sOwnedPool</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    synchronized</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">pool</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;">        Parcel</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // POOL_SIZE = 6</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">POOL_SIZE</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            p </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> pool</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">p </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">                pool</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> p</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    //å½“ç¼“å­˜æ± æ²¡æœ‰ç°æˆçš„ Parcel å¯¹è±¡ï¼Œåˆ™ç›´æ¥åˆ›å»º</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> Parcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…³äº Parcel å¯¹è±¡çš„åˆ›å»ºï¼Œæˆ‘ä»¬ç•™åˆ° <strong>Pracel</strong> ç« èŠ‚è¿›è¡Œè¯¦ç»†è¯´æ˜ã€‚</p><h3 id="phase-1-summary" tabindex="-1"><a class="header-anchor" href="#phase-1-summary"><span>Phase 1 Summary</span></a></h3><p>ğŸ©¸ğŸ©¸ ä»ä¸Šé¢ä¸Šä¸ªåœºæ™¯çš„ä»£ç åˆ†ææˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸»è¦çš„æ“ä½œè€—æ—¶è¿˜æ˜¯åœ¨ Pracel è¿‡ç¨‹ä¸­ã€‚åœ¨åç»­çš„ç ”ç©¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Pracel å¯¹è±¡çš„åˆ›å»ºå’Œ native world ä¹Ÿæ˜¯æ¯æ¯ç›¸å…³çš„ï¼Œæ‰€ä»¥è¿™ä¸€ä¸ª phase æ˜¯å­˜åœ¨ä¸€äº›ä¼˜åŒ–çš„ç©ºé—´åœ¨çš„ã€‚</p><h2 id="phase-2" tabindex="-1"><a class="header-anchor" href="#phase-2"><span>Phase 2</span></a></h2><p><strong>BpBinder to driver</strong>, è¿™ä¸ªè¿‡ç¨‹ä¸»è¦æ˜¯ä»å®¢æˆ·ç«¯ native åˆ° driver çš„è¿‡ç¨‹ã€‚</p><h3 id="ohos-1" tabindex="-1"><a class="header-anchor" href="#ohos-1"><span>OHOS</span></a></h3><p>ä»ä¸Šæ–‡æˆ‘ä»¬äº†è§£åˆ°ï¼Œå®¢æˆ·ç«¯ä¼šè°ƒç”¨ proxy çš„ sendRequest æ–¹æ³•ï¼Œå¯¹åº”çš„å®ç°å¦‚ä¸‹ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="android-1" tabindex="-1"><a class="header-anchor" href="#android-1"><span>Android</span></a></h3><p>ä»ä¸Šæ–‡æˆ‘ä»¬äº†è§£åˆ°ï¼Œå®¢æˆ·ç«¯è°ƒç”¨åˆ° native æ˜¯é€šè¿‡ mRemote.transact æ¥å®ç°çš„ï¼Œè¯¥æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">final</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;"> BinderProxy</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-light-font-weight:inherit;--shiki-dark:#8FBCBB;--shiki-dark-font-weight:bold;"> IBinder</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> boolean</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> transact</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> code</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;"> Parcel</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;"> Parcel</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        throws</span><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;"> RemoteException</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        //ç”¨äºæ£€æµ‹ Parcel å¤§å°æ˜¯å¦å¤§äº 800k</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        Binder</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">checkParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> code</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">Unreasonably large binder buffer</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // è°ƒç”¨ native</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> transactNative</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªæ–¹æ³•çš„åŠŸèƒ½éå¸¸ç®€å•ï¼Œä¸»è¦å®Œæˆå¯¹ native æ–¹æ³• <strong>transactNative</strong> çš„è°ƒç”¨ã€‚</p><div class="hint-container note"><p class="hint-container-title">transactNative å‚æ•°</p><p>mRemote.transact() æ–¹æ³•ä¸­çš„</p><ul><li>code: START_SERVICE_TRANSACTION,</li><li>data ä¿å­˜ <code>descriptor</code>ï¼Œ<code>caller</code>, <code>intent</code>, <code>resolvedType</code>, <code>callingPackage</code>, <code>userId</code>è¿™ 6 é¡¹ä¿¡æ¯ã€‚</li></ul></div><p>transactNative æ–¹æ³•å¯¹åº”çš„ native å‡½æ•°ä¸º android_os_BinderProxy_transact.</p><blockquote><p>android_util_Binder.cpp</p></blockquote><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> jboolean</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> android_os_BinderProxy_transact</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">JNIEnv</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> jobject</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> obj</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">    jint</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> code</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> jobject</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> dataObj</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> jobject</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> replyObj</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> jint</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    //å°† java Parcel è½¬ä¸º C++ Parcel</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    Parcel</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> data </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> parcelForJavaObject</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> dataObj</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    Parcel</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> reply </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> parcelForJavaObject</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> replyObj</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    //gBinderProxyOffsets.mObject ä¸­ä¿å­˜çš„æ˜¯ new BpBinder(handle) å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    IBinder</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> target </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">IBinder</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetLongField</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">obj</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> gBinderProxyOffsets</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">mObject</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    //æ­¤å¤„ä¾¿æ˜¯ BpBinder::transact()</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">    status_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> target</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">transact</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    //æœ€åæ ¹æ® transact æ‰§è¡Œå…·ä½“æƒ…å†µï¼ŒæŠ›å‡ºç›¸åº”çš„ Exception</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    signalExceptionForError</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> obj</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> err</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> ,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">dataSize</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">())</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> JNI_FALSE</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æŠ›å¼€æ— å…³ç»†èŠ‚ï¼Œä¸»è¦æ˜¯è°ƒç”¨ target-&gt;transact æ–¹æ³•ï¼Œtarget æ˜¯ä¸€ä¸ª BpBinder å¯¹è±¡ï¼š</p><blockquote><p>BpBinder.cpp</p></blockquote><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">status_t</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> BpBinder</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">transact</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    uint32_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> code</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> Parcel</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> Parcel</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> uint32_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">mAlive</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">        status_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> status </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> IPCThreadState</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">transact</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            mHandle</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> code</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">status </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> DEAD_OBJECT</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> mAlive </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> status</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> DEAD_OBJECT</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°å‡½æ•°é‡‡å–äº†å•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿æ¯ä¸ªçº¿ç¨‹åªæœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚ä¸»è¦è¿˜æ˜¯è°ƒç”¨åˆ° IPCThreadState::transact æ–¹æ³•ï¼š</p><blockquote><p>IPCThreadState.cpp</p></blockquote><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">status_t</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> IPCThreadState</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">transact</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int32_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                                  uint32_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> code</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> Parcel</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">                                  Parcel</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> uint32_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">    status_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">errorCheck</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // æ•°æ®é”™è¯¯æ£€æŸ¥</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">|=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TF_ACCEPT_FDS</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ....</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> NO_ERROR</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">         // ä¼ è¾“æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> writeTransactionData</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">BC_TRANSACTION</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> code</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> NO_ERROR</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">setError</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">mLastError </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> err</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // é»˜è®¤æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯é‡‡ç”¨é oneway çš„æ–¹å¼, ä¹Ÿå°±æ˜¯éœ€è¦ç­‰å¾…æœåŠ¡ç«¯çš„è¿”å›ç»“æœã€åŒæ­¥</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> ((</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">flags </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TF_ONE_WAY</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            // reply å¯¹è±¡ä¸ä¸ºç©º</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> waitForResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            Parcel fakeReply</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> waitForResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">fakeReply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> else</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> waitForResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> err</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šå¸¸æƒ…å†µä¸‹ä¼šèµ°åŒæ­¥æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯ onewayã€‚ä¸¤ä¸ªæ¨¡å¼éƒ½ä¼šè°ƒç”¨åˆ° waitForResponse å‡½æ•°ã€‚</p><p>åœ¨çœ‹ waitForResponse å‡½æ•°ä¹‹é—´ï¼Œæˆ‘ä»¬å…ˆç®€å•è¯´æ˜ä¸€ä¸‹ transact çš„ä¸»è¦è¿‡ç¨‹ï¼š</p><p>é¦–å…ˆã€æ‰§è¡Œ writeTransactionDataï¼ˆç¬¬ 10 è¡Œï¼‰å‘ mOut å†™å…¥æ•°æ®ï¼Œæ­¤æ—¶ mIn è¿˜æ²¡æœ‰æ•°æ®ï¼›</p><p>ç„¶åæ‰§è¡Œ waitForResponse æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¾ªç¯æ‰§è¡Œï¼Œç›´åˆ°æ”¶åˆ°åº”ç­”æ¶ˆæ¯ï¼Œæ­¤é—´è°ƒç”¨ talkWithDriver å’Œé©±åŠ¨äº¤äº’ï¼Œæ”¶åˆ°åº”ç­”æ¶ˆæ¯åå†™å…¥ mIn, æ ¹æ®å“åº”ç åˆ†ç±»æ“ä½œã€‚</p><p>å¦‚æœæˆ‘ä»¬ä¸å†å¾€ä¸‹ç ”ç©¶çš„è¯ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯è§†è§’ä¸‹çš„é€šä¿¡å·²ç»å®Œæˆäº†ï¼Œè€Œæˆ‘ä»¬çš„ phase 2 å°±æ˜¯åˆ°æ­¤ä¸ºæ­¢ã€‚</p><p>writeTransactionData çš„å®ç°å¤§è‡´å¦‚ä¸‹ï¼š</p><blockquote><p>IPCThreadState.cpp</p></blockquote><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">status_t</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> IPCThreadState</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">writeTransactionData</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int32_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> uint32_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> binderFlags</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    int32_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> uint32_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> code</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> Parcel</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;"> status_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> statusBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    binder_transaction_data tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">target</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ptr</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">target</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">handle</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // handle æŒ‡å‘ AMS</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">code</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> code</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            // START_SERVICE_TRANSACTION</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">flags</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binderFlags</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">cookie</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">sender_pid</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">sender_euid</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;"> status_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">errorCheck</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> NO_ERROR</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // data ä¸º startService ç›¸å…³ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">ipcDataSize</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">   // mDataSize</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">ipcData</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // mData æŒ‡é’ˆ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">offsets_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">ipcObjectsCount</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">binder_size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // mObjectsSize</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">offsets</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">ipcObjects</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // mObjects æŒ‡é’ˆ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    mOut</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">writeInt32</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">         // cmd = BC_TRANSACTION</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    mOut</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // å†™å…¥ binder_transaction_dataæ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> NO_ERROR</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>23-24 è¡Œå°†æ•°æ®å†™å…¥äº† mOut, å†™å…¥çš„ç±»å‹æ˜¯ binder_transaction_data ç±»å‹ã€‚</p><p>waitForResponse çš„å®ç°å¤§æ¦‚å¦‚ä¸‹ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">status_t</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> IPCThreadState</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">waitForResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">Parcel</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;"> status_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">acquireResult</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    int32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    int32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> err</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> ((</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">err</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">talkWithDriver</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">())</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> NO_ERROR</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> mIn</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">errorCheck</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> NO_ERROR</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> //å½“å­˜åœ¨ error åˆ™é€€å‡ºå¾ªç¯</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">         //æ¯å½“è·Ÿ Driver äº¤äº’ä¸€æ¬¡ï¼Œè‹¥ mIn æ”¶åˆ°æ•°æ®åˆ™å¾€ä¸‹æ‰§è¡Œä¸€æ¬¡ BR å‘½ä»¤</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">mIn</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">dataAvail</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> continue</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        cmd </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> mIn</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">readInt32</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        switch</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BR_TRANSACTION_COMPLETE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            //åªæœ‰å½“ä¸éœ€è¦ reply, ä¹Ÿå°±æ˜¯ oneway æ—¶æ‰ä¼šè·³å‡ºå¾ªç¯,å¦åˆ™è¿˜éœ€è¦ç­‰å¾….</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">reply </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">acquireResult</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> goto</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> finish</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BR_DEAD_REPLY</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> DEAD_OBJECT</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">         goto</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> finish</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BR_FAILED_REPLY</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> FAILED_TRANSACTION</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  goto</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> finish</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BR_REPLY</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> ...             </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">goto</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> finish</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        default</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> executeCommand</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> NO_ERROR</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> goto</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> finish</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">finish</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> NO_ERROR</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">setError</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // å°†å‘é€çš„é”™è¯¯ä»£ç è¿”å›ç»™æœ€åˆçš„è°ƒç”¨è€…</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> err</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œé¢åˆå¼•å…¥äº†å…³é”®çš„æ“ä½œï¼štalkWithDriver å’Œ executeCommand;</p><p>è¿™ä¸¤è€…çš„åŠŸèƒ½æ˜¯ï¼šæ‰§è¡Œ binder è¯»å†™æ“ä½œï¼Œä¹Ÿå°±æ˜¯ BINDER_WRITE_READ, ä¼šç»è¿‡ syscall, è¿›å…¥ Binder é©±åŠ¨ï¼Œè°ƒç”¨é©±åŠ¨ä¸­çš„ binder_ioctl å‡½æ•°ã€‚åœ¨ default çš„æƒ…å†µä¸‹ï¼Œä¼šè°ƒç”¨åè€…ï¼›å…¶ä»–æƒ…å†µä¸‹æ˜¯åœ¨ talkWithDriver å¯¹ executeCommand è¿›è¡Œè°ƒç”¨ã€‚</p><p>OKï¼ŒPhase 2 åˆ°æ­¤ä¸ºæ­¢ã€‚</p><h3 id="phase-2-summary" tabindex="-1"><a class="header-anchor" href="#phase-2-summary"><span>Phase 2 Summary</span></a></h3><p>æ€»ç»“ä¸€ä¸‹ï¼ŒBpBinder åˆ° Binder Driver åšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ‰¾åˆ° native å±‚çš„æ–¹æ³•ï¼Œ</p>`,60)]))}const E=i(l,[["render",k]]),r=JSON.parse('{"path":"/java/android/binder_01.html","title":"Binder Phases","lang":"zh-CN","frontmatter":{"title":"Binder Phases","date":"2023-06-25T00:00:00.000Z","tag":["kernel","Android","Binder"],"category":["Android"],"description":"æœ¬æ–‡ä¸»è¦è®²è¿° Binder æµç¨‹ä¸­çš„å„ä¸ªé˜¶æ®µï¼Œèµ·åˆ°ä¸€ä¸ª Overview çš„ç›®çš„ã€‚","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Binder Phases\\",\\"image\\":[\\"http://gityuan.com/images/binder/binder_start_service/binder_ipc_arch.jpg\\"],\\"datePublished\\":\\"2023-06-25T00:00:00.000Z\\",\\"dateModified\\":\\"2023-06-25T13:51:28.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Someone\\",\\"url\\":\\"https://www.weigao.cc\\"}]}"],["meta",{"property":"og:url","content":"https://vueblog.weigao.cc/java/android/binder_01.html"}],["meta",{"property":"og:site_name","content":"weigao"}],["meta",{"property":"og:title","content":"Binder Phases"}],["meta",{"property":"og:description","content":"æœ¬æ–‡ä¸»è¦è®²è¿° Binder æµç¨‹ä¸­çš„å„ä¸ªé˜¶æ®µï¼Œèµ·åˆ°ä¸€ä¸ª Overview çš„ç›®çš„ã€‚"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"http://gityuan.com/images/binder/binder_start_service/binder_ipc_arch.jpg"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2023-06-25T13:51:28.000Z"}],["meta",{"property":"article:tag","content":"Binder"}],["meta",{"property":"article:tag","content":"Android"}],["meta",{"property":"article:tag","content":"kernel"}],["meta",{"property":"article:published_time","content":"2023-06-25T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2023-06-25T13:51:28.000Z"}]]},"git":{"createdTime":1687687665000,"updatedTime":1687701088000,"contributors":[{"name":"weigao chen","username":"","email":"weigao_1995@yeah.net","commits":1},{"name":"chenweigao","username":"chenweigao","email":"297859260@qq.com","commits":1,"url":"https://github.com/chenweigao"}]},"readingTime":{"minutes":6.23,"words":1868},"filePathRelative":"java/android/binder_01.md","excerpt":"<p>æœ¬æ–‡ä¸»è¦è®²è¿° Binder æµç¨‹ä¸­çš„å„ä¸ªé˜¶æ®µï¼Œèµ·åˆ°ä¸€ä¸ª Overview çš„ç›®çš„ã€‚</p>\\n","autoDesc":true}');export{E as comp,r as data};
