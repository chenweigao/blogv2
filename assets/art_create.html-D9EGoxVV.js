import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,d as n,o as h}from"./app-11Vuyqh7.js";const k={};function t(l,s){return h(),a("div",null,s[0]||(s[0]=[n(`<h2 id="abstract" tabindex="-1"><a class="header-anchor" href="#abstract"><span>Abstract</span></a></h2><p>Art 的创建过程是一个很复杂的命题，所以我们单独开设一章来对这个过程进行学习。</p><p>@todo 增加全局的流程图。</p><h2 id="art-create" tabindex="-1"><a class="header-anchor" href="#art-create"><span>Art Create</span></a></h2><h3 id="jni-createjavavm" tabindex="-1"><a class="header-anchor" href="#jni-createjavavm"><span>JNI_CreateJavaVM</span></a></h3><p>当我们选择了 ART 运行时, Zygote 进程在启动过程中，会调用 <code>libart.so</code> 里面的函数 <code>JNI_CreateVM</code> 来<strong>创建一个 art 虚拟机</strong>，这个函数的实现如下：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// art/runtime/jni/java_vm_ext.cc</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// JNI Invocation interface.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">extern </span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">C</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> jint </span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">JNI_CreateJavaVM</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">JavaVM</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">**</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> p_vm</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> JNIEnv</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">**</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> p_env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> vm_args</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;">  ScopedTrace</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> trace</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">__FUNCTION__</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> JavaVMInitArgs</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> args </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> static_cast</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">JavaVMInitArgs</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">vm_args</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">JavaVMExt</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">IsBadJniVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">args</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    LOG</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ERROR</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">Bad JNI version passed to CreateJavaVM: </span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> args</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> JNI_EVERSION</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;">  RuntimeOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> options</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> args</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">nOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ++</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    JavaVMOption</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> option </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">args</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    options</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">push_back</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">std</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">make_pair</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">std</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">option</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">optionString</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> option</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">extraInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  bool ignore_unrecognized </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> args</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ignoreUnrecognized</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">Runtime</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Create</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> ignore_unrecognized</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> JNI_ERR</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // Initialize native loader. This step makes sure we have</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // everything set up before we start using JNI.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  android</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">InitializeNativeLoader</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  Runtime</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> runtime </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> Runtime</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Current</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  bool started </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> runtime</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Start</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">started</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    delete Thread</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Current</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetJniEnv</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    delete runtime</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetJavaVM</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    LOG</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">WARNING</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">CreateJavaVM failed</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> JNI_ERR</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  *</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">p_env </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> Thread</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Current</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetJniEnv</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  *</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">p_vm </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> runtime</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetJavaVM</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> JNI_OK</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个函数不长，其核心的代码是调用 <code>Runtime::Create</code> 来进行虚拟机创建；在创建之前，将参数 <code>vm_args</code> 转换为 <code>JavaVMInitArgs</code> 对象，按照 key-value 的形式保存在 <code>JavaVMOption</code> 中，并以该向量作为传入传递给 <code>Runtime::Create</code> 来创建虚拟机。</p><h3 id="runtime-create" tabindex="-1"><a class="header-anchor" href="#runtime-create"><span>Runtime::Create</span></a></h3><p><code>Runtime::Create</code> 的实现如下所示：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// art/runtime/runtime.cc</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">bool Runtime</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Create</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">RuntimeArgumentMap</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> runtime_options</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // TODO: acquire a static mutex on Runtime to avoid racing.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">Runtime</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">instance_ </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  instance_ </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> Runtime</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  Locks</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">SetClientCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">IsSafeToCallAbort</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">instance_</span><span style="--shiki-light:#D73A49;--shiki-dark:#8FBCBB;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Init</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">std</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">move</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">runtime_options</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // TODO: Currently deleting the instance will abort the runtime on destruction. Now This will</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // leak memory, instead. Fix the destructor. b/19100793.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // delete instance_;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    instance_ </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">bool Runtime</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Create</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> RuntimeOptions</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> raw_options</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> bool ignore_unrecognized</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;">  RuntimeArgumentMap</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> runtime_options</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> ParseOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">raw_options</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> ignore_unrecognized</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">runtime_options</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">      Create</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">std</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">move</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">runtime_options</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面列举了两个函数，做了参数重载，其实还是调用到了第一个函数。<code>instance_</code> 是 Runtime 类的静态成员变量，指向进程中的一个 Runtime 单例，这个单例就是描述当前进程的 art 虚拟机实例；第 5 行判断了这个实例是否已经存在了（即当前进程是否已经创建有一个 ART 虚拟机实例），如果已有的话，函数返回，否则的话，创建一个 art 虚拟机实例（第 8 行），创建的实例保存在静态成员变量 <code>instance_</code> 中，然后调用 Runtime 类的成员函数 <code>Init()</code> 对新创建的 art 虚拟机进行初始化。</p><h3 id="runtime-init" tabindex="-1"><a class="header-anchor" href="#runtime-init"><span>Runtime::Init()</span></a></h3><p><code>Runtime::Init()</code> 的实现如下所示：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// art/runtime/runtime.cc</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">bool Runtime</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Init</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">RuntimeArgumentMap</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> runtime_options_in</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于这个函数 700 多行，所以就不在这边列举源码了<sup class="footnote-ref"><a href="#footnote1">[1]</a><a class="footnote-anchor" id="footnote-ref1"></a></sup>。</p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="footnote1" class="footnote-item"><p><a href="https://blog.csdn.net/Luoshengyang/article/details/39307813" target="_blank" rel="noopener noreferrer">Android运行时ART加载OAT文件的过程分析</a> <a href="#footnote-ref1" class="footnote-backref">↩︎</a></p></li></ol></section>`,18)]))}const r=i(k,[["render",t]]),E=JSON.parse('{"path":"/java/art/art_create.html","title":"ART Create","lang":"zh-CN","frontmatter":{"title":"ART Create","date":"2022-10-28T00:00:00.000Z","tag":["jvm","java"],"category":["JAVA"],"description":"Abstract Art 的创建过程是一个很复杂的命题，所以我们单独开设一章来对这个过程进行学习。 @todo 增加全局的流程图。 Art Create JNI_CreateJavaVM 当我们选择了 ART 运行时, Zygote 进程在启动过程中，会调用 libart.so 里面的函数 JNI_CreateVM 来创建一个 art 虚拟机，这个函数...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"ART Create\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2022-10-28T00:00:00.000Z\\",\\"dateModified\\":\\"2024-12-14T07:57:48.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Someone\\",\\"url\\":\\"https://www.weigao.cc\\"}]}"],["meta",{"property":"og:url","content":"https://vueblog.weigao.cc/java/art/art_create.html"}],["meta",{"property":"og:site_name","content":"weigao"}],["meta",{"property":"og:title","content":"ART Create"}],["meta",{"property":"og:description","content":"Abstract Art 的创建过程是一个很复杂的命题，所以我们单独开设一章来对这个过程进行学习。 @todo 增加全局的流程图。 Art Create JNI_CreateJavaVM 当我们选择了 ART 运行时, Zygote 进程在启动过程中，会调用 libart.so 里面的函数 JNI_CreateVM 来创建一个 art 虚拟机，这个函数..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-12-14T07:57:48.000Z"}],["meta",{"property":"article:tag","content":"java"}],["meta",{"property":"article:tag","content":"jvm"}],["meta",{"property":"article:published_time","content":"2022-10-28T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-12-14T07:57:48.000Z"}]]},"git":{"createdTime":1666939483000,"updatedTime":1734163068000,"contributors":[{"name":"weigao chen","username":"","email":"weigao_1995@yeah.net","commits":2},{"name":"chenweigao","username":"chenweigao","email":"297859260@qq.com","commits":2,"url":"https://github.com/chenweigao"},{"name":"weigao","username":"weigao","email":"weigao.cwg","commits":1,"url":"https://github.com/weigao"}]},"readingTime":{"minutes":2.15,"words":645},"filePathRelative":"java/art/art_create.md","excerpt":"<h2>Abstract</h2>\\n<p>Art 的创建过程是一个很复杂的命题，所以我们单独开设一章来对这个过程进行学习。</p>\\n<p>@todo 增加全局的流程图。</p>\\n<h2>Art Create</h2>\\n<h3>JNI_CreateJavaVM</h3>\\n<p>当我们选择了 ART 运行时, Zygote 进程在启动过程中，会调用 <code>libart.so</code> 里面的函数 <code>JNI_CreateVM</code> 来<strong>创建一个 art 虚拟机</strong>，这个函数的实现如下：</p>\\n<div class=\\"language-java line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"java\\" style=\\"--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff\\"><pre class=\\"shiki shiki-themes github-light nord vp-code\\"><code><span class=\\"line\\"><span style=\\"--shiki-light:#6A737D;--shiki-dark:#616E88\\">// art/runtime/jni/java_vm_ext.cc</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6A737D;--shiki-dark:#616E88\\">// JNI Invocation interface.</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">extern </span><span style=\\"--shiki-light:#032F62;--shiki-dark:#ECEFF4\\">\\"</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\">C</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#ECEFF4\\">\\"</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> jint </span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">JNI_CreateJavaVM</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">JavaVM</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">**</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> p_vm</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">,</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> JNIEnv</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">**</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> p_env</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">,</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\"> void*</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> vm_args</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\"> {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#8FBCBB\\">  ScopedTrace</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\"> trace</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">__FUNCTION__</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">  const</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> JavaVMInitArgs</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">*</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> args </span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">=</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> static_cast</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">&lt;</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">JavaVMInitArgs</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">*&gt;</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">vm_args</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">  if</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\"> (</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">JavaVMExt</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">::</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">IsBadJniVersion</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">args</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#8FBCBB\\">-&gt;</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">version</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">))</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\"> {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">    LOG</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">ERROR</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\"> &lt;&lt;</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#ECEFF4\\"> \\"</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\">Bad JNI version passed to CreateJavaVM: </span><span style=\\"--shiki-light:#032F62;--shiki-dark:#ECEFF4\\">\\"</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\"> &lt;&lt;</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> args</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#8FBCBB\\">-&gt;</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">version</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">    return</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> JNI_EVERSION</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">  }</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#8FBCBB\\">  RuntimeOptions</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9\\"> options</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">  for</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\"> (</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">int</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9\\"> i</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\"> =</span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#B48EAD\\"> 0</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> i </span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">&lt;</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> args</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#8FBCBB\\">-&gt;</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">nOptions</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\"> ++</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">i</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\"> {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">    JavaVMOption</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">*</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> option </span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">=</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\"> &amp;</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">args</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#8FBCBB\\">-&gt;</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">options</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">[</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">i</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">]</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9\\">    options</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">.</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">push_back</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">std</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">::</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">make_pair</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">std</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">::</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">string</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">option</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#8FBCBB\\">-&gt;</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">optionString</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">),</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> option</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#8FBCBB\\">-&gt;</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">extraInfo</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">))</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">  }</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">  bool ignore_unrecognized </span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">=</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> args</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#8FBCBB\\">-&gt;</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">ignoreUnrecognized</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">  if</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\"> (</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">!</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">Runtime</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">::</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">Create</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">options</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">,</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> ignore_unrecognized</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">))</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\"> {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">    return</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> JNI_ERR</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">  }</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6A737D;--shiki-dark:#616E88\\">  // Initialize native loader. This step makes sure we have</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6A737D;--shiki-dark:#616E88\\">  // everything set up before we start using JNI.</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">  android</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">::</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">InitializeNativeLoader</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">()</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">  Runtime</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">*</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> runtime </span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">=</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> Runtime</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">::</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">Current</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">()</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">  bool started </span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">=</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> runtime</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#8FBCBB\\">-&gt;</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">Start</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">()</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">  if</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\"> (</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">!</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">started</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\"> {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">    delete Thread</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">::</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">Current</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">()</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#8FBCBB\\">-&gt;</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">GetJniEnv</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">()</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">    delete runtime</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#8FBCBB\\">-&gt;</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">GetJavaVM</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">()</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">    LOG</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">(</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">WARNING</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">)</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\"> &lt;&lt;</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#ECEFF4\\"> \\"</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\">CreateJavaVM failed</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#ECEFF4\\">\\"</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">    return</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> JNI_ERR</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">  }</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">  *</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">p_env </span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">=</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> Thread</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">::</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">Current</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">()</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#8FBCBB\\">-&gt;</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">GetJniEnv</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">()</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">  *</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\">p_vm </span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">=</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> runtime</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#8FBCBB\\">-&gt;</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">GetJavaVM</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">()</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#81A1C1\\">  return</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#D8DEE9FF\\"> JNI_OK</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#81A1C1\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#ECEFF4\\">}</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{r as comp,E as data};
