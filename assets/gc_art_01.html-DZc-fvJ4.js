import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as t,d as r,o}from"./app-11Vuyqh7.js";const i={};function c(n,e){return o(),t("div",null,e[0]||(e[0]=[r('<p>æœ¬ç¯‡æ–‡ç« é¦–å…ˆå¯¹ JAVA Art ä¸­çš„ GC è¿›è¡Œä¸€ä¸ªå…¨å±€æ€§çš„æ¦‚è§ˆï¼Œåç»­å¦‚æœè¦ç ”ç©¶æŠ€æœ¯ç»†èŠ‚ç­‰ï¼Œå†å¦èµ·æ–°çš„æ–‡ç« è¿›è¡Œé‡ç‚¹ç ”ç©¶ã€‚</p><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>æœ¬ç¯‡ä¸»è¦ç ”ç©¶ ConcurrentCopying GC çš„æŠ€æœ¯ç»†èŠ‚ã€‚</p></div><h2 id="_1-forwarding-ptr" tabindex="-1"><a class="header-anchor" href="#_1-forwarding-ptr"><span>1. Forwarding Ptr</span></a></h2><p>åœ¨ art è™šæ‹Ÿæœºä¸­ï¼ŒFW Ptr æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œé€šå¸¸åœ¨ &quot;mark and sweep&quot; phase ä¸­ä½¿ç”¨ã€‚</p><p>æ•´ä¸ªè¿‡ç¨‹çš„æè¿°å¤§è‡´ä¸ºï¼Œgc collector æ‰«æå­˜æ´»å¯¹è±¡å’Œå…¶å¼•ç”¨çš„å¯¹è±¡ï¼Œç¡®å®šè¿™äº›å¯¹è±¡åº”è¯¥ç»§ç»­å­˜æ´»è¿˜æ˜¯è¢«å›æ”¶ï¼Œåœ¨ mark phase å®Œæˆä»¥åï¼Œgc collector å¼€å§‹ &quot;sweep&quot; phase, åœ¨è¿™ä¸ª phase ä¸­ï¼Œä¼šå›æ”¶é‚£äº›å †ä¸­æ²¡æœ‰è¢« &quot;mark&quot; çš„å¯¹è±¡ï¼ˆè¿™äº›å¯¹è±¡ä¸ä¼šå†è¢«ä½¿ç”¨äº†ï¼‰ï¼›</p><p>ä¸Šé¢çš„è¿‡ç¨‹ä¸­ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ mark phase ä¸­è¢« mark çš„å¯¹è±¡å¦‚æœåœ¨æ­¤æœŸé—´è¢«ç§»åŠ¨åˆ°äº†ä¸€ä¸ªæ–°çš„å†…å­˜ä½ç½®ï¼Œgc å°†ä¼šç»™è¿™ä¸ªå¯¹è±¡è®¾ç½®ä¸€ä¸ª forwading address, ç”¨äºè¡¨ç¤ºå¯¹è±¡ç§»åŠ¨åˆ°çš„æ–°çš„å†…å­˜åœ°å€ï¼›</p><p>æ¥ä¸‹æ¥ï¼Œgc collector è¿›è¡Œå¼•ç”¨è®¡æ•°çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¯»å–å¯¹è±¡çš„ forwarding address, å¦‚æ­¤ç¡®ä¿å¯¹è±¡çš„åœ°å€æ˜¯æ­£ç¡®çš„ï¼Œå³ä½¿å¯¹è±¡å‘ç”Ÿäº†ç§»åŠ¨ã€‚</p><p>å¯¹äºä¸Šé¢æ‰€è¯´çš„<strong>å¯¹è±¡å‘ç”Ÿç§»åŠ¨</strong>ï¼Œåœ¨ä¸åŒçš„ gc collector ä¸­çš„å®ç°éƒ½æ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚æˆ‘ä»¬é‡ç‚¹ç ”ç©¶çš„ CC GC, å…¶æŠŠå¯¹è±¡ä» <em>from_space</em> copy åˆ° <em>to_space</em> çš„è¿‡ç¨‹ï¼Œå°±æ˜¯å‘ç”Ÿäº†å¯¹è±¡çš„ç§»åŠ¨ã€‚å¯¹äºåœ¨ CC GC ä¸­ï¼ˆæˆ–è€…ç›¸ä¼¼çš„åŸºäº copy çš„ GCï¼‰ï¼ŒFW Ptr çš„åº”ç”¨å¯èƒ½æ˜¯é€šè¿‡ä»¥ä¸‹æ­¥éª¤çš„ï¼š</p><ol><li>åœ¨ <em>to_space</em> ä¸­ä¸ºéœ€è¦æ‹·è´çš„å¯¹è±¡åˆ†é…ä¸€ä¸ªæ–°çš„ block, æˆ–è€…åˆ†é…ä¸€ä¸ªå†…å­˜ï¼Œè¯¥è¿‡ç¨‹å®Œæˆåè¿”å› <code>to_ref</code> çš„åœ°å€ï¼›</li><li>collector traverses å¯¹è±¡å›¾ï¼Œæ‰¾åˆ° <em>from_space</em> ä¸­çš„å­˜æ´»å¯¹è±¡ï¼Œå¹¶ä¸”è¿›è¡Œ &quot;mark&quot;;</li><li>åœ¨ traverse è¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠ <em>from_space</em> ä¸­çš„å­˜æ´»å¯¹è±¡ copy åˆ° <em>to_space</em> ä¸­ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çš„ forwarding address å°±ç”Ÿæ•ˆäº†ï¼Œåœ¨æ‹·è´çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»™ <code>from_ref</code> è®¾ç½®ä¸€ä¸ª FW Ptr, æŒ‡å‘ <code>to_ref</code>;</li><li>å¦‚æœè¦å‘ç”Ÿå¯¹è±¡çš„ä¿®æ”¹ã€æ›´æ–°æˆ–è€…æ‹·è´ï¼Œåˆ™éƒ½ä¼šä½¿ç”¨æ–°çš„ forwarding address;</li><li>æœ€åå°±æ˜¯ <em>from_space</em> çš„é‡Šæ”¾ç­‰æ“ä½œã€‚</li></ol><h2 id="_2-read-barrier-in-art-gc" tabindex="-1"><a class="header-anchor" href="#_2-read-barrier-in-art-gc"><span>2. Read Barrier in Art GC</span></a></h2><p>Art ä¸­ Read Barrier çš„ä½œç”¨æ˜¯ï¼šåœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œç”¨æ¥ç¡®ä¿çº¿ç¨‹çœ‹åˆ°æœ€æ–°çš„å¯¹è±¡çš„å€¼ã€‚</p><p>å½“ä¸€ä¸ªçº¿ç¨‹è¯»å–ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ° read barrier çš„ intrinsic method, è¿™ä¸ªæ–¹æ³•ç”¨äº check è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨(the reference points to an object) æ˜¯å¦æ­£åœ¨è¢«ç§»åŠ¨æˆ–è€…è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨æŒ‡å‘ä¸€ä¸ª fordwarding addressï¼Œå¦‚æœ reference æŒ‡å‘æ­£åœ¨è¢«ç§»åŠ¨çš„å¯¹è±¡ï¼Œè¯¥æ–¹æ³•ç­‰å¾…å¯¹è±¡ç§»åŠ¨å®Œæ¯•ç„¶åæ›´æ–°å…¶å¼•ç”¨åˆ°æ–°çš„ä½ç½®ï¼›å¦‚æœ reference æŒ‡å‘ä¸€ä¸ª forwarding address, åˆ™è¿™ä¸ªæ–¹æ³•æ›´æ–°å¼•ç”¨åˆ°æ–°çš„ä½ç½®ã€‚</p><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œå¼•ç”¨ä¸€æ®µè‹±æ–‡åŸæ–‡ï¼š</p><blockquote><p>When a thread reads from a reference to an object, the read barrier intrinsic method is called. The method checks whether the reference points to an object in the process of <strong>being moved</strong>, or whether the reference <strong>points to a forwarding address</strong>. If the reference points to an object in the process of being moved, the method <strong>waits</strong> until the move is completed and then updates the reference to point to the new location. If the reference points to a forwarding address, the method updates the reference to point to the new location.</p></blockquote></div><p>åœ¨ä¸Šè¿°çš„è§£é‡Šä¸­ï¼Œæˆ‘ä»¬æåˆ°äº†ä¸€ä¸ªå¯¹è±¡ &quot;be moved&quot;, é‚£ä¹ˆå¦‚ä½•ç¡®å®šå¯¹è±¡æ˜¯å¤„äºè¿™ä¸ªçŠ¶æ€çš„å‘¢ï¼Ÿæˆ‘ä»¬ä½¿ç”¨äº† forwarding address, å¦‚æœä¸€ä¸ªå¯¹è±¡è¢«ç§»åŠ¨äº†ï¼Œé‚£ä¹ˆ forwaring address å°±ä¼šè¢«åˆ›å»ºã€‚</p><p>æˆ‘ä»¬ç°åœ¨éœ€è¦è”ç³» read barrier å’Œ marking phaseï¼Œcopying phase ä¹‹é—´çš„å…³ç³»ï¼š</p><ul><li>åœ¨ marking phase ä¸­ï¼Œread barrier æ— éœ€ä½¿èƒ½ï¼Œå› ä¸ºè¯¥ phase ä¸å‘ç”Ÿå¯¹è±¡çš„ copy or move;</li><li>åœ¨ copying phase ä¸­ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ï¼š <ul><li>å¦‚æœä¸€ä¸ªçº¿ç¨‹è¯»å–åˆ°çš„å¯¹è±¡çš„å¼•ç”¨(reference to an object) æ­£åœ¨è¢« copy, read barrier å°†ç­‰å¾…å¯¹è±¡æ‹·è´å®Œæˆï¼Œä¹‹åå†è¿›è¡Œå¼•ç”¨çš„æ›´æ–°ï¼›</li><li>ä¸Šè¿°ç­‰å¾…çš„å®ç°ç§°ä½œ&quot;thread suspension&quot;, è¯¥æŠ€æœ¯å…è®¸ art gc æš‚æ—¶åœ°æš‚åœçº¿ç¨‹ï¼ˆè¿™ä¸ªçº¿ç¨‹æ­¤æ—¶è®¿é—®æ­£åœ¨æ‹·è´çš„å¯¹è±¡çš„å¼•ç”¨ï¼‰</li></ul></li></ul><h2 id="_3-concepts" tabindex="-1"><a class="header-anchor" href="#_3-concepts"><span>3. Concepts</span></a></h2><h3 id="_3-1-reference-of-object" tabindex="-1"><a class="header-anchor" href="#_3-1-reference-of-object"><span>3.1. reference of object</span></a></h3><p>â“â“å¦‚ä½•ç†è§£ reference of object?</p><p>ğŸ’šé€šå¸¸çš„æ¦‚å¿µå¦‚ä¸‹ï¼š</p><ol><li>ä¸€ä¸ªå¯¹è±¡åˆ›å»ºåï¼Œä¼šåœ¨å †ä¸Šä¸ºå…¶åˆ†é…å†…å­˜ï¼Œthe reference of this objct å°±æ˜¯è¿™å—å†…å­˜ï¼›æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å˜é‡ã€è¡¨è¾¾å¼æ¥è¡¨ç¤ºæŒ‡å‘è¿™ä¸ªå¯¹è±¡å­˜å‚¨å†…å­˜çš„ä½ç½®ï¼›</li><li>åœ¨å¸¸è§çš„ç¼–ç¨‹è¯­è¨€ä¸­ï¼ŒObject é€šå¸¸ç”¨ reference æ¥è¡¨ç¤ºï¼›ä¸€ä¸ª reference å¯ä»¥èµ‹å€¼ç»™å˜é‡ï¼ŒæŒ‰ç…§å‡½æ•°å‚æ•°ä¼ é€’ï¼Œæˆ–è€…å­˜å‚¨åœ¨æ•°æ®ç»“æ„ä¸­ï¼›</li><li>é€šå¸¸ reference åŒ…å«å†…å­˜åœ°å€æˆ–è€…æŒ‡å‘å¯¹è±¡å†…å­˜ä½ç½®çš„æŒ‡é’ˆï¼›ç¨‹åºéœ€è¦è®¿é—® Object çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ reference å®ç°ï¼›</li><li>é€šå¸¸ reference ç”± runtime æˆ–è€…è™šæ‹Ÿæœºç®¡ç†ï¼Œä»–ä»¬è´Ÿè´£è¿½è¸ªå¯¹è±¡çš„ reference, æˆ–è€…åˆ†é…ã€é‡Šæ”¾å†…å­˜ï¼›</li></ol><p>ğŸ§¡åœ¨ GC ä¸­çš„ reference:</p><ol><li>åœ¨ GC ä¸­ï¼Œreference é€šå¸¸ç”¨æ¥ç¡®å®šå“ªä¸ªå¯¹è±¡æ­£åœ¨è¢«ä½¿ç”¨æˆ–è€…å“ªä¸ªå¯¹è±¡å¯ä»¥å®‰å…¨åœ°è¢«é‡Šæ”¾ï¼›</li><li>GC collector è¿½è¸ªæ‰€æœ‰å¯¹è±¡çš„ reference(references to object), å¹¶ä¸”å¯ä»¥è¯†åˆ«åœ¨ç¨‹åºè¿è¡ŒæœŸé—´å“ªä¸ªå¯¹è±¡æ˜¯å¯è¾¾çš„ï¼Œä¸å¯è¾¾å¯¹è±¡åœ¨ GC ä¸­è¢«è§†ä¸ºåƒåœ¾ï¼›</li></ol><p>ğŸ’›ä¸€ä¸ªå¯¹è±¡å¼•ç”¨äº†å…¶ä»–å¯¹è±¡å¦‚ä½•ç†è§£ï¼Ÿåœ¨ ART ä¸­çš„å†…å­˜å¸ƒå±€åˆæ˜¯å¦‚ä½•çš„å‘¢ï¼Ÿ</p><ol><li>é¦–å…ˆï¼Œåœ¨ ART çš„ context ä¸­ï¼Œobject reference çš„å«ä¹‰æ˜¯ï¼š<em>A variable or field that holds a reference to another object</em>;</li><li>å¦‚æœä¸€ä¸ª object æŒæœ‰å¦ä¸€ä¸ª object çš„ reference, é‚£å°±æ„å‘³ç€å‰è€…å¯ä»¥è®¿é—®ã€ä¿®æ”¹åè€…çš„æ•°æ®ï¼›</li><li>åŸºäºç¬¬ 2 ç‚¹ï¼Œåœ¨ GC ä¸­ï¼Œå¦‚æœä¸€ä¸ª object æŒæœ‰å¦ä¸€ä¸ª object çš„ reference, åˆ™åœ¨å›æ”¶è¯¥å¯¹è±¡çš„æ—¶å€™ï¼Œå¿…é¡»ç¡®å®šå…¶å¼•ç”¨çš„å¯¹è±¡ä¸ä¼šè¢«æ„å¤–å›æ”¶ï¼ˆå¦‚æœå…¶å¼•ç”¨çš„å¯¹è±¡è¿˜åœ¨è¢«ä½¿ç”¨çš„è¯ï¼‰ï¼›</li><li>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒART å¼•å…¥äº† read barrier æœºåˆ¶ï¼›</li></ol><h2 id="_4-colors-in-gc" tabindex="-1"><a class="header-anchor" href="#_4-colors-in-gc"><span>4. Colors in GC</span></a></h2><h3 id="_4-1-overview" tabindex="-1"><a class="header-anchor" href="#_4-1-overview"><span>4.1. Overview</span></a></h3><p>GC ä¸­çš„æŸ“è‰²ç”¨æ¥è¡¨å¾åˆ°å †ä¸­å¯¹è±¡çš„çŠ¶æ€ï¼šbe terms used to refer to the current state of objects in the heap.</p><p>âšªâšªâšª White: not reachable by the programmer, can be safely GC;</p><p>ğŸŸ¤ğŸŸ¤ğŸŸ¤ Gray: objects that have been discovered by the GC algorithm as potentially reachable, but have not yet been fully processed;</p><p>âš«âš«âš« Black: objects that have been fully processed by the GC algorithm and are guaranteed to be reachable by the program;</p><p>å† mark-and-sweap phase ä¸­ï¼Œheap çš„åˆå§‹çŠ¶æ€éƒ½è¢«å‡å®šä¸ºå®Œå…¨çš„ White, GC ä» root èŠ‚ç‚¹å¼€å§‹(set æ•°æ®ç»“æ„) å¹¶ä¸”å°†å¯è¾¾å¯¹è±¡æ ‡è®°ä¸º Gray, ç„¶åéå† Gray å¯¹è±¡ï¼Œå°†å…¶å¼•ç”¨çš„å¯¹è±¡ä¹Ÿæ ‡è®°ä¸º Gray (any objects they reference); å½“ä¸€ä¸ªå¯¹è±¡å’Œå…¶æœ¬èº«å¼•ç”¨çš„å¯¹è±¡éƒ½è¢«æ ‡è®°å®Œæˆä»¥åï¼Œå°†å…¶æ ‡è®°ä¸º Black.</p><p>æœ€åï¼Œä»»ä½•ç•™ä¸‹æ¥çš„ White å¯¹è±¡éƒ½å°†è¢«åƒåœ¾å›æ”¶ã€‚</p><h3 id="_4-2-cc-gc-colors" tabindex="-1"><a class="header-anchor" href="#_4-2-cc-gc-colors"><span>4.2. CC GC colors</span></a></h3><p>åœ¨ CC GC ä¸­ï¼Œå…¶å®ç°ç›¸æ¯”äºä¼ ç»Ÿçš„æŸ“è‰²ç®—æ³•æ›´åŠ å¤æ‚ä¸€äº›ï¼Œæˆ‘ä»¬é‡ç‚¹å…ˆç ”ç©¶ä¸€ä¸‹ Gray å¯¹è±¡ï¼š</p><blockquote><p><strong>Gray</strong>: marked in bitmap, and exists in mark stack</p><p><strong>Gray-dirty</strong>: marked in bitmap, rb_state is gray, corresponding card is dirty, and exists in mark stack</p></blockquote><p>CC GC ä¸­ä¸¤è€…çš„åŒºåˆ«åœ¨äºï¼š</p><p><strong>Gray</strong>: bitmap ä¸­ mark äº†ï¼Œå¹¶ä¸” mark_stack ä¸­ä¹Ÿå­˜åœ¨ï¼›</p><p><strong>Gray-dirty</strong>: é™¤äº† Gray çš„ç‰¹å¾ä¹‹å¤–ï¼Œrb_state æ˜¯ gary, å¹¶ä¸”å…¶å¡è¡¨ä¹Ÿæ˜¯ dirty.</p><p>åœ¨æ­¤ç¨å¾®è¯´æ˜ä¸€ä¸‹ card çš„æ¦‚å¿µï¼š<em>refers to a small fixed-size portion of the heap.</em> æ³¨æ„ä¸»ä½“ heap.</p><p>åœ¨ CC GC ä¸­ï¼Œæœ‰ä¸€ä»¶äº‹æƒ…éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼šé™¤äº† Gray å¯¹è±¡ä¹‹å¤–ï¼Œå…¶ä»–æ‰€æœ‰çš„å¯¹è±¡éƒ½ä¸ä¼šå­˜åœ¨äº mark_stack ä¸­ã€‚</p><h2 id="_5-gc-phases" tabindex="-1"><a class="header-anchor" href="#_5-gc-phases"><span>5. GC Phases</span></a></h2><h3 id="_5-1-marking-phase" tabindex="-1"><a class="header-anchor" href="#_5-1-marking-phase"><span>5.1. Marking Phase</span></a></h3><blockquote><p>Before marking phase</p><ol><li>All objects are white</li><li>Cards are either clean or aged (cannot be asserted without a STW pause)</li><li>Mark bitmap is cleared</li><li>Mark stack is empty</li></ol></blockquote><p>ä¸Šè¿°å¾ˆå¥½ç†è§£ï¼Œç¬¦åˆæˆ‘ä»¬æŸ“è‰²ç®—æ³•ä¸­çš„å®šä¹‰ï¼šåœ¨ marking phase ä¹‹å‰ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ White çš„ï¼›</p><blockquote><p>During marking phase</p><ol><li>If a black object holds an inter-region or white reference, then its corresponding card is dirty. In other words, it changes from being black-clean to black-dirty</li><li>No black-clean object points to a white object</li></ol></blockquote><p>è¿™æ®µæ¯”è¾ƒéš¾ç†è§£ã€‚</p><ol><li><p>Black å¯¹è±¡æŒæœ‰ White å¯¹è±¡çš„å¼•ç”¨ï¼Œåˆ™ Black å¯¹è±¡çš„ card æ˜¯ dirty çš„ï¼›ä¸éš¾ç†è§£ï¼Œåœ¨æŸ“è‰²ç®—æ³•ä¸­ï¼ŒBlack å¯¹è±¡æ˜¯æœ€åæ ‡è®°çš„ï¼Œå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸçš„é¢œè‰²å˜åŒ–ä¸€èˆ¬æ˜¯ï¼šWhite -&gt; Gray -&gt; Black, æˆ–è€… always White;</p></li><li><p>ä½†æ˜¯ CC GC ä¸­å¯èƒ½â“ä¼šå‘ç”Ÿä¸€äº›æ“ä½œï¼Œä½¿å¾— Black å¯¹è±¡æŒæœ‰äº† White å¯¹è±¡çš„å¼•ç”¨ï¼Œæ­¤æ—¶ CC GC çš„å¤„ç†æ˜¯å°† è¯¥ Black å¯¹è±¡çŠ¶æ€è½¬æ¢ä¸º Black-dirty;</p></li><li><p>Black-dirty å’Œ Black-clean</p><blockquote><p>Black-dirty: marked in bitmap, and corresponding card is dirty.</p><p>Black-clean: marked in bitmap, and corresponding card is clean/aged</p></blockquote></li></ol><p>â€‹ æ²¡æœ‰ black-clean çš„å¯¹è±¡æŒ‡å‘ white object, æˆ‘çš„ç®€å•ç†è§£å°±æ˜¯ï¼šéƒ½å˜æˆäº† Black-dirty.</p><ol start="4"><li><p>Marking Phase è¿‡å</p><blockquote><p>After marking phase</p><ol><li>There are no gray objects</li><li>All newly allocated objects are in from space</li><li>No white object can be reachable, directly or otherwise, from a black-clean object</li></ol></blockquote><p>åœ¨ Marking Phase ä¹‹åï¼š1. Gray objects éƒ½æ²¡æœ‰äº†ï¼›2. æ–°åˆ†é…çš„å¯¹è±¡åœ¨ from-space; â“ è¿™é‡Œå­˜ç–‘ï¼Œè¿˜å°šä¸æ¸…æ¥šè¿™é‡Œæ˜¯å¦å‘ç”Ÿäº†ç¿»è½¬âŒï¼›é€šå¸¸è€Œè¨€ï¼Œå¯¹è±¡çš„åˆ†é…ä¹Ÿéƒ½æ˜¯åœ¨ from-space ä¸­çš„ï¼Ÿ â€“ åé¢ Copying Phase ä¼šè§£ç­”ç–‘é—®ï¼šç®€å•è€Œè¨€ï¼Œå°±æ˜¯åœ¨ Marking Phase ä¸­ï¼Œå¯¹è±¡æ˜¯åœ¨ from-space ä¸­åˆ†é…çš„ï¼›3. White å¯¹è±¡æ²¡æœ‰å†è¢« reachable çš„äº†ï¼›åˆç†ï¼Œè¾¾åˆ°äº†æŸ“è‰²æ ‡è®°çš„ç›®çš„ã€‚</p></li></ol><h3 id="_5-2-copying-phase" tabindex="-1"><a class="header-anchor" href="#_5-2-copying-phase"><span>5.2. Copying Phase</span></a></h3><blockquote><p>During copying phase</p><ol><li>Mutators cannot observe white and black-dirty objects</li><li>New allocations are in to-space (newly allocated regions are part of to-space)</li><li>An object in mark stack must have its rb_state = Gray</li></ol></blockquote><ol><li>Mutator çº¿ç¨‹çœ‹ä¸åˆ° White or Black-dirty å¯¹è±¡ï¼› <ul><li>å¯¹äºè¿™å¥è¯çš„ç†è§£ï¼Œå¯èƒ½è¦åˆ†ä¸ºå‡ ä¸ªç»´åº¦ï¼›é¦–å…ˆ Copying Phase æ˜¯åœ¨ Marking Phase ä¹‹åçš„ï¼Œæ‰€ä»¥æ­¤æ—¶åº”è¯¥æ˜¯ï¼š <ul><li>White: ä¸å¯è¾¾å¯¹è±¡</li><li>Black-dirty: â“è¾ƒéš¾ç†è§£ï¼Œå…¶å®è¿˜æ˜¯éœ€è¦å¼„æ¸…æ¥šä¸ºä»€ä¹ˆä¼šäº§ç”Ÿ Black-dirty å¯¹è±¡ï¼Ÿ</li></ul></li><li>æˆ‘ä»¬ç¦æ­¢ mutator çº¿ç¨‹çœ‹åˆ°ä¸å¯è¾¾çš„å¯¹è±¡ï¼Œå…¶ä¸­ä¼šä½¿ç”¨ä¸€äº›æŠ€æœ¯ï¼›@todo åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</li></ul></li><li>æ–°åˆ†é…çš„å¯¹è±¡åœ¨ to-space ä¸­ï¼›è¿™ä¸ªå¥½ç†è§£ï¼Œå¯¹æ¯”å‰é¢åœ¨ Marking Phase ä¸­ï¼Œæˆ‘ä»¬åªå…è®¸æ–°åˆ†é…çš„å¯¹è±¡åœ¨ from-space ä¸­ï¼›</li><li>mark stack ä¸­çš„å¯¹è±¡ rb_state = Gray; è¿™æ˜¯åœ¨ Copying Phase ä¸­çš„ä¸€ä¸ªé™åˆ¶</li></ol><h2 id="_6-gc-opt" tabindex="-1"><a class="header-anchor" href="#_6-gc-opt"><span>6. GC Opt</span></a></h2><p>Top10 hotspot æ”¶é›†ï¼šä½¿ç”¨ simpleperf é‡‡é›†çƒ­ç‚¹åœºæ™¯ GC çº¿ç¨‹çš„çƒ­ç‚¹å‡½æ•°ï¼Œå½’çº³ç»Ÿè®¡åå¾—åˆ°</p><p>è§‚å¯Ÿï¼š</p><ul><li>Top 10 hotspot ä¸»è¦åˆ†å¸ƒåœ¨ markingPhase, copyingPhase, reclaimPhase; top 1 çš„æ˜¯ copyphase ä¸­ Process å‡½æ•°ï¼Œè¿›ä¸€æ­¥åˆ†è§£ä¸º Copy() æµç¨‹</li><li>å‡ ä¹æ‰€æœ‰çƒ­ç‚¹å‡½æ•°éƒ½æ˜¯å…³äº mirror:Objects* ref åŠå…¶å¼•ç”¨çš„å¤„ç†</li><li>æ¶‰åŠåˆ° gc_mark_stack_ æ•°æ®ç»“æ„</li></ul><p>Optimization:</p><ul><li>Opt1: å¯¹ top hotspot ä½¿ç”¨çš„ ref è¿›è¡Œ software prefetch â€“ pldl2strm</li><li>Opt2: å¯¹ top 1 Process() è¿›è¡Œä¸“é¡¹ä¼˜åŒ– -- memcpy</li></ul><p>copyingPhase ä¸­çš„çƒ­ç‚¹æµç¨‹ç»Ÿè®¡æ–¹æ³•ï¼š ç»Ÿè®¡æ–¹æ³•ï¼šç»Ÿè®¡ Process() æ‰€æœ‰å­å‡½æ•°çš„æ‰§è¡Œæ—¶é—´(æ¯ä¸€è½®æµ‹è¯• loop å‡½æ•°æ‰§è¡Œ 100 ä¸‡æ¬¡ï¼Œå…±æ‰§è¡Œ 15 è½®) ç»Ÿè®¡ç»“æœï¼šCopy() å­å‡½æ•°æ‰§è¡Œçš„å¹³å‡æ—¶é—´å çˆ¶å‡½æ•°æ€»æ‰§è¡Œæ—¶é—´çš„ 65.56%, åœ¨ä¸­æ ¸ä¸Šå  79.03% ç»Ÿè®¡ç»“è®ºï¼šProcess() å‡½æ•°çš„æ€§èƒ½ç“¶é¢ˆä¸»è¦åœ¨ Copy() å­å‡½æ•°ä¸­</p><p>copy å¯¹è±¡çš„å¤§å°åˆ†å¸ƒï¼ˆGC ä¸­ copy çš„ç®—æ³•æ˜¯ä» header çš„ 8bytes å¼€å§‹ï¼‰</p><p><strong>å‡½æ•°åŠŸèƒ½</strong></p><ul><li>Copy() å‡½æ•°è°ƒç”¨äº† memcpy() å‡½æ•°å°†å¯¹è±¡ä» from_space æ‹·è´åˆ° to_spaceï¼›</li><li>Copy æ—¶åç§»ä¸º objectHeaderSizeå¤§å° (8 bytes)</li></ul><p><strong>å®éªŒç»Ÿè®¡</strong> ç»Ÿè®¡äº† 4.25 äº¿æ¬¡å„ä¸ªåœºæ™¯ä¸‹ Copy() å‡½æ•°æ‹·è´å¯¹è±¡çš„å¤§å°ï¼Œ16bytes, 24bytes, 32bytes çš„å æ¯”è¾¾åˆ°äº† 50.2%</p><figure><img src="https://github.com/user-attachments/assets/f3a70ee0-1abe-4499-9c24-eefabac516aa" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p><strong>ä¼˜åŒ–åŸç†</strong> memcpy å‡½æ•°é’ˆå¯¹è¾ƒå° bytes çš„æ‹·è´æœªè¿›è¡Œç‰¹æ®Šä¼˜åŒ–</p><p><strong>ä¼˜åŒ–æ–¹æ³•</strong> ä½¿ç”¨ memcpy æ±‡ç¼–å¯¹ä¸Šè¿°ä¸‰ä¸ª case è¿›è¡Œé‡å†™</p><p><em>æ³¨ï¼šoptimization prefetch é¢„å–äº†ä¸€æ¡ cacheline, å› æ­¤åœ¨è¯¥å¤„æ— éœ€è¿›è¡Œ copy çš„ load prefetch</em></p>',68)]))}const l=a(i,[["render",c]]),h=JSON.parse('{"path":"/java/art/gc_art_01.html","title":"Java GC - Concurrent Copying(Art)","lang":"zh-CN","frontmatter":{"title":"Java GC - Concurrent Copying(Art)","date":"2022-11-28T00:00:00.000Z","tag":["jvm","GC"],"category":["JAVA"],"description":"æœ¬ç¯‡æ–‡ç« é¦–å…ˆå¯¹ JAVA Art ä¸­çš„ GC è¿›è¡Œä¸€ä¸ªå…¨å±€æ€§çš„æ¦‚è§ˆï¼Œåç»­å¦‚æœè¦ç ”ç©¶æŠ€æœ¯ç»†èŠ‚ç­‰ï¼Œå†å¦èµ·æ–°çš„æ–‡ç« è¿›è¡Œé‡ç‚¹ç ”ç©¶ã€‚ æç¤º æœ¬ç¯‡ä¸»è¦ç ”ç©¶ ConcurrentCopying GC çš„æŠ€æœ¯ç»†èŠ‚ã€‚ 1. Forwarding Ptr åœ¨ art è™šæ‹Ÿæœºä¸­ï¼ŒFW Ptr æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œé€šå¸¸åœ¨ \\"mark and sweep\\" phase ä¸­ä½¿ç”¨ã€‚...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Java GC - Concurrent Copying(Art)\\",\\"image\\":[\\"https://github.com/user-attachments/assets/f3a70ee0-1abe-4499-9c24-eefabac516aa\\"],\\"datePublished\\":\\"2022-11-28T00:00:00.000Z\\",\\"dateModified\\":\\"2025-02-08T02:58:09.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Someone\\",\\"url\\":\\"https://www.weigao.cc\\"}]}"],["meta",{"property":"og:url","content":"https://vueblog.weigao.cc/java/art/gc_art_01.html"}],["meta",{"property":"og:site_name","content":"weigao"}],["meta",{"property":"og:title","content":"Java GC - Concurrent Copying(Art)"}],["meta",{"property":"og:description","content":"æœ¬ç¯‡æ–‡ç« é¦–å…ˆå¯¹ JAVA Art ä¸­çš„ GC è¿›è¡Œä¸€ä¸ªå…¨å±€æ€§çš„æ¦‚è§ˆï¼Œåç»­å¦‚æœè¦ç ”ç©¶æŠ€æœ¯ç»†èŠ‚ç­‰ï¼Œå†å¦èµ·æ–°çš„æ–‡ç« è¿›è¡Œé‡ç‚¹ç ”ç©¶ã€‚ æç¤º æœ¬ç¯‡ä¸»è¦ç ”ç©¶ ConcurrentCopying GC çš„æŠ€æœ¯ç»†èŠ‚ã€‚ 1. Forwarding Ptr åœ¨ art è™šæ‹Ÿæœºä¸­ï¼ŒFW Ptr æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œé€šå¸¸åœ¨ \\"mark and sweep\\" phase ä¸­ä½¿ç”¨ã€‚..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://github.com/user-attachments/assets/f3a70ee0-1abe-4499-9c24-eefabac516aa"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-02-08T02:58:09.000Z"}],["meta",{"property":"article:tag","content":"GC"}],["meta",{"property":"article:tag","content":"jvm"}],["meta",{"property":"article:published_time","content":"2022-11-28T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-02-08T02:58:09.000Z"}]]},"git":{"createdTime":1676689436000,"updatedTime":1738983489000,"contributors":[{"name":"weigao chen","username":"","email":"weigao_1995@yeah.net","commits":4},{"name":"chenweigao","username":"chenweigao","email":"297859260@qq.com","commits":2,"url":"https://github.com/chenweigao"},{"name":"weigao","username":"weigao","email":"weigao.cwg","commits":2,"url":"https://github.com/weigao"}]},"readingTime":{"minutes":9.53,"words":2859},"filePathRelative":"java/art/gc_art_01.md","excerpt":"<p>æœ¬ç¯‡æ–‡ç« é¦–å…ˆå¯¹ JAVA Art ä¸­çš„ GC è¿›è¡Œä¸€ä¸ªå…¨å±€æ€§çš„æ¦‚è§ˆï¼Œåç»­å¦‚æœè¦ç ”ç©¶æŠ€æœ¯ç»†èŠ‚ç­‰ï¼Œå†å¦èµ·æ–°çš„æ–‡ç« è¿›è¡Œé‡ç‚¹ç ”ç©¶ã€‚</p>\\n<div class=\\"hint-container tip\\">\\n<p class=\\"hint-container-title\\">æç¤º</p>\\n<p>æœ¬ç¯‡ä¸»è¦ç ”ç©¶ ConcurrentCopying GC çš„æŠ€æœ¯ç»†èŠ‚ã€‚</p>\\n</div>\\n<h2>1. Forwarding Ptr</h2>\\n<p>åœ¨ art è™šæ‹Ÿæœºä¸­ï¼ŒFW Ptr æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œé€šå¸¸åœ¨ \\"mark and sweep\\" phase ä¸­ä½¿ç”¨ã€‚</p>\\n<p>æ•´ä¸ªè¿‡ç¨‹çš„æè¿°å¤§è‡´ä¸ºï¼Œgc collector æ‰«æå­˜æ´»å¯¹è±¡å’Œå…¶å¼•ç”¨çš„å¯¹è±¡ï¼Œç¡®å®šè¿™äº›å¯¹è±¡åº”è¯¥ç»§ç»­å­˜æ´»è¿˜æ˜¯è¢«å›æ”¶ï¼Œåœ¨ mark phase å®Œæˆä»¥åï¼Œgc collector å¼€å§‹ \\"sweep\\" phase, åœ¨è¿™ä¸ª phase ä¸­ï¼Œä¼šå›æ”¶é‚£äº›å †ä¸­æ²¡æœ‰è¢« \\"mark\\" çš„å¯¹è±¡ï¼ˆè¿™äº›å¯¹è±¡ä¸ä¼šå†è¢«ä½¿ç”¨äº†ï¼‰ï¼›</p>","autoDesc":true}');export{l as comp,h as data};
