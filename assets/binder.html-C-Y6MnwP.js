import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as h,d as i,e as l,r as k,o as t}from"./app-11Vuyqh7.js";const p={};function e(E,s){const a=k("Mermaid");return t(),h("div",null,[s[0]||(s[0]=i(`<h2 id="overview" tabindex="-1"><a class="header-anchor" href="#overview"><span>Overview</span></a></h2><p>kernel ä¾§å®ç°ï¼škernel/linux-5.10/drivers/android/binder.c</p><p>native ä¾§å®ç°ï¼šsystem/libhwbinder</p><p>ğŸ’¯ğŸ’¯ æœ¬æ–‡ä¸»è¦æ˜¯é’ˆå¯¹ binder çš„ç†è§£è¿›è¡Œçš„è¡Œä¸ºï¼Œä»£ç åˆ—ä¸¾å’Œæ–‡å­—ä¹‹é—´å…³è”åº¦ä¸é«˜ï¼Œå¦‚æœæƒ³äº†è§£åŸç†ä½†æ˜¯ä¸æƒ³å¯¹ä»£ç è¿›è¡Œèµ°è¯»çš„ï¼Œå¯ä»¥è·³è¿‡ä»£ç è§£æçš„éƒ¨åˆ†ï¼Œä»¥å…é™·å…¥å¤ªå¤šçš„ç»†èŠ‚ã€‚</p><h2 id="ipc-é€šä¿¡" tabindex="-1"><a class="header-anchor" href="#ipc-é€šä¿¡"><span>IPC é€šä¿¡</span></a></h2><p>binder ç›¸æ¯”äºä¼ ç»Ÿçš„ IPC é€šä¿¡æ‹¥æœ‰æ¯”è¾ƒå¤§çš„ä¼˜åŠ¿ï¼šå…¶åªéœ€è¦è¿›è¡Œä¸€æ¬¡æ‹·è´ã€‚IPC é€šä¿¡çš„åŸç†å¤§è‡´å¦‚ä¸‹ï¼š</p><h2 id="binder-çº¿ç¨‹æ± " tabindex="-1"><a class="header-anchor" href="#binder-çº¿ç¨‹æ± "><span>Binder çº¿ç¨‹æ± </span></a></h2><p>å…³äº binder çº¿ç¨‹æ˜¯å¦‚ä½•ç®¡ç†ï¼Œbinder çº¿ç¨‹æ± æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿåœ¨ Android ä¸­ï¼Œä¸ç®¡æ˜¯ app è¿›ç¨‹ï¼Œè¿˜æ˜¯ system_server è¿›ç¨‹ï¼Œéƒ½æ˜¯åœ¨è¿›ç¨‹ fork å®Œæˆä»¥åï¼Œåœ¨æ–°è¿›ç¨‹ä¸­æ‰§è¡Œ <code>onZygoteInit()</code> å‡½æ•°çš„è¿‡ç¨‹ä¸­ï¼Œå¯åŠ¨åˆ›å»º binder çº¿ç¨‹æ± ã€‚</p><p>çº¿ç¨‹æ± åˆ›å»ºå¥½ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ binder çº¿ç¨‹äº†ï¼Œé€šå¸¸è€Œè¨€ï¼Œbinder çº¿ç¨‹çš„å‘½åæ ¼å¼ä¸º <code>binder_x</code>, é€šè¿‡ <code>spawnPooledThread</code> æ–¹æ³•åˆ›å»º<sup class="footnote-ref"><a href="#footnote1">[1]</a><a class="footnote-anchor" id="footnote-ref1"></a></sup>ã€‚</p><p>binder çº¿ç¨‹å¯ä»¥åˆ†ä¸ºä¸»çº¿ç¨‹å’Œæ™®é€šçº¿ç¨‹ï¼Œè¿˜æœ‰ä¸€ç§å…¶ä»–çš„ binder çº¿ç¨‹ï¼š</p><ol><li>ä¸»çº¿ç¨‹ï¼šè¿›ç¨‹åˆ›å»ºè¿‡ç¨‹ä¸­è°ƒç”¨ <code>startThreadPool()</code> å†è¿›å…¥ <code>spawnPooledThread(true)</code>, åˆ›å»º binder ä¸»çº¿ç¨‹ï¼Œåç§°æ˜¯ binder_PID_1, è¿™ä¸ªä¸»çº¿ç¨‹ä¸ä¼šé€€å‡º</li><li>æ™®é€šçº¿ç¨‹ï¼šBinder Driver æ ¹æ®æ˜¯å¦æœ‰ç©ºé—²çš„ binder çº¿ç¨‹æ¥å†³å®šæ˜¯å¦åˆ›å»º binder çº¿ç¨‹ï¼Œå›è°ƒ <code>spawnPooledThread(false)</code>, false è¡¨ç¤ºä¸æ˜¯ä¸»çº¿ç¨‹</li><li>å…¶ä»–çº¿ç¨‹ï¼šæ²¡æœ‰é€šè¿‡ <code>spawnPooledThread</code> æ–¹æ³•ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ <code>IPC.joinThreadPool()</code>, å°†å½“å‰çº¿ç¨‹åŠ å…¥ binder çº¿ç¨‹é˜Ÿåˆ—ï¼ˆé»˜è®¤çš„å‚æ•° isMain æ˜¯ trueï¼‰ã€‚</li></ol><h3 id="startthreadpool" tabindex="-1"><a class="header-anchor" href="#startthreadpool"><span>startThreadPool()</span></a></h3><blockquote><p>system/libhwbinder/ProcessState.cpp</p></blockquote><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> ProcessState</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">startThreadPool</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    AutoMutex </span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">_l</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">mLock</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // å¤šçº¿ç¨‹åŒæ­¥</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">mThreadPoolStarted</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        mThreadPoolStarted </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">mSpawnThreadOnStart</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">            spawnPooledThread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>mThreadPoolStarted</code> ä¿è¯æ¯ä¸ªè¿›ç¨‹åªä¼šå¯åŠ¨ä¸€ä¸ª binder çº¿ç¨‹æ± ï¼›ç„¶åæˆ‘ä»¬è°ƒç”¨ <code>spawnPooledThread(true)</code>;</p><h4 id="spawnpooledthread" tabindex="-1"><a class="header-anchor" href="#spawnpooledthread"><span>spawnPooledThread()</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> ProcessState</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">spawnPooledThread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">bool</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> isMain</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">mThreadPoolStarted</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        String8 name </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> makeBinderThreadName</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">        ALOGV</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">Spawning new pooled thread, name=</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;">%s</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">())</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        sp</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">Thread</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> t </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> PoolThread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">isMain</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">())</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>ç»™ binder çº¿ç¨‹èµ·åï¼Œåç§°æ˜¯ <code>name.appendFormat(&quot;HwBinder:%d_%X&quot;, pid, s);</code>, å…¶ä¸­ <code>s</code> è¡¨ç¤ºä¸€ä¸ªåŸå­çš„è®¡æ•°</li><li>åˆ›å»º <code>PoolThread</code> å¹¶è¿è¡Œï¼Œæˆ‘ä»¬ä¸‹é¢ç ”ç©¶è¿™ä¸ªå‡½æ•°ã€‚</li></ol><h4 id="poolthread" tabindex="-1"><a class="header-anchor" href="#poolthread"><span>PoolThread</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;"> PoolThread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> :</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> Thread</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    explicit</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> PoolThread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">bool</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> isMain</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        :</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> mIsMain</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">isMain</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    virtual</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> threadLoop</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">        IPCThreadState</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">joinThreadPool</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">mIsMain</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> bool</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> mIsMain</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»å‡½æ•°åçœ‹èµ·æ¥æ˜¯åˆ›å»ºçº¿ç¨‹æ± ï¼Œå…¶å®å°±åªæ˜¯åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè¯¥ PoolThread ç»§æ‰¿ Thread ç±»ã€‚<code>t-&gt;run()</code> æ–¹æ³•æœ€ç»ˆè°ƒç”¨ PoolThread çš„ threadLoop() æ–¹æ³•ã€‚</p><p>è¿™æ®µå‡½æ•°çš„é‡ç‚¹å°±æ˜¯ <code>joinThreadPool</code>, æˆ‘ä»¬ä¸‹ä¸ªç« èŠ‚è¿›è¡Œè¯¦ç»†çš„åˆ†æã€‚</p><h4 id="summary" tabindex="-1"><a class="header-anchor" href="#summary"><span>Summary</span></a></h4><p>æ€»ç»“ä¸€ä¸‹ <code>startThreadPool</code> è¿™ä¸ªå‡½æ•°ï¼Œå…¶æœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨ <code>joinThreadPool</code> å‡½æ•°è¿›è¡Œ binder çº¿ç¨‹æ± çš„åˆ›å»ºï¼Œä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œå…¶åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š</p><ol><li>å¤šçº¿ç¨‹åŒæ­¥</li><li>binder çº¿ç¨‹å‘½å</li><li>åˆ›å»º binder çº¿ç¨‹å¹¶åŠ å…¥çº¿ç¨‹æ± </li></ol><h3 id="ipc-jointhreadpool" tabindex="-1"><a class="header-anchor" href="#ipc-jointhreadpool"><span>IPC.joinThreadPool()</span></a></h3><p>è¯¥å‡½æ•°æ—¶ Android framework ä¸­è´Ÿè´£è®² binder çº¿ç¨‹åŠ å…¥çº¿ç¨‹æ± çš„å‡½æ•°ã€‚</p><p>å½“åº”ç”¨ç¨‹åºéœ€è¦ä¸å¦ä¸€ä¸ªè¿›ç¨‹é€šä¿¡æ—¶ï¼Œå¯ä»¥é€šè¿‡ Binder æŠ€æœ¯åˆ›å»ºä¸€ä¸ª Binder ä»£ç†å¯¹è±¡ï¼Œå¹¶åœ¨è¯¥å¯¹è±¡ä¸Šè°ƒç”¨<strong>è¿œç¨‹æ–¹æ³•</strong>ä»¥å®ç°è·¨è¿›ç¨‹é€šä¿¡ã€‚åœ¨æœåŠ¡ç«¯ï¼Œæ¯ä¸ª Binder ä»£ç†å¯¹è±¡å¯¹åº”ä¸€ä¸ª IBinder æ¥å£çš„å®ç°ç±»ï¼Œé€šè¿‡è¿™ä¸ªå®ç°ç±»ä¸å®¢æˆ·ç«¯è¿›è¡Œäº¤äº’ã€‚</p><p>å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚æ—¶ï¼Œè¯·æ±‚ä¼šå‘é€åˆ°æœåŠ¡ç«¯çš„çº¿ç¨‹æ± ä¸­ç­‰å¾…å¤„ç†ã€‚æœåŠ¡ç«¯çš„çº¿ç¨‹æ± æ˜¯ç”± <code>IPCThreadState </code> ç±»ç»´æŠ¤çš„ï¼Œå½“æœåŠ¡ç«¯çš„è¿›ç¨‹å¯åŠ¨æ—¶ï¼ŒIPCThreadState åˆ›å»ºäº†ä¸€ä¸ªåä¸º &quot;Binder:xxx_xxx&quot; çš„ binder çº¿ç¨‹ï¼Œå¹¶å°†å…¶åŠ å…¥åˆ°é»˜è®¤çš„ Handler çº¿ç¨‹æ± ä¸­ã€‚å®¢æˆ·ç«¯è¯·æ±‚åˆ°è¾¾æœåŠ¡ç«¯åï¼Œå®ƒä¼šè¢«åˆ†é…ç»™ Handler çº¿ç¨‹æ± ä¸­çš„æŸä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚</p><p>è€Œ <code>joinThreadPool(bool isMain)</code> å‡½æ•°å°±æ˜¯å°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ° Binder çº¿ç¨‹æ± ä¸­ï¼Œä»¥ä¾¿åœ¨æœåŠ¡ç«¯æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚æ—¶èƒ½å¤Ÿè¢«åˆ†é…åˆ°è¯¥çº¿ç¨‹å¤„ç†ã€‚å‚æ•° isMain æŒ‡ç¤ºæ˜¯å¦å°†å½“å‰çº¿ç¨‹ä½œä¸ºä¸»çº¿ç¨‹åŠ å…¥åˆ°çº¿ç¨‹æ± ä¸­ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å½“å‰çº¿ç¨‹å°†å¼€å§‹å¤„ç†æ¶ˆæ¯å¾ªç¯ã€‚å¦åˆ™ï¼Œå®ƒå°†è¢«åŠ å…¥åˆ°çº¿ç¨‹æ± ä¸­ç­‰å¾…ä»»åŠ¡åˆ†é…ã€‚</p><h4 id="source-code" tabindex="-1"><a class="header-anchor" href="#source-code"><span>source code</span></a></h4><blockquote><p>system/libhwbinder/IPCThreadState.cpp</p></blockquote><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> IPCThreadState</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">joinThreadPool</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">bool</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> isMain</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    //åˆ›å»ºBinderçº¿ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    mOut</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">writeInt32</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">isMain </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BC_ENTER_LOOPER </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BC_REGISTER_LOOPER</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    set_sched_policy</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">mMyThreadId</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> SP_FOREGROUND</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> //è®¾ç½®å‰å°è°ƒåº¦ç­–ç•¥</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">    status_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> result</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    do</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">        processPendingDerefs</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> //æ¸…é™¤é˜Ÿåˆ—çš„å¼•ç”¨[</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> getAndExecuteCommand</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> //å¤„ç†ä¸‹ä¸€æ¡æŒ‡ä»¤</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> NO_ERROR </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TIMED_OUT</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ECONNREFUSED </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">EBADF</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">            abort</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TIMED_OUT </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">isMain</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> ////éä¸»çº¿ç¨‹å‡ºç°timeoutåˆ™çº¿ç¨‹é€€å‡º</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> while</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ECONNREFUSED </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">EBADF</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    mOut</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">writeInt32</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">BC_EXIT_LOOPER</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // çº¿ç¨‹é€€å‡ºå¾ªç¯</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    talkWithDriver</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> //falseä»£è¡¨bwræ•°æ®çš„read_bufferä¸ºç©º</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>mOut.writeInt32(isMain ? BC_ENTER_LOOPER : BC_REGISTER_LOOPER);</code> å¦‚æœæ˜¯ä¸»çº¿ç¨‹çš„è¯ï¼Œåˆ™ <strong>BC_ENTER_LOOPER</strong>; æ­¤æ—¶çš„çŠ¶æ€æ˜¯ï¼š mOut ä¸­æœ‰å€¼ï¼ŒmIn æ˜¯ç©ºã€‚æˆ‘ä»¬çœ‹æ¥ä¸‹æ¥çš„ <code>result = getAndExecuteCommand();</code> æ˜¯æ€ä¹ˆå¤„ç†è¿™ç§ case çš„ã€‚</p><h4 id="getandexecutecommand" tabindex="-1"><a class="header-anchor" href="#getandexecutecommand"><span>getAndExecuteCommand()</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">status_t</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> IPCThreadState</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">getAndExecuteCommand</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">    status_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> result</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    int32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> talkWithDriver</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> //ä¸binderè¿›è¡Œäº¤äº’</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ... çœç•¥è¿™éƒ¨åˆ†ä»£ç ï¼Œæš‚æ—¶ä¸å…³æ³¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> result</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ—¶å€™è°ƒç”¨äº† <code>talkWithDriver()</code> å‡½æ•°ã€‚</p><h4 id="talkwithdriver" tabindex="-1"><a class="header-anchor" href="#talkwithdriver"><span>talkWithDriver()</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// mOutæœ‰æ•°æ®ï¼ŒmInè¿˜æ²¡æœ‰æ•°æ® doReceiveé»˜è®¤å€¼ä¸ºtrue</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">status_t</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> IPCThreadState</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">talkWithDriver</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">bool</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> doReceive</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    binder_write_read bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // This is what we&#39;ll read.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // æ˜¯è¯»å†™åœºæ™¯ä¸­çš„å“ªä¸ªï¼Ÿ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">doReceive </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> needRead</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">read_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> mIn</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">dataCapacity</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">read_buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">uintptr_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">mIn</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> else</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">read_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">read_buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // å½“åŒæ—¶æ²¡æœ‰è¾“å…¥å’Œè¾“å‡ºæ•°æ®åˆ™ç›´æ¥è¿”å›</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> ((</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">write_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">read_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> NO_ERROR</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">write_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> outAvail</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">write_buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">uintptr_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">mOut</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    do</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        //ioctlæ‰§è¡Œbinderè¯»å†™æ“ä½œï¼Œç»è¿‡syscallï¼Œè¿›å…¥Binderé©±åŠ¨ã€‚è°ƒç”¨Binder_ioctl</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">mProcess</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">mDriverFD</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_WRITE_READ</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> NO_ERROR</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> while</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">err </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">EINTR</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> err</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç† <code>mOut</code> ä¸­å†™å…¥çš„å‘½ä»¤ï¼Œæ‰€ä»¥å‰é¢çš„åˆ¤æ–­é€»è¾‘æ ¹æ®è¿™ä¸ªæ¥èµ°è¯»ã€‚ä¸»è¦å…³æ³¨ do..while å¾ªç¯ä¸­çš„ <code>ioctl</code>: æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶æ˜¯æŠŠæˆ‘ä»¬ä¸Šé¢å†™çš„ <code>BC_ENTER_LOOPER</code> å‘é€ç»™äº† binder é©±åŠ¨ï¼Œå¯¹ binder é©±åŠ¨è€Œè¨€ï¼Œå°±æ˜¯è°ƒç”¨åˆ° <code>binder_thread_write</code> æ¥è¿›è¡Œå¤„ç†äº†ã€‚</p><h2 id="binder-application-layer" tabindex="-1"><a class="header-anchor" href="#binder-application-layer"><span>Binder Application Layer</span></a></h2><p>æœ¬ç¯‡ä¸»è¦è®²è¿°åœ¨åº”ç”¨å±‚ï¼Œbinder æ˜¯å¦‚ä½•ä½“ç°å‡ºæ¥çš„ã€‚</p><h2 id="binder-framework-native" tabindex="-1"><a class="header-anchor" href="#binder-framework-native"><span>Binder Framework &amp; Native</span></a></h2><p>æœ¬ç« ä¸»è¦è®²è¿°åœ¨ Framework å’Œ native å±‚ï¼Œbinder çš„å®ç°ã€‚</p><h3 id="bbinder" tabindex="-1"><a class="header-anchor" href="#bbinder"><span>BBinder</span></a></h3><p>ä¹Ÿå«åš Base Binder, æ˜¯ Binder é€šä¿¡æœºåˆ¶çš„åŸºç±»ã€‚</p><p>BBinder æ˜¯ Binder é€šä¿¡æœºåˆ¶çš„åŸºç±»ï¼Œå®ƒå®ç°äº† IBinder æ¥å£å¹¶æä¾›äº†ä¸€äº›åŸºæœ¬çš„ Binder åŠŸèƒ½ã€‚</p><p>BBinder å¯ä»¥ä½œä¸ºæœåŠ¡ç«¯çš„åŸºç±»ï¼Œå¼€å‘è€…å¯ä»¥ç»§æ‰¿ BBinder æ¥åˆ›å»ºè‡ªå®šä¹‰çš„ Binder æœåŠ¡ç«¯å¯¹è±¡ã€‚</p><p>BBinder æä¾›äº†ä¸€äº›æ–¹æ³•æ¥å¤„ç†è·¨è¿›ç¨‹é€šä¿¡çš„åº•å±‚ç»†èŠ‚ï¼Œå¦‚çº¿ç¨‹åŒæ­¥ã€Parcel æ•°æ®å°è£…ç­‰ã€‚</p><h3 id="bpbinder" tabindex="-1"><a class="header-anchor" href="#bpbinder"><span>BpBinder</span></a></h3><p>ä¹Ÿå«åš Proxy Binderã€‚</p><p>BpBinder æ˜¯ Binder é€šä¿¡æœºåˆ¶çš„ä»£ç†ç±»ï¼Œå®ƒé€šè¿‡ä»£ç†æ–¹å¼ä¸è¿œç¨‹çš„ Binder é€šä¿¡ã€‚</p><p>BpBinder é€šè¿‡å‘ç³»ç»Ÿçš„ Binder é©±åŠ¨å‘é€è¯·æ±‚ï¼Œå°†è¯·æ±‚è½¬å‘ç»™è¿œç¨‹çš„ Binder æœåŠ¡ç«¯å¯¹è±¡ï¼Œå¹¶å°†å“åº”ç»“æœè¿”å›ç»™è°ƒç”¨æ–¹ã€‚</p><p>BpBinder é€šå¸¸ä½œä¸ºå®¢æˆ·ç«¯ä½¿ç”¨ï¼Œå®ƒéšè—äº†ä¸åº•å±‚ Binder é€šä¿¡çš„å¤æ‚æ€§ï¼Œæä¾›äº†ç®€å•çš„æ¥å£ä¾›å¼€å‘è€…ä½¿ç”¨ã€‚</p><h2 id="binder-driver" tabindex="-1"><a class="header-anchor" href="#binder-driver"><span>Binder Driver</span></a></h2><h3 id="binder-ioctl" tabindex="-1"><a class="header-anchor" href="#binder-ioctl"><span>binder_ioctl()</span></a></h3><p>binder_ioctl() å‡½æ•°æ˜¯ native å±‚è°ƒç”¨ä¸‹æ¥ä¹‹åçš„ç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œå…¶é‡è¦æ€§è‡ªç„¶ä¸è¨€è€Œå–»ã€‚</p><p>åœ¨ä¸Šå±‚æˆ‘ä»¬ä½¿ç”¨ ioclt è°ƒç”¨åˆ° binder è®¾å¤‡ï¼Œç±»ä¼¼äºï¼š</p><blockquote><p>ipc/native/src/mock/source/binder_connector.cpp</p></blockquote><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// bool BinderConnector::OpenDriver()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">fd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_VERSION</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­ fd è¡¨ç¤º binder çš„æ–‡ä»¶è®¾å¤‡ï¼Œé€šè¿‡ open() ç³»ç»Ÿè°ƒç”¨æ‰“å¼€ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// bool BinderConnector::OpenDriver()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> fd </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> open</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">deviceName_.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">c_str</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(),</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> O_RDWR</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­ deviceName_ æ˜¯ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// binder_connector.cpp</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> constexpr</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> const</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">DRIVER_NAME </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">/dev/binder</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬é€šè¿‡ fd æ–‡ä»¶è®¾å¤‡ï¼Œæ‰“å¼€ binder è®¾å¤‡ï¼Œè°ƒç”¨åˆ°äº† binder deriver ä¸­ã€‚</p><p>åœ¨ binder driver ä¸­ï¼Œä¼šå…ˆå»è°ƒç”¨ binder_ioctl() å‡½æ•°ï¼Œé‚£ä¹ˆï¼Œä¸Šå±‚çš„è®¾å¤‡æ˜¯å¦‚ä½•ä¸è¯¥å…¥å£å‡½æ•°å¯¹åº”èµ·æ¥çš„å‘¢ï¼Ÿ</p><blockquote><p>drivers/android/binder.c</p></blockquote><ol><li><p>åœ¨ init binder çš„æ—¶å€™ï¼ŒæŒ‡å®š binder è®¾å¤‡å¯¹åº”çš„ fops:</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __init </span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">init_binder_device</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">binder_device</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	binder_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> kzalloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">binder_device</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> GFP_KERNEL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">	binder_device</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">miscdev</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">fops</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">binder_fops</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å®šä¹‰ binder_fops:</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> file_operations binder_fops </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	.owner </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> THIS_MODULE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	.poll </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_poll</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	.unlocked_ioctl </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	.compat_ioctl </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> compat_ptr_ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	.mmap </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_mmap</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	.open </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_open</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	.flush </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_flush</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	.release </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_release</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	.may_pollfree </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç»“æ„ä½“ binder_fops çš„å®šä¹‰ä¸­ï¼Œç¬¬ 4 è¡Œä»£ç æŒ‡å‘äº† binder_ioctl() å‡½æ•°ã€‚</p></li></ol><p>å¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å°† native å±‚çš„ ioctl() å’Œ driver å±‚çš„å‡½æ•°è¿›è¡Œäº†å¯¹åº”ã€‚</p><p>åœ¨ binder_ioctl() ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸Šå±‚ä¼ å…¥çš„ cmd è¿›è¡Œç›¸å¯¹åº”çš„æ“ä½œï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> long</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> file </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">filp</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> long</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> arg</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	thread </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_get_thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	switch</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_WRITE_READ</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">		ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_ioctl_write_read</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">filp</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> arg</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_SET_MAX_THREADS</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_SET_CONTEXT_MGR_EXT</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_SET_CONTEXT_MGR</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">		// ..</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯”å¦‚æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨åˆ°çš„ <code>BINDER_WRITE_READ</code> å‘½ä»¤ï¼Œæ ¹æ®è¿™ä¸ªå‘½ä»¤è°ƒç”¨åˆ° binder_ioctl_write_read() ä¸­å»ï¼Œæœ€ç»ˆå®ç° driver å±‚çš„åŠŸèƒ½ã€‚</p><div class="hint-container tip"><p class="hint-container-title">One More Thing</p><p>åœ¨ binder driver è¿™ä¸ªç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šä»å„ä¸ªè§’åº¦æ·±å…¥åˆ†æ binder_ioctl() å‡½æ•°ã€‚è®©æˆ‘ä»¬æ‹­ç›®ä»¥å¾…ã€‚</p></div><h3 id="binder-transaction" tabindex="-1"><a class="header-anchor" href="#binder-transaction"><span>binder_transaction()</span></a></h3><blockquote><p>drivers/staging/android/binder.c</p></blockquote><p>BC_TRANSACTIONï¼ˆä¼šè°ƒç”¨ binder_transaction() å‡½æ•°ï¼‰ ç®€å•æ¥è¯´æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ‰¾åˆ°ç›®æ ‡è¿›ç¨‹æˆ–çº¿ç¨‹ã€‚</li><li>å°†ç”¨æˆ·ç©ºé—´çš„æ•°æ®æ‹·è´åˆ°ç›®å‰è¿›ç¨‹ç©ºé—´ï¼Œå¹¶è§£æ flat_binder_objectã€‚</li><li>å°†ä¼ è¾“å…¥æ ˆåˆ°å½“å‰çº¿ç¨‹ä¸­ã€‚</li><li>å°† BINDER_WORK_TRANSACTION åŠ å…¥åˆ°ç›®æ ‡é˜Ÿåˆ—ï¼Œå°† BINDER_WORK_TRANSACTION_COMPLETE åŠ å…¥åˆ°å½“å‰çº¿ç¨‹é˜Ÿåˆ—ã€‚</li><li>å”¤é†’ç›®æ ‡è¿›ç¨‹æˆ–çº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚</li></ol><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åˆ†æä¸€ä¸‹è¿™ä¸ªé‡è¦å‡½æ•°çš„æºç ï¼š</p><p>::: tabs</p><p>@tab binder_transaction#defines</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_transaction</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_proc </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                   struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_thread </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                   struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_transaction_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä¸ºå‡½æ•°çš„å®šä¹‰ï¼Œå‡½æ•°ç»†èŠ‚è¯·çœ‹è¯¦ç»†åˆ†æ: details<sup class="footnote-ref"><a href="#footnote2">[2]</a><a class="footnote-anchor" id="footnote-ref2"></a></sup>ã€‚</p><p>@tab detalis#binder_transaction</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_transaction</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_proc </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                   struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_thread </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                   struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_transaction_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ......</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> else</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">target</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">handle</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            // æ ¹æ®handleæ‰¾åˆ°ç›¸åº”çš„binderå®ä½“</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_ref </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ref</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ref </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_get_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">target</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">handle</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            target_node </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> ref</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">node</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> else</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            // handleä¸º0æ—¶ä¸ºservice managerçš„binderå®ä½“</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            target_node </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_context_mgr_node</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        e</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">to_node</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> target_node</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">debug_id</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // binderå®ä½“çš„binder_proc</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        target_proc </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> target_node</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ......</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">flags</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TF_ONE_WAY</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">transaction_stack</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_transaction </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tmp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            tmp </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">transaction_stack</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ......</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            // å¦‚æœæ˜¯åŒæ­¥ä¼ è¾“ï¼Œå¯»æ‰¾æ˜¯å¦ä¼ è¾“æ ˆä¸­æ˜¯å¦æœ‰æ¥è‡ªå¯¹ç«¯çš„ä¼ è¾“ï¼Œå¦‚æœæœ‰å°±ä½¿ç”¨å¯¹ç«¯çº¿ç¨‹å¤„ç†ä¼ è¾“</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            while</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tmp</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">tmp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">from</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> tmp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">proc</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> target_proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">                    target_thread </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> tmp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">                tmp </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> tmp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">from_parent</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // æ‰¾åˆ°å¯¹ç«¯çº¿ç¨‹è¿™ä½¿ç”¨çº¿ç¨‹todo listï¼Œå¦åˆ™ä½¿ç”¨è¿›ç¨‹todo list</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">target_thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        e</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">to_thread</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> target_thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">pid</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        target_list </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">target_thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">todo</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        target_wait </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">target_thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">wait</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> else</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        target_list </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">target_proc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">todo</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        target_wait </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">target_proc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">wait</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    e</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">to_proc</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> target_proc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">pid</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // åˆ†é…binder transaction</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    t </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> kzalloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> GFP_KERNEL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ......</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // åˆ†é…binder_workç”¨äºå¤„ç†ä¼ è¾“å®Œæˆ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    tcomplete </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> kzalloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tcomplete</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> GFP_KERNEL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ......</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // åŒæ­¥çš„éreplyä¼ è¾“ï¼Œè®¾ç½®å½“å‰çº¿ç¨‹ä¸ºfrom</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">reply </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">flags</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TF_ONE_WAY</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">from</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">from</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">sender_euid</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> proc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">tsk</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">cred</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">euid</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // è®¾ç½®ä¼ è¾“çš„ç›®æ ‡è¿›ç¨‹å’Œçº¿ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">to_proc</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> target_proc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">to_thread</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> target_thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">code</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">flags</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">flags</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">priority</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> task_nice</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">current</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ä»ç›®æ ‡è¿›ç¨‹ä¸­åˆ†é…ä¼ è¾“ç©ºé—´</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_alloc_buf</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">target_proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data_size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">offsets_size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">reply </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">flags</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TF_ONE_WAY</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">allow_user_free</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">debug_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">debug_id</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">transaction</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">target_node</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> target_node</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // å¢åŠ binderå®ä½“çš„å¼•ç”¨è®¡æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">target_node</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">        binder_inc_node</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">target_node</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    offp </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">binder_size_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> +</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">                 ALIGN</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data_size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // æ‹·è´ç”¨æˆ·æ•°æ®åˆ°binderå®ä½“çš„ä¼ è¾“ç©ºé—´ä¸­</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">copy_from_user</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">uintptr_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">               tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data_size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // æ‹·è´ç”¨æˆ·æ•°æ®çš„flat_binder_objectå¯¹è±¡ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">copy_from_user</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">offp</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">uintptr_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">               tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">offsets</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">offsets_size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    off_end </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">offp </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">offsets_size</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    off_min </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // å¤„ç†flat_binder_objectå¯¹è±¡ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> offp </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> off_end</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> offp</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> flat_binder_object </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        fp </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> flat_binder_object </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> +</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">offp</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        off_min </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">offp </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> flat_binder_object</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        switch</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // ç±»å‹ä¸ºbinderå®ä½“ï¼Œç”¨äºserveræ³¨å†Œ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_BINDER</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_WEAK_BINDER</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_ref </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ref</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            // å¦‚æœæ‰¾ä¸åˆ°binderå®ä½“å°±åˆ›å»ºä¸€ä¸ª</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_node </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">node </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_get_node</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">binder</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">node </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">                node </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_new_node</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">binder</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">cookie</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">                ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ......</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            // åœ¨ç›®æ ‡è¿›ç¨‹ä¸­åˆ›å»ºå¼•ç”¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ref </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_get_ref_for_node</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">target_proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> node</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ......</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            // ä¿®æ”¹binderå¯¹è±¡çš„ç±»å‹ä¸ºhandle</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_BINDER</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">                fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_HANDLE</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">                fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_WEAK_HANDLE</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">            fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">binder</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            // å°†å¼•ç”¨çš„handleèµ‹å€¼ç»™å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">            fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">handle</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> ref</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">desc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">            fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">cookie</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            // å¢åŠ å¼•ç”¨è®¡æ•°</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">            binder_inc_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ref</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_HANDLE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                       &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">todo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // ç±»å‹ä¸ºbinderå¼•ç”¨ï¼Œclientå‘serverä¼ è¾“</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_HANDLE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_WEAK_HANDLE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            // è·å–å½“å‰è¿›ç¨‹ä¸­çš„binderå¼•ç”¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_ref </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ref </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_get_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">                    proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">handle</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">                    fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_HANDLE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ......</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ref</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">node</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">proc</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> target_proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">                // å¦‚æœbinderä¼ è¾“å‘ç”Ÿåœ¨åŒä¸€è¿›ç¨‹ä¸­åˆ™ç›´æ¥ä½¿ç”¨binderå®ä½“</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_HANDLE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">                    fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_BINDER</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">                    fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_WEAK_BINDER</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">                fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">binder</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> ref</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">node</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">                fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">cookie</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> ref</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">node</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">cookie</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">                binder_inc_node</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ref</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">node</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_BINDER</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">                ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">            }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> else</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_ref </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">new_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">                // åœ¨ç›®æ ‡è¿›ç¨‹ä¸­åˆ›å»ºbinderå¼•ç”¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">                new_ref </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_get_ref_for_node</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">target_proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> ref</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">node</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">                ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">                fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">binder</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">                fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">handle</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> new_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">desc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">                fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">cookie</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">                binder_inc_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">new_ref</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> fp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_HANDLE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">                ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // ç±»å‹ä¸ºæ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨äºå…±äº«æ–‡ä»¶æˆ–å†…å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_TYPE_FD</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> else</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">flags</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TF_ONE_WAY</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // å½“å‰çº¿ç¨‹çš„ä¼ è¾“å…¥æ ˆ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">need_reply</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">from_parent</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">transaction_stack</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">transaction_stack</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> else</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // å¼‚æ­¥ä¼ è¾“ä½¿ç”¨aync todo list</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">target_node</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">has_async_transaction</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            target_list </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">target_node</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">async_todo</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            target_wait </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">            target_node</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">has_async_transaction</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // å°†ä¼ è¾“æ·»åŠ åˆ°ç›®æ ‡é˜Ÿåˆ—ä¸­</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">work</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_WORK_TRANSACTION</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    list_add_tail</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">work</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">entry</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> target_list</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // å°†ä¼ è¾“å®Œæˆæ·»åŠ åˆ°å½“å‰çº¿ç¨‹todoé˜Ÿåˆ—ä¸­</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    tcomplete</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_WORK_TRANSACTION_COMPLETE</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    list_add_tail</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">tcomplete</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">entry</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">todo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // å”¤é†’ç›®æ ‡çº¿ç¨‹æˆ–è¿›ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">target_wait</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">        wake_up_interruptible</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">target_wait</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>:::</p><p>è¿™ä¸ªå‡½æ•°æ˜¯ binder driver çš„å…³é”®å‡½æ•°ï¼Œè™½ç„¶å¾ˆé•¿å¾ˆå¤æ‚ï¼Œä½†æ˜¯å€¼å¾—ç»†ç»†å“å‘³ã€‚</p><h2 id="binder-protocol" tabindex="-1"><a class="header-anchor" href="#binder-protocol"><span>Binder Protocol</span></a></h2><p>å‘ binder driver é€šä¿¡çš„æ—¶å€™ï¼Œéœ€è¦ç¡®å®šåŸºæœ¬çš„é€šè®¯åè®®ï¼ˆè¯·æ±‚ç ï¼‰ï¼Œå…¶ä¸­åˆåˆ†ä¸º BC_PROTOCOL å’Œ BR_PROTOCOL:</p><ul><li><strong>BC_PROTOCOL</strong>: åº”ç”¨ç¨‹åºå‘ binder é©±åŠ¨è®¾å¤‡å‘é€è¯·æ±‚æ¶ˆæ¯</li><li><strong>BR_PROTOCOL</strong>: binder é©±åŠ¨è®¾å¤‡å‘åº”ç”¨ç¨‹åºå‘é€æ¶ˆæ¯</li></ul><p>è¿™äº›åè®®éƒ½å®šä¹‰åœ¨ <code>enum binder_driver_command_protocol</code> ç»“æ„ä½“(binder.h)ä¸­ï¼š</p><blockquote><p>/linux/android/binder.h</p></blockquote><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">enum</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_driver_command_protocol </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	BC_TRANSACTION </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> _IOW</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">c</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_transaction_data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	BC_REPLY </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> _IOW</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">c</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_transaction_data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­ <code>_IOW</code> å®å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> _IOW</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">nr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">	_IOC</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;">_IOC_WRITE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,(</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),(</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;">nr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">_IOC_TYPECHECK</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> _IOC</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">dir</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">nr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">	(((</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;">dir</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;"> _IOC_DIRSHIFT</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">	 ((</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;"> _IOC_TYPESHIFT</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">	 ((</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;">nr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">   &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;"> _IOC_NRSHIFT</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">	 ((</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;"> _IOC_SIZESHIFT</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="abstract-of-bc-protocol" tabindex="-1"><a class="header-anchor" href="#abstract-of-bc-protocol"><span>Abstract of BC_PROTOCOL</span></a></h3><p>æˆ‘ä»¬å…ˆå¯¹ BC_PROTOCOL è¿›è¡Œç ”ç©¶ã€‚</p><p>åº”ç”¨ç¨‹åºå‘ binder é©±åŠ¨å‘é€è¯·æ±‚æ¶ˆæ¯å…± 15 æ¡<sup class="footnote-ref"><a href="#footnote3">[3]</a><a class="footnote-anchor" id="footnote-ref3"></a></sup>ï¼š</p><table><thead><tr><th style="text-align:left;">è¯·æ±‚ç </th><th style="text-align:left;">ä½œç”¨</th><th style="text-align:left;">ä½¿ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td style="text-align:left;">BC_TRANSACTION</td><td style="text-align:left;">Clientå‘Binderé©±åŠ¨å‘é€è¯·æ±‚æ•°æ®</td><td style="text-align:left;">transact()</td></tr><tr><td style="text-align:left;">BC_REPLY</td><td style="text-align:left;">Serverå‘Binderé©±åŠ¨å‘é€è¯·æ±‚æ•°æ®</td><td style="text-align:left;">sendReply()</td></tr><tr><td style="text-align:left;">BC_FREE_BUFFER</td><td style="text-align:left;">é‡Šæ”¾å†…å­˜</td><td style="text-align:left;">freeBuffer()</td></tr><tr><td style="text-align:left;">BC_ACQUIRE</td><td style="text-align:left;">binder_refå¼ºå¼•ç”¨åŠ 1</td><td style="text-align:left;">incStrongHandle()</td></tr><tr><td style="text-align:left;">BC_RELEASE</td><td style="text-align:left;">binder_refå¼ºå¼•ç”¨å‡1</td><td style="text-align:left;">decStrongHandle()</td></tr><tr><td style="text-align:left;">BC_INCREFS</td><td style="text-align:left;">binder_refå¼±å¼•ç”¨åŠ 1</td><td style="text-align:left;">incWeakHandle()</td></tr><tr><td style="text-align:left;">BC_DECREFS</td><td style="text-align:left;">binder_refå¼±å¼•ç”¨å‡1</td><td style="text-align:left;">decWeakHandle()</td></tr><tr><td style="text-align:left;">BC_ACQUIRE_DONE</td><td style="text-align:left;">binder_nodeå¼ºå¼•ç”¨å‡1å®Œæˆ</td><td style="text-align:left;">executeCommand()</td></tr><tr><td style="text-align:left;">BC_INCREFS_DONE</td><td style="text-align:left;">binder_nodeå¼±å¼•ç”¨å‡1å®Œæˆ</td><td style="text-align:left;">executeCommand()</td></tr><tr><td style="text-align:left;">BC_REGISTER_LOOPER</td><td style="text-align:left;">åˆ›å»ºæ–°çš„Binderçº¿ç¨‹</td><td style="text-align:left;">joinThreadPool()</td></tr><tr><td style="text-align:left;">BC_ENTER_LOOPER</td><td style="text-align:left;">Binderä¸»çº¿ç¨‹è¿›å…¥looper</td><td style="text-align:left;">joinThreadPool()</td></tr><tr><td style="text-align:left;">BC_EXIT_LOOPER</td><td style="text-align:left;">Binderçº¿ç¨‹çº¿ç¨‹é€€å‡ºlooper</td><td style="text-align:left;">joinThreadPool()</td></tr><tr><td style="text-align:left;">BC_REQUEST_DEATH_NOTIFICATION</td><td style="text-align:left;">æ³¨å†Œæ­»äº¡é€šçŸ¥</td><td style="text-align:left;">requestDeathNotification()</td></tr><tr><td style="text-align:left;">BC_CLEAR_DEATH_NOTIFICATION</td><td style="text-align:left;">å–æ¶ˆæ³¨å†Œæ­»äº¡é€šçŸ¥</td><td style="text-align:left;">clearDeathNotification()</td></tr><tr><td style="text-align:left;">BC_DEAD_BINDER_DONE</td><td style="text-align:left;">å·²å®Œæˆbinderçš„æ­»äº¡é€šçŸ¥</td><td style="text-align:left;">executeCommand()</td></tr></tbody></table><p>æˆ‘ä»¬æ¥ä¸‹æ¥å¯¹è¿™äº›åè®®è¿›è¡Œä¸€ä¸€åˆ†æã€‚</p><h3 id="bc-transaction-bc-reply" tabindex="-1"><a class="header-anchor" href="#bc-transaction-bc-reply"><span>BC_TRANSACTION &amp; BC_REPLY</span></a></h3><p>è¿™æ˜¯æœ€å¸¸ç”¨çš„åè®®ï¼Œç”¨äºå‘ binder é©±åŠ¨å‘èµ·è¯·æ±‚æˆ–è€…åº”ç­”æ•°æ®ï¼Œä¼ é€’çš„å‚æ•°å°±æ˜¯ <code>binder_transaction_data</code> ç»“æ„ä½“ã€‚</p><p>è¯¥ä¼ è¾“è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„å‡½æ•°åˆ—è¡¨ï¼š</p><ul><li>binder_ioctl</li><li>binder_ioctl_write_read</li><li><strong>binder_thread_write</strong>: åè®®çš„ç›´æ¥è°ƒç”¨å¤„ï¼Œæˆ‘ä»¬ä»æ­¤å¤„å¼€å§‹ç ”ç©¶</li><li>binder_transaction: å‡½æ•°è¾ƒä¸ºå¤æ‚ï¼Œå•ç‹¬æ–°å¼€ç« èŠ‚ç ”ç©¶</li></ul><p>ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬ç”¨ä¸€å¼ å›¾æ¥è¿›è¡Œè¡¨è¿°ï¼š</p>`,104)),l(a,{id:"mermaid-580",code:"eJxVzt0KgjAUB/D7nuJc1oXSEwjqdiGExRIiRMacEwfm4riQYg+fn0Hn7nz8f5y6NYNsBFrIyA7GCvNSd5VCro20bQGeF7goSQll/MaSjHJGQ+Ig+jvjA2qrOCpRFbMSged7AcS5NM83r9E8+KtX+FuOO6drKAf0l2ivPwoCODqyX2HbTNwiH+YcWdGtmZAo5hkL02sYZ8k5BYMwThi9nO4O6PajRdH1QlptumL3Bb4ATHQ="}),s[1]||(s[1]=i(`<blockquote><p>drivers/android/binder.c</p></blockquote><h4 id="binder-thread-write" tabindex="-1"><a class="header-anchor" href="#binder-thread-write"><span>binder_thread_write()</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_thread_write</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_proc </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_thread </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">            binder_uintptr_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> binder_buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> size_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">            binder_size_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">consumed</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    	void</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">consumed</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    	// ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        case BC_TRANSACTION:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        case BC_REPLY: </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_transaction_data tr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">copy_from_user</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                return</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">EFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">            binder_transaction</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cmd </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BC_REPLY</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    	// ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢åˆ†åˆ«ç ”ç©¶ binder_ioctl() å‡½æ•°å’Œ binder_ioctl_write_read() å‡½æ•°åœ¨è¿™ä¸ª case ä¸­çš„åº”ç”¨ï¼š</p><h4 id="binder-ioctl-1" tabindex="-1"><a class="header-anchor" href="#binder-ioctl-1"><span>binder_ioctl()</span></a></h4><p>binder_ioctl å‡½æ•°æ˜¯ä¸Šå±‚è°ƒç”¨ä¸‹æ¥ä»¥åçš„å…¥å£å‡½æ•°ï¼Œåœ¨æœ¬ç« ç ”ç©¶çš„ BC_TRANSACTION &amp; BC_REPLY æµç¨‹ä¸­ï¼Œä¼šè¿›å…¥ case BINDER_WRITE_READ, è¿™æ˜¯ç”± native å±‚ä¼ é€’è¿‡æ¥çš„ command.</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> long</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_ioctl</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> file </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">filp</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> long</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> arg</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    switch</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_WRITE_READ</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">		ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_ioctl_write_read</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">filp</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> arg</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ret</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">			goto</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> err</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="binder-ioctl-write-read" tabindex="-1"><a class="header-anchor" href="#binder-ioctl-write-read"><span>binder_ioctl_write_read()</span></a></h4><p>binder é€šä¿¡ï¼Œä¸Šå±‚ä¼šä¼ é€’ <strong>BINDER_WRITE_READ</strong> cmd, ä» è¯¥ case é‡Œé¢è°ƒç”¨åˆ° binder_ioctl_write_read() å‡½æ•°ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_ioctl_write_read</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> file </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">filp</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">				unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> long</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> arg</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">				struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_thread </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_proc </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">proc </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> filp</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">private_data</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> size </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> _IOC_SIZE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	void</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ubuf </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">arg</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_write_read bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">copy_from_user</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> ubuf</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">		ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">EFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		goto</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> out</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">	}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // éœ€è¦å†™æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">write_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">		ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_thread_write</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">					  bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">write_buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">					  bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">write_size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">					  &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">bwr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">write_consumed</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">		</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤æ—¶æˆ‘ä»¬æ˜¯çœŸæ­£è°ƒç”¨è¿›äº† <code>binder_thread_write</code>, ä¹Ÿå°±æ˜¯ä¸Šé¢æˆ‘ä»¬é‚£ä¸ª case æ‰€åœ¨çš„åœ°æ–¹ã€‚</p><h3 id="bc-free-buffer" tabindex="-1"><a class="header-anchor" href="#bc-free-buffer"><span>BC_FREE_BUFFER</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">case BC_FREE_BUFFER: </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">    binder_uintptr_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> data_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // è·å–ç”¨æˆ·ç©ºé—´æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">get_user</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">data_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">binder_uintptr_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">EFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">binder_uintptr_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ä» buffer æ ‘ä¸­æ‰¾åˆ°å¯¹åº”çš„ binder_buffer</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_alloc_prepare_to_free</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">alloc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">                                          data_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    binder_free_buf</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="br-transaction-complete" tabindex="-1"><a class="header-anchor" href="#br-transaction-complete"><span>BR_TRANSACTION_COMPLETE</span></a></h3><p>Client åœ¨æ‰§è¡Œ <strong>BINDER_WRITE_READ</strong> æ—¶ï¼Œå…ˆé€šè¿‡ binder_thread_write() å†™æ•°æ®ï¼Œå°† <strong>BINDER_WORK_TRANSACTION_COMPLETE</strong> æ”¾å…¥å·¥ä½œé˜Ÿåˆ—ã€‚ç´§æ¥ç€å°±æ‰§è¡Œ binder_thread_read() è¯»å–è¿”å›æ•°æ®ã€‚è¿™é‡Œä¼šå°†å‘½ä»¤ BR_TRANSACTION_COMPLETE è¿”å›ç»™ Client çº¿ç¨‹ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_thread_read</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_proc </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                  struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_thread </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">                  binder_uintptr_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> binder_buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> size_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">                  binder_size_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">consumed</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> non_block</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ......</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ç¬¬ä¸€æ¬¡è¯»æ—¶ï¼Œæ’å…¥å‘½ä»¤ BR_NOOP è¿”å›ç»™ç”¨æˆ·</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">consumed </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">put_user</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">BR_NOOP</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            return</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">EFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">retry:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // å½“å‰çº¿ç¨‹æ²¡æœ‰ä¼ è¾“å¹¶ä¸” todo é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå¤„ç†è¿›ç¨‹çš„å·¥ä½œé˜Ÿåˆ—</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    wait_for_proc_work </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">transaction_stack</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">                list_empty</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">todo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">looper</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> |=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_LOOPER_STATE_WAITING</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // å¦‚æœå¤„ç†è¿›ç¨‹å·¥ä½œé˜Ÿåˆ—ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¸ºç©ºé—²çº¿ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">wait_for_proc_work</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        proc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ready_threads</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ......</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ç­‰å¾…è¿›ç¨‹æˆ–çº¿ç¨‹å·¥ä½œé˜Ÿåˆ—è¢«å”¤é†’</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">wait_for_proc_work</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> wait_event_freezable_exclusive</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">wait</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_has_proc_work</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> else</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> wait_event_freezable</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">wait</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> binder_has_thread_work</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ......</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // å”¤é†’åï¼Œå¼€å§‹å¤„ç†ä¼ è¾“ï¼Œç©ºé—²çº¿ç¨‹å‡1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">wait_for_proc_work</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        proc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ready_threads</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">--</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">looper</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ~</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">BINDER_LOOPER_STATE_WAITING</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ......</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ......</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">       // ä¼˜å…ˆå¤„ç†çº¿ç¨‹å·¥ä½œé˜Ÿåˆ—ï¼Œå†å¤„ç†è¿›ç¨‹å·¥ä½œé˜Ÿåˆ—</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">list_empty</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">todo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            w </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> list_first_entry</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">todo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_work</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> entry</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        else</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">list_empty</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">todo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> wait_for_proc_work</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            w </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> list_first_entry</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">proc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">todo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> binder_work</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> entry</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        else</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 4</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">thread</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">looper</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_LOOPER_STATE_NEED_RETURN</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> /* no data added */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                goto</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> retry</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ......</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        switch</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">w</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ......</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BINDER_WORK_TRANSACTION_COMPLETE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            // å‘é€å‘½ä»¤BR_TRANSACTION_COMPLETEç»™ç”¨æˆ·</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            cmd </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> BR_TRANSACTION_COMPLETE</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">put_user</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> __user </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                return</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">EFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">            ......</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">            list_del</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">w</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">entry</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">            kfree</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">w</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">            binder_stats_deleted</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">BINDER_STAT_TRANSACTION_COMPLETE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">        }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ......</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">            continue</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ......</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="br-transaction" tabindex="-1"><a class="header-anchor" href="#br-transaction"><span>BR_TRANSACTION</span></a></h3><p>Server ç«¯çº¿ç¨‹å¯åŠ¨åå°±è°ƒç”¨ talkWithDriver() ç­‰å¾…è¯»å–æ•°æ®ã€‚Binder é©±åŠ¨å¤„ç† Client å‘é€çš„ BC_TRANSACTION å‘½ä»¤åï¼Œä¼šå”¤é†’ Server çº¿ç¨‹ã€‚Server çº¿ç¨‹è¯»å–æ•°æ®è¿›è¡Œå¤„ç†åŒæ ·æ˜¯åœ¨ binder_thread_read() ä¸­å®Œæˆçš„ã€‚</p><h2 id="mmap-æŠ€æœ¯" tabindex="-1"><a class="header-anchor" href="#mmap-æŠ€æœ¯"><span>mmap æŠ€æœ¯</span></a></h2><p>mmap(), æˆ–è€…ç§°ä¹‹ä¸ºå†…å­˜æ˜ å°„æŠ€æœ¯ï¼Œæ˜¯å®ç° binder çš„é‡è¦æŠ€æœ¯ä¹‹ä¸€ã€‚</p><p>mmap() å¯ä»¥å°†ä¸€ä¸ªæ–‡ä»¶ã€ä¸€æ®µç‰©ç†å†…å­˜æˆ–è€…å…¶ä»–å¯¹è±¡æ˜ å°„åˆ°<strong>è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´</strong>ã€‚åœ¨å†…å­˜æ˜ å°„æŠ€æœ¯ä¸­ï¼Œæ“ä½œç³»ç»Ÿä¼šä¸ºæ¯ä¸ªæ˜ å°„çš„æ–‡ä»¶æˆ–è®¾å¤‡åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç„¶åå°†è¯¥è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„æ¯ä¸ªåœ°å€éƒ½æ˜ å°„åˆ°æ–‡ä»¶æˆ–è®¾å¤‡çš„å®é™…ç‰©ç†åœ°å€ä¸Šã€‚</p><p>â¤ï¸â¤ï¸ å¯¹äºè¿™å¥è¯çš„ç†è§£ï¼Œç‰©ç†å†…å­˜ï¼ˆç‰©ç†é¡µï¼‰â€“&gt; è™šæ‹Ÿå†…å­˜ï¼ˆè™šæ‹Ÿé¡µï¼‰ï¼›ç‰©ç†é¡µæ˜¯å†…æ ¸ç®¡ç†ç‰©ç†é¡µçš„åŸºæœ¬å•ä½ã€‚</p><p>âŒâŒ ç›®å‰æ¥çœ‹ï¼šè¿™ç§æ˜ å°„æœ¬èº«æ“ä½œç³»ç»Ÿå°±ä¼šå®Œæˆï¼Œé‚£ä¹ˆ mmap åšäº†ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>mmap æœ‰ä¸€ä¸ªé‡è¦çš„ç†å¿µï¼šè®¿é—®æ–‡ä»¶ï¼ˆå¦‚æœæ˜ å°„çš„æ˜¯æ–‡ä»¶ï¼‰å°±åƒæ˜¯è®¿é—®å†…å­˜ä¸€æ ·ã€‚</p><h2 id="pracel" tabindex="-1"><a class="header-anchor" href="#pracel"><span>Pracel</span></a></h2><h3 id="call-stack" tabindex="-1"><a class="header-anchor" href="#call-stack"><span>Call Stack</span></a></h3><p>æ¥ç ”ç©¶ä¸€ä¸‹åºåˆ—åŒ–ã€ååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚</p><blockquote><p>ipc/native/src/mock/source/binder_invoker.cpp</p></blockquote><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> BinderInvoker</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">WriteTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> uint32_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int32_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> uint32_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> code</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> MessageParcel</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int32_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    binder_transaction_data tr </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{}</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">target</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">handle</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">handle</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">code</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> code</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">flags</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> flags</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">flags</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> |=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TF_ACCEPT_FDS</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetDataSize</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // Send this parcel&#39;s data through the binder.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetDataSize</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">binder_uintptr_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetData</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">offsets_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetOffsetsSize</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#8FBCBB;">binder_size_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">offsets</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetObjectOffsets</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> else</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">status </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // Send this parcel&#39;s status through the binder.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">flags</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> |=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TF_STATUS_CODE</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> reinterpret_cast&lt;uintptr_t&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">offsets_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">offsets</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">output_</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">WriteInt32</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">cmd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">        ZLOGE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">LABEL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">WriteTransaction Command failure</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> output_</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">WriteBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">binder_transaction_data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç æ˜¯å®¢æˆ·ç«¯â“å†™ ipc é€šä¿¡æ‰€éœ€è¦çš„æ•°æ®ï¼Œdata æ˜¯ä¸€ä¸ª <code>MessageParcel</code> å¯¹è±¡ï¼Œä»è¿™å°±å¯ä»¥çŒœæµ‹å‡ºï¼Œåœ¨ native å±‚ï¼Œæ˜¯ä¾é è¿™ä¸ªå¯¹è±¡æ¥è¿›è¡Œæ•°æ®çš„ä¼ è¾“çš„ã€‚</p><p>æ¥çœ‹å®šä¹‰ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;"> MessageParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> :</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> Parcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶é›†æˆäº† Parcel æ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ° Parcel çš„å®ç°ã€‚</p><p>â¡ï¸â¡ï¸ å®¢æˆ·ç«¯</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> TestAbilityProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">TestPingService</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">u16string</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">dummy</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    MessageOption option</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    MessageParcel dataParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> replyParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    dataParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">WriteString16</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">dummy</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> error </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> Remote</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">SendRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">TRANS_ID_PING_ABILITY</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> dataParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> replyParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> option</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">error </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> ERR_NONE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> replyParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">ReadInt32</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> :</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> result</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬ 5 è¡Œè°ƒç”¨åˆ°äº† SendRequest æ–¹æ³•ï¼Œ</p><p>â¡ï¸â¡ï¸ JNI å±‚</p><blockquote><p>ipc/native/src/jni/source/ohos_rpc_message_parcel.cpp</p></blockquote><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * Class:     ohos.rpc.MessageParcel</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * Method:    nativeWriteRawData</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> * Signature: ([BI)Z</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">jboolean JNICALL </span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Java_ohos_rpc_MessageParcel_nativeWriteRawData</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">JNIEnv </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> jobject object</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> jobject rawData</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> jint size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    MessageParcel </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">nativeParcel </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> JavaOhosRpcMessageParcelGetNative</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> object</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">nativeParcel </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">        ZLOGE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">LABEL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">could not get native parcel for raw data</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> JNI_FALSE</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    jbyte </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> static_cast&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">jbyte </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetPrimitiveArrayCritical</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static_cast&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">jarray</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">rawData</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ptr </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> JNI_FALSE</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    bool</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> nativeParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">WriteRawData</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">    env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">ReleasePrimitiveArrayCritical</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static_cast&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">jarray</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">rawData</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> JNI_TRUE </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> JNI_FALSE</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>JNI å±‚å‡½æ•°ç½‘ä¸Šçœ‹ï¼Œå‡½æ•°æ˜ å°„ï¼ˆçœ‹æ³¨é‡Šé‡Œé¢çš„ Method ä¹Ÿèƒ½çŸ¥é“ï¼‰ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">nativeWriteRawData</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">([BI)Z</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">Java_ohos_rpc_MessageParcel_nativeWriteRawData </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å…¶ä¸­ nativeWriteRawData æ˜¯ç»™ JNI çš„ä¸Šå±‚ä½¿ç”¨çš„ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ‰¾åˆ°å…¶è°ƒç”¨çš„åœ°æ–¹ã€‚ğŸ’ŠğŸ’ŠğŸ’Š</p><p>â¡ï¸â¡ï¸ native å±‚</p><p>18 è¡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨äº† MessageParcel çš„ WriteRawData æ–¹æ³•ï¼š</p><blockquote><p>ipc/native/src/core/source/message_parcel.cpp</p></blockquote><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> MessageParcel</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">WriteRawData</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> size_t</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">data </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> nullptr</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> size </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> MAX_RAWDATA_SIZE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">kernelMappedWrite_ </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">WriteInt32</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">size </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> MIN_RAWDATA_SIZE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> WriteUnpadBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> fd </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> AshmemCreate</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">Parcel RawData</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">fd </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pracel-object-java" tabindex="-1"><a class="header-anchor" href="#pracel-object-java"><span>Pracel Object(Java)</span></a></h3><p>todo: æœ¬ç« ç ”ç©¶ Pracel å¯¹è±¡çš„åˆ›å»ºç­‰æ“ä½œ<sup class="footnote-ref"><a href="#footnote4">[4]</a><a class="footnote-anchor" id="footnote-ref4"></a></sup>ã€‚</p><h2 id="reference" tabindex="-1"><a class="header-anchor" href="#reference"><span>Reference</span></a></h2><ol><li><p><a href="https://juejin.cn/post/6956031662916534279" target="_blank" rel="noopener noreferrer">mmap æ¥å£è§£æï¼šã€Šä¸€æ–‡è¯»æ‡‚ mmap åŸç†ã€‹</a></p></li><li><p><a href="https://developer.aliyun.com/article/933229" target="_blank" rel="noopener noreferrer">IPC é€šä¿¡ä¸ binder åŸºç¡€ä»‹ç»ï¼šã€ŠAndroid BinderåŸç†å›¾è§£ã€‹</a></p></li><li><p><a href="https://blog.csdn.net/itachi85/article/details/102713845" target="_blank" rel="noopener noreferrer">binder åŸºæœ¬åŸç†ï¼šã€ŠAndroid BinderåŸç†ï¼ˆä¸€ï¼‰å­¦ä¹ Binderå‰å¿…é¡»è¦äº†è§£çš„çŸ¥è¯†ç‚¹ã€‹</a></p></li></ol><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="footnote1" class="footnote-item"><p><a href="http://gityuan.com/2016/10/29/binder-thread-pool/" target="_blank" rel="noopener noreferrer">binder çº¿ç¨‹æ± </a> <a href="#footnote-ref1" class="footnote-backref">â†©ï¸</a></p></li><li id="footnote2" class="footnote-item"><p><a href="https://segmentfault.com/a/1190000020534070" target="_blank" rel="noopener noreferrer">Binderé©±åŠ¨ä¹‹æœ€ç®€å•çš„é€šä¿¡</a> <a href="#footnote-ref2" class="footnote-backref">â†©ï¸</a></p></li><li id="footnote3" class="footnote-item"><p><a href="http://gityuan.com/2014/01/05/binder-driver/" target="_blank" rel="noopener noreferrer">5.5 æ¢ç©¶Binder Driver</a> <a href="#footnote-ref3" class="footnote-backref">â†©ï¸</a></p></li><li id="footnote4" class="footnote-item"><p><a href="http://gityuan.com/2016/09/04/binder-start-service/" target="_blank" rel="noopener noreferrer">å½»åº•ç†è§£Android Binderé€šä¿¡æ¶æ„</a> <a href="#footnote-ref4" class="footnote-backref">â†©ï¸</a></p></li></ol></section>`,52))])}const g=n(p,[["render",e]]),y=JSON.parse('{"path":"/java/android/binder.html","title":"Research on Binder","lang":"zh-CN","frontmatter":{"title":"Research on Binder","date":"2023-06-07T00:00:00.000Z","tag":["kernel","Android"],"category":["Android"],"description":"Overview kernel ä¾§å®ç°ï¼škernel/linux-5.10/drivers/android/binder.c native ä¾§å®ç°ï¼šsystem/libhwbinder ğŸ’¯ğŸ’¯ æœ¬æ–‡ä¸»è¦æ˜¯é’ˆå¯¹ binder çš„ç†è§£è¿›è¡Œçš„è¡Œä¸ºï¼Œä»£ç åˆ—ä¸¾å’Œæ–‡å­—ä¹‹é—´å…³è”åº¦ä¸é«˜ï¼Œå¦‚æœæƒ³äº†è§£åŸç†ä½†æ˜¯ä¸æƒ³å¯¹ä»£ç è¿›è¡Œèµ°è¯»çš„ï¼Œå¯ä»¥è·³è¿‡ä»£ç è§£æçš„éƒ¨åˆ†ï¼Œä»¥å…é™·å…¥å¤ªå¤šçš„ç»†...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Research on Binder\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2023-06-07T00:00:00.000Z\\",\\"dateModified\\":\\"2023-06-25T10:21:20.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Someone\\",\\"url\\":\\"https://www.weigao.cc\\"}]}"],["meta",{"property":"og:url","content":"https://vueblog.weigao.cc/java/android/binder.html"}],["meta",{"property":"og:site_name","content":"weigao"}],["meta",{"property":"og:title","content":"Research on Binder"}],["meta",{"property":"og:description","content":"Overview kernel ä¾§å®ç°ï¼škernel/linux-5.10/drivers/android/binder.c native ä¾§å®ç°ï¼šsystem/libhwbinder ğŸ’¯ğŸ’¯ æœ¬æ–‡ä¸»è¦æ˜¯é’ˆå¯¹ binder çš„ç†è§£è¿›è¡Œçš„è¡Œä¸ºï¼Œä»£ç åˆ—ä¸¾å’Œæ–‡å­—ä¹‹é—´å…³è”åº¦ä¸é«˜ï¼Œå¦‚æœæƒ³äº†è§£åŸç†ä½†æ˜¯ä¸æƒ³å¯¹ä»£ç è¿›è¡Œèµ°è¯»çš„ï¼Œå¯ä»¥è·³è¿‡ä»£ç è§£æçš„éƒ¨åˆ†ï¼Œä»¥å…é™·å…¥å¤ªå¤šçš„ç»†..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2023-06-25T10:21:20.000Z"}],["meta",{"property":"article:tag","content":"Android"}],["meta",{"property":"article:tag","content":"kernel"}],["meta",{"property":"article:published_time","content":"2023-06-07T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2023-06-25T10:21:20.000Z"}]]},"git":{"createdTime":1686299488000,"updatedTime":1687688480000,"contributors":[{"name":"weigao chen","username":"","email":"weigao_1995@yeah.net","commits":2}]},"readingTime":{"minutes":16.83,"words":5048},"filePathRelative":"java/android/binder.md","excerpt":"<h2>Overview</h2>\\n<p>kernel ä¾§å®ç°ï¼škernel/linux-5.10/drivers/android/binder.c</p>\\n<p>native ä¾§å®ç°ï¼šsystem/libhwbinder</p>\\n<p>ğŸ’¯ğŸ’¯ æœ¬æ–‡ä¸»è¦æ˜¯é’ˆå¯¹ binder çš„ç†è§£è¿›è¡Œçš„è¡Œä¸ºï¼Œä»£ç åˆ—ä¸¾å’Œæ–‡å­—ä¹‹é—´å…³è”åº¦ä¸é«˜ï¼Œå¦‚æœæƒ³äº†è§£åŸç†ä½†æ˜¯ä¸æƒ³å¯¹ä»£ç è¿›è¡Œèµ°è¯»çš„ï¼Œå¯ä»¥è·³è¿‡ä»£ç è§£æçš„éƒ¨åˆ†ï¼Œä»¥å…é™·å…¥å¤ªå¤šçš„ç»†èŠ‚ã€‚</p>\\n<h2>IPC é€šä¿¡</h2>\\n<p>binder ç›¸æ¯”äºä¼ ç»Ÿçš„ IPC é€šä¿¡æ‹¥æœ‰æ¯”è¾ƒå¤§çš„ä¼˜åŠ¿ï¼šå…¶åªéœ€è¦è¿›è¡Œä¸€æ¬¡æ‹·è´ã€‚IPC é€šä¿¡çš„åŸç†å¤§è‡´å¦‚ä¸‹ï¼š</p>\\n<h2>Binder çº¿ç¨‹æ± </h2>","autoDesc":true}');export{g as comp,y as data};
