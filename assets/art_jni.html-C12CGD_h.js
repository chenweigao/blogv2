import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as l,d as i,e as h,r as t,o as e}from"./app-11Vuyqh7.js";const k={};function p(d,s){const a=t("Mermaid");return e(),l("div",null,[s[0]||(s[0]=i('<p>本篇文章主要是研究 ART 虚拟机中的 native 方法相关的处理流程，凡是涉及到 native 相关的，都会在本篇文章中进行收录。</p><ol><li>JNI 原理、基础知识</li><li>Java native 函数的定义、使用以及编译</li><li>JNI 层的实现</li><li>native 函数注册的流程、函数等</li></ol><h2 id="abstract" tabindex="-1"><a class="header-anchor" href="#abstract"><span>Abstract</span></a></h2><p>本文分为几个部分：</p><ol><li>第一个部分研究 <code>libcore</code> 中的一个 <code>@FastNative</code> 例子，通过这个例子简单了解 Java native 函数的基本调用流程；</li><li>native 函数的总结：分为几张图标进行说明；</li></ol><h2 id="jni" tabindex="-1"><a class="header-anchor" href="#jni"><span>JNI</span></a></h2><h3 id="abstract-1" tabindex="-1"><a class="header-anchor" href="#abstract-1"><span>Abstract</span></a></h3><p>JNI 的全称是 Java Native Interface, 通过 JNI 技术，可以做到以下几点：</p><ol><li>Java 程序中可以调用 Native 语言写的函数；一般是 C/C++ 编写的函数；</li><li>Native 程序中的函数可以调用 JAVA 层的函数；也就是说 在 C/C++ 中可以调用 JAVA 层的函数；</li></ol><p>仔细思考一下，如果引用了 JNI, 是不是就破坏了 JAVA 的平台无关性呢？其实不尽然，引入 JNI 有以下的好处：</p><ol><li>JAVA 虚拟机是由 Native 语言写的，并不是平台无关的，而 JNI 层可以对 JAVA 层屏蔽平台之间的差异，有助于实现 JAVA 本身平台无关的特性；</li><li>很多程序都用 Native 语言写的，用 JNI 就可以直接使用了，避免了重复造轮子。</li></ol><h3 id="java-world-to-native-world" tabindex="-1"><a class="header-anchor" href="#java-world-to-native-world"><span>JAVA World to Native World</span></a></h3><p>这个问题是萦绕在初学 JNI 的时候一个很大的问题，到底 Java 是如何调用 Native 的函数的呢？首先先看 Java 世界、JNI 世界和 Native 世界之间的关系：</p>',13)),h(a,{id:"mermaid-86",code:"eJxLL0osyFAIceFSUHDW8HIMc1R4smPa86k9mrq6dgouGl5+ngpPNzZpKoC4rhp+iSWZZakwJSA9hhq+qSmZicHJiXl5qUUQdS6GGjmZSbkg8fisvEy94nyofoQ4SIwLADWPKOg="}),s[1]||(s[1]=i(`<p>除此之外，为了方便理解，再图上增加了一个 <code>MediaScanner</code> 实例进行说明。</p><ul><li><code>MediaScanner</code> 类中的一些功能需要由 Native 层来实现</li><li>JNI 层对应 <code>media_jni</code> 库，库的名字是 <code>media</code>, <code>jni</code> 表示的是这个一个 JNI 库</li><li>Native 的 <code>libmedia.so</code> 完成了实际的功能</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // media / java / android / media / MediaScanner.java</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;"> MediaScanner</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    static</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // 加载对应的 JNI 库</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // 在实际加载动态库的时候会将其拓展称为 libmedia_jni.so</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">        System</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">loadLibrary</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">media_jni</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">        // 调用 native_init() 函数</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">        native_init</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ..</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // native 函数的声明；被 native 标识的函数表示它将由 JNI 层完成</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> native</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> processDirectory</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;">String</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> path</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#8FBCBB;"> MediaScannerClient</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> client</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ..</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>在调用 native 函数之前，需要进行 JNI 库的加载；关于加载 JNI 库的时机，通用的做法是在类的 <code>static</code> 语句中加载，加载的方法是调用 <code>System.loadLibrary</code> 方法，需要注意 JNI 库的加载必须是在 native 函数调用之前；</li><li>JAVA 程序员调用 JNI 中的函数还需要使用 native 关键字声明函数。</li></ol><p>从上我们可以看出，JNI 的使用对于 JAVA 程序员是非常友好的。</p><h3 id="jni-层分析" tabindex="-1"><a class="header-anchor" href="#jni-层分析"><span>JNI 层分析</span></a></h3><p>@todo</p><h3 id="静态注册-vs-动态注册" tabindex="-1"><a class="header-anchor" href="#静态注册-vs-动态注册"><span>静态注册 vs 动态注册</span></a></h3><p>@todo</p><h2 id="jni-code-analysis" tabindex="-1"><a class="header-anchor" href="#jni-code-analysis"><span>JNI Code Analysis</span></a></h2><p>这篇博客<sup class="footnote-ref"><a href="#footnote1">[1]</a><a class="footnote-anchor" id="footnote-ref1"></a></sup>有一个给 libcore 增加日志的例子，全流程的走了一遍 native 方法创建、注册的过程，而我们选择的例子为 <code>libcore</code> 中 JDK 的实现。</p><h3 id="java-native" tabindex="-1"><a class="header-anchor" href="#java-native"><span>Java Native</span></a></h3><p>Native Java 的代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// libcore/ojluni/src/main/java/java/lang/String.java</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#D08770;">FastNative</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">native</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> getCharsNoCheck</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> start</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> char</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述函数使用 <code>@FastNative</code> 注解修饰，函数声明前的 <code>native</code> 表示这是一个 native 方法。</p><p>在 <code>libcore/openjdk_java_files.bp</code> 中可以看到 <code>String.java</code> 文件，表示其在<strong>编译链</strong>中。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span>filegroup {</span></span>
<span class="line"><span>    name: &quot;openjdk_javadoc_files&quot;,</span></span>
<span class="line"><span>    srcs: [</span></span>
<span class="line"><span>        &quot;ojluni/src/main/java/java/awt/font/NumericShaper.java&quot;,</span></span>
<span class="line"><span>        // more code ...</span></span>
<span class="line"><span>        &quot;ojluni/src/main/java/java/lang/String.java&quot;,</span></span>
<span class="line"><span>        // ...</span></span>
<span class="line"><span>    ],</span></span>
<span class="line"><span>    path: &quot;ojluni/src/main/java&quot;,</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="jni-定义" tabindex="-1"><a class="header-anchor" href="#jni-定义"><span>JNI 定义</span></a></h3><h4 id="register-java-lang-string" tabindex="-1"><a class="header-anchor" href="#register-java-lang-string"><span>register_java_lang_String</span></a></h4><p>JNI 层负责实现 <code>getCharsNoCheck</code>, 实现过后会被注册，此时就与 Java 层的 native 方法对应起来了，对于 <code>getCharsNoCheck</code> 的注册过程如下：</p><p>在 <code>.hh</code> 中：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// art/runtime/native/java_lang_String.h</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#ifndef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> ART_RUNTIME_NATIVE_JAVA_LANG_STRING_H_</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> ART_RUNTIME_NATIVE_JAVA_LANG_STRING_H_</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">include</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">jni.h</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">namespace</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> art</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> register_java_lang_String</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">JNIEnv</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // namespace art</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">endif</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // ART_RUNTIME_NATIVE_JAVA_LANG_STRING_H_</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>.cc</code> 中进行注册：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> String_getCharsNoCheck</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">JNIEnv</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> jobject</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> java_this</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> jint</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> start</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> jint</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">                                   jcharArray</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> jint</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // ScopedFastNativeObjectAccess 中保存了 env 对象以及其所在的 Thread 对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  ScopedFastNativeObjectAccess </span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">soa</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // 从 soa.Self 中获取 JNIEnv 所在的线程对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  StackHandleScope</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> hs</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">soa</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Self</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">())</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // 获取 buffer 的指针</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  Handle</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">mirror</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">CharArray</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> char_array</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">hs</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">NewHandle</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">soa</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">Decode</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">mirror</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">CharArray</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // 获取 jobject 指针后调用 GetChars</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">  soa</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">Decode</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">mirror</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">String</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">java_this</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetChars</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> char_array</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> JNINativeMethod gMethods[] </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  FAST_NATIVE_METHOD</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> charAt</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">(I)C</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  FAST_NATIVE_METHOD</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> compareTo</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">(Ljava/lang/String;)I</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  FAST_NATIVE_METHOD</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> concat</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">(Ljava/lang/String;)Ljava/lang/String;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  FAST_NATIVE_METHOD</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> doReplace</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">(CC)Ljava/lang/String;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  FAST_NATIVE_METHOD</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> fastSubstring</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">(II)Ljava/lang/String;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  FAST_NATIVE_METHOD</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> getCharsNoCheck</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">(II[CI)V</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  FAST_NATIVE_METHOD</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> intern</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">()Ljava/lang/String;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  FAST_NATIVE_METHOD</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> toCharArray</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">()[C</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> register_java_lang_String</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">JNIEnv</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  REGISTER_NATIVE_METHODS</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">java/lang/String</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到此，我们对 <code>register_java_lang_String</code> 进行了定义，调用这个函数就可以进行 native 函数的注册。</p><h4 id="register-native-methods" tabindex="-1"><a class="header-anchor" href="#register-native-methods"><span>REGISTER_NATIVE_METHODS</span></a></h4><p>对于宏 <code>REGISTER_NATIVE_METHODS</code>，其定义如下：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// art/runtime/native/native_util.h</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> REGISTER_NATIVE_METHODS</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">jni_class_name</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;"> \\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  RegisterNativeMethodsInternal</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;">jni_class_name</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">),</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;"> gMethods</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> arraysize</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#5E81AC;">gMethods</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">}</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // namespace art</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ALWAYS_INLINE </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">inline</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> RegisterNativeMethodsInternal</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">JNIEnv</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                                                        const</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> char*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> jni_class_name</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                                                        const</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> JNINativeMethod</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> methods</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">                                                        jint method_count</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  ScopedLocalRef</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">jclass</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">FindClass</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">jni_class_name</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">c</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    LOG</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">FATAL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">Couldn&#39;t find class: </span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> jni_class_name</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  jint jni_result </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">RegisterNatives</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">c</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(),</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> methods</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> method_count</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  CHECK_EQ</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">JNI_OK</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> jni_result</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也就是说 <code>register_java_lang_String()</code> 最终是调用了 <code>RegisterNativeMethodsInternal()</code>, 传入了 class name, 全局的 gMethods, 以及计算出来的 count.</p><p>@todo log 后增加分析结果</p><p>对于宏 <code>FAST_NATIVE_METHOD</code> 我在源码中未找到其定义，但是根据其用法，不难发现，三个参数应该分别是：类名（函数指针）、函数名、函数参数和返回值（signature）。</p><p>那么接下来的问题就只剩下：是谁调用了 <code>register_java_lang_String()</code> 进行了 native 函数的注册呢？我们进行下一章节的旅程。</p><h3 id="jni-注册" tabindex="-1"><a class="header-anchor" href="#jni-注册"><span>JNI 注册</span></a></h3><h4 id="initnativemethods" tabindex="-1"><a class="header-anchor" href="#initnativemethods"><span>InitNativeMethods</span></a></h4><p>除此之外，我们搜索全局的<code>register_java_lang_String</code> 发现，还在一处出现：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// art/runtime/runtime.cc</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> Runtime</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">RegisterRuntimeNativeMethods</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">JNIEnv</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  register_dalvik_system_DexFile</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  register_java_lang_String</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  register_java_lang_StringFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个函数的调用也是在这个文件中的 <code>InitNativeMethods</code> 函数（这个文件比较重要，所以全部列举出来了）：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> Runtime</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">InitNativeMethods</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  VLOG</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">startup</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">Runtime::InitNativeMethods entering</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  Thread</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> self </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Current</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  JNIEnv</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> env </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetJniEnv</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // Must be in the kNative state for calling native methods (JNI_OnLoad code).</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  CHECK_EQ</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">GetState</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(),</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> kNative</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // Set up the native methods provided by the runtime itself.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  RegisterRuntimeNativeMethods</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // Initialize classes used in JNI. The initialization requires runtime native</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // methods to be loaded first.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">  WellKnownClasses</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Init</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // Then set up libjavacore / libopenjdk / libicu_jni ,which are just</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // a regular JNI libraries with a regular JNI_OnLoad. Most JNI libraries can</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // just use System.loadLibrary, but libcore can&#39;t because it&#39;s the library</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // that implements System.loadLibrary!</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  //</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // By setting calling class to java.lang.Object, the caller location for these</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // JNI libs is core-oj.jar in the ART APEX, and hence they are loaded from the</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // com_android_art linker namespace.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // libicu_jni has to be initialized before libopenjdk{d} due to runtime dependency from</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // libopenjdk{d} to Icu4cMetadata native methods in libicu_jni. See http://b/143888405</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">string error_msg</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">java_vm_</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">LoadNativeLibrary</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">          env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">libicu_jni.so</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> WellKnownClasses</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">java_lang_Object</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">error_msg</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">      LOG</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">FATAL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">LoadNativeLibrary failed for </span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">libicu_jni.so</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> error_msg</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">string error_msg</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">java_vm_</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">LoadNativeLibrary</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">          env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">libjavacore.so</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> WellKnownClasses</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">java_lang_Object</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">error_msg</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">      LOG</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">FATAL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">LoadNativeLibrary failed for </span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">libjavacore.so</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> error_msg</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    constexpr</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> const</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> char*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> kOpenJdkLibrary </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> kIsDebugBuild</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                                                ?</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">libopenjdkd.so</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">                                                :</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">libopenjdk.so</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">string error_msg</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">java_vm_</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">LoadNativeLibrary</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">          env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> kOpenJdkLibrary</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> WellKnownClasses</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">java_lang_Object</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">error_msg</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">      LOG</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">FATAL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">LoadNativeLibrary failed for </span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> kOpenJdkLibrary </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#EBCB8B;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> error_msg</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // Initialize well known classes that may invoke runtime native methods.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;">  WellKnownClasses</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">LateInit</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // check startup module ready 后再打印日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  VLOG</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">startup</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">Runtime::InitNativeMethods exiting</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第 10 行调用了 <code>RegisterRuntimeNativeMethods</code>, 后面的很多过程也很重要，我们后续再进行研究。</p><div class="hint-container tip"><p class="hint-container-title">Runtime::InitNativeMethods entering</p><p>注意到有一行日志 <code>VLOG(startup) &lt;&lt; &quot;Runtime::InitNativeMethods entering&quot;;</code>, 我们可以通过在日志中查找是否有这个对应的打印来确定启动的时候是否调用到了这个流程（因为调用链还涉及到很多非常复杂的过程，所以我们可以通过这个方式来进行验证）</p><p>@todo 验证后填写结论</p></div><h4 id="runtime-start" tabindex="-1"><a class="header-anchor" href="#runtime-start"><span>Runtime::Start</span></a></h4><p>而<code>InitNativeMethods</code> 函数在 <code>Runtime::Start()</code> 中被调用：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D8DEE9FF;"> Runtime</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">Start</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // ...code </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // InitNativeMethods needs to be after started_ so that the classes</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // it touches will have methods linked to the oat file if necessary.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    ScopedTrace </span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">trace2</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">InitNativeMethods</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    InitNativeMethods</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">  // .. code</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来的过程就是涉及到 JVM 进程的启动等知识了。</p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="footnote1" class="footnote-item"><p><a href="https://blog.csdn.net/u011426115/article/details/113032671" target="_blank" rel="noopener noreferrer">Java核心库libcore中添加Log接口任意调用（Android10）</a> <a href="#footnote-ref1" class="footnote-backref">↩︎</a></p></li></ol></section>`,46))])}const F=n(k,[["render",p]]),g=JSON.parse('{"path":"/java/art/art_jni.html","title":"ART JNI","lang":"zh-CN","frontmatter":{"title":"ART JNI","date":"2022-10-27T00:00:00.000Z","tag":["jvm","java"],"category":["JAVA"],"description":"本篇文章主要是研究 ART 虚拟机中的 native 方法相关的处理流程，凡是涉及到 native 相关的，都会在本篇文章中进行收录。 JNI 原理、基础知识 Java native 函数的定义、使用以及编译 JNI 层的实现 native 函数注册的流程、函数等","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"ART JNI\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2022-10-27T00:00:00.000Z\\",\\"dateModified\\":\\"2023-02-28T13:00:35.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Someone\\",\\"url\\":\\"https://www.weigao.cc\\"}]}"],["meta",{"property":"og:url","content":"https://vueblog.weigao.cc/java/art/art_jni.html"}],["meta",{"property":"og:site_name","content":"weigao"}],["meta",{"property":"og:title","content":"ART JNI"}],["meta",{"property":"og:description","content":"本篇文章主要是研究 ART 虚拟机中的 native 方法相关的处理流程，凡是涉及到 native 相关的，都会在本篇文章中进行收录。 JNI 原理、基础知识 Java native 函数的定义、使用以及编译 JNI 层的实现 native 函数注册的流程、函数等"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2023-02-28T13:00:35.000Z"}],["meta",{"property":"article:tag","content":"java"}],["meta",{"property":"article:tag","content":"jvm"}],["meta",{"property":"article:published_time","content":"2022-10-27T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2023-02-28T13:00:35.000Z"}]]},"git":{"createdTime":1666881211000,"updatedTime":1677589235000,"contributors":[{"name":"chenweigao","username":"chenweigao","email":"297859260@qq.com","commits":3,"url":"https://github.com/chenweigao"},{"name":"weigao chen","username":"","email":"weigao_1995@yeah.net","commits":1}]},"readingTime":{"minutes":6.25,"words":1876},"filePathRelative":"java/art/art_jni.md","excerpt":"<p>本篇文章主要是研究 ART 虚拟机中的 native 方法相关的处理流程，凡是涉及到 native 相关的，都会在本篇文章中进行收录。</p>\\n<ol>\\n<li>JNI 原理、基础知识</li>\\n<li>Java native 函数的定义、使用以及编译</li>\\n<li>JNI 层的实现</li>\\n<li>native 函数注册的流程、函数等</li>\\n</ol>\\n","autoDesc":true}');export{F as comp,g as data};
