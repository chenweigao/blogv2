import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as t,d as a,o as n}from"./app-11Vuyqh7.js";const e={};function l(p,s){return n(),t("div",null,s[0]||(s[0]=[a(`<p>AMD IBS（Instruction-Based Sampling，基于指令采样）是 AMD 处理器中一项硬件级性能分析技术，用于监控和记录处理器执行的指令流，为开发者和系统管理员提供细粒度的性能洞察。</p><h2 id="_1-ibs" tabindex="-1"><a class="header-anchor" href="#_1-ibs"><span>1. IBS?</span></a></h2><p>IBS 是一种<strong>基于已执行指令</strong>的硬件采样技术。与传统基于事件计数的采样（如周期、缓存未命中等）不同，IBS 能够采集<strong>指令级别</strong>的丰富信息，比如：</p><ul><li><p>每条采样指令是否命中 L1/L2/L3 缓存</p></li><li><p>是否发生 TLB miss</p></li><li><p>分支预测是否成功</p></li><li><p>指令类型（load、store、branch、ret 等）</p></li><li><p>执行延迟、流水线 stalls 情况</p></li><li><p>内存地址访问路径（可选）</p></li></ul><h2 id="_2-ibs-的两种采样模式" tabindex="-1"><a class="header-anchor" href="#_2-ibs-的两种采样模式"><span>2. IBS 的两种采样模式</span></a></h2><p>IBS 提供两种模式：</p><h3 id="_2-1-ibs-fetch-sampling-ibs-fetch" tabindex="-1"><a class="header-anchor" href="#_2-1-ibs-fetch-sampling-ibs-fetch"><span>2.1. <strong>IBS Fetch Sampling（IBS-Fetch）</strong></span></a></h3><ul><li><p>针对<strong>指令获取阶段</strong>。</p></li><li><p>可分析：</p><ul><li><p>指令是否来自 L1 I-cache</p></li><li><p>指令 TLB miss</p></li><li><p>ITLB/TLB walk 等</p></li></ul></li></ul><h3 id="_2-2-ibs-operation-sampling-ibs-op" tabindex="-1"><a class="header-anchor" href="#_2-2-ibs-operation-sampling-ibs-op"><span>2.2. <strong>IBS Operation Sampling（IBS-Op）</strong></span></a></h3><ul><li><p>针对<strong>指令执行阶段</strong>。</p></li><li><p>可分析：</p><ul><li><p>指令是否为 Load/Store</p></li><li><p>Load 是否命中 L1/L2/L3 或内存</p></li><li><p>Load 延迟、分支指令是否预测成功</p></li><li><p>Load 地址（可选开启）</p></li></ul></li></ul><h2 id="_3-优缺点" tabindex="-1"><a class="header-anchor" href="#_3-优缺点"><span>3. 优缺点</span></a></h2><p>下面是 IBS 的优点列举：</p><table><thead><tr><th><strong>特性</strong></th><th><strong>优势</strong></th></tr></thead><tbody><tr><td>精确性</td><td>每条采样指令都已实际执行，避免“猜测”</td></tr><tr><td>低开销</td><td>硬件实现，支持大规模部署</td></tr><tr><td>可获取微架构细节</td><td>如分支预测失败、流水线停顿等</td></tr><tr><td>支持用户态/内核态分析</td><td>便于深入系统级性能瓶颈分析</td></tr></tbody></table><h2 id="_4-用法解析" tabindex="-1"><a class="header-anchor" href="#_4-用法解析"><span>4. 用法解析</span></a></h2><div class="hint-container tip"><p class="hint-container-title">提示</p><p>确保内核已经安装 IBS 驱动。</p></div><h3 id="_4-1-使用-perf-采集" tabindex="-1"><a class="header-anchor" href="#_4-1-使用-perf-采集"><span>4.1. 使用 perf 采集</span></a></h3><p>我们选取 AMD 的 Genoa 机型举例，使用如下命令采集 IBS 数据：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">perf</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> record</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -c</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 1000000</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -C0-7</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -a</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> ibs_op/l3missonly=1/</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> --raw-samples</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 30</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>0-7 core 表示 CCD 0, <code>-c 1000000</code> 表示每 100w 条指令采样一次，l3missonly 表示只监控 l3 miss 的指令，类似于一个 filter 的作用。</p><p>其输出是所有 load/store 指令的相关信息，我们使用下面命令对输出进行筛选并求平均值，就可以拿到访存指令的 Miss Latency：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">perf</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> report</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -D</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -B4</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">PERF_RECORD_SAMPLE</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -A5</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">DRAM</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">DcMissLat.......</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">{sum += $2; count++} END {if (count &gt; 0) print sum / count}</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_4-2-技术原理简述" tabindex="-1"><a class="header-anchor" href="#_4-2-技术原理简述"><span>4.2. 技术原理简述</span></a></h3><p><code>ibs_op/l3missonly=1/</code> 用于指定 <strong>只采样那些导致 L3 cache miss 的 load/store 指令</strong>。开启该选项时，<strong>只有穿透 L3 cache，访问 DRAM 或远程 CCD 的 memory 操作才会被采样</strong>。也就是说，<strong>只会记录那些因为 L3 cache miss 而最终访问 DRAM 或远程 CCD 的 load/store 指令。</strong></p><p><strong>导致 L3 Cache Miss 的指令</strong>，通常是 memory load/store 指令，具体包括：</p><table><thead><tr><th><strong>类型</strong></th><th><strong>示例</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><strong>Load</strong></td><td>mov rax, [rbx]</td><td>从内存读取，未在 L3 命中（访问 DRAM 或远程）</td></tr><tr><td><strong>Store</strong></td><td>mov [rcx], rdx</td><td>少数 store 也可能触发读取（如 write-allocate），未命中 L3</td></tr><tr><td><strong>Prefetch</strong></td><td>prefetcht0 [rsi]</td><td>若触发实际 memory 访问且 L3 miss，也可能记录</td></tr><tr><td><strong>特殊指令</strong></td><td>取决于是否访问 memory</td><td>比如 cmp [rdi], eax 也涉及 load</td></tr></tbody></table><p><strong>不会采样的指令：</strong></p><table><thead><tr><th><strong>类型</strong></th><th><strong>原因</strong></th></tr></thead><tbody><tr><td>L1 或 L2 命中</td><td>不满足 L3 miss 条件</td></tr><tr><td>L3 命中</td><td>被过滤掉（不设置 l3missonly=0 就不会记录）</td></tr><tr><td>非访存指令（ALU、branch、NOP等）</td><td>不涉及 memory load/store，自然不会触发采样</td></tr><tr><td>Instruction fetch（指令本身）</td><td>ibs_op 是采样 <strong>data 操作指令</strong>，不关注取指行为</td></tr></tbody></table><p>IBS 在每个周期可捕获一条指令的详细微架构信息。设置 l3missonly=1 后：</p><ul><li><p>IBS 会观察 micro-op 是否触发了 memory 访问；</p></li><li><p>如果访问 L3 时没有命中（即发生 L3 miss）；</p></li><li><p>且满足采样周期条件（如 -c 1000000）；</p></li><li><p>则记录该指令样本，包括：</p><ul><li><p>虚拟/物理地址</p></li><li><p>DRAM 延迟（DcMissLat=xxx）</p></li><li><p>访存类型（load/store）</p></li><li><p>是否在 NUMA 本地 / 远程</p></li></ul></li></ul><h2 id="_5-内容解析" tabindex="-1"><a class="header-anchor" href="#_5-内容解析"><span>5. 内容解析</span></a></h2><h3 id="_5-1-概览" tabindex="-1"><a class="header-anchor" href="#_5-1-概览"><span>5.1. 概览</span></a></h3><p>我们列举其中的一个 sample:</p><div class="language-txt line-numbers-mode" data-highlighter="shiki" data-ext="txt" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span>0x17e310 [0x78]: event: 9</span></span>
<span class="line"><span>.</span></span>
<span class="line"><span>. ... raw event: size 120 bytes</span></span>
<span class="line"><span>.  0000:  09 00 00 00 01 40 78 00 26 35 14 81 ff ff ff ff  .....@x.&amp;5......</span></span>
<span class="line"><span>.  0010:  00 00 00 00 00 00 00 00 7b 16 49 89 e4 6b 00 00  ........{.I..k..</span></span>
<span class="line"><span>.  0020:  aa 83 01 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span></span>
<span class="line"><span>.  0030:  44 00 00 00 ff 0b 00 00 24 f4 07 00 41 05 00 00  D.......$...A...</span></span>
<span class="line"><span>.  0040:  26 35 14 81 ff ff ff ff 00 02 f7 04 00 00 00 00  &amp;5..............</span></span>
<span class="line"><span>.  0050:  23 00 00 00 00 00 00 00 a1 00 d7 14 dc 01 00 00  #...............</span></span>
<span class="line"><span>.  0060:  84 57 3b 7c 9f 89 ff ff 84 57 3b 7c 1f 01 00 00  .W;|.....W;|....</span></span>
<span class="line"><span>.  0070:  34 35 14 81 ff ff ff ff                          45......        </span></span>
<span class="line"><span></span></span>
<span class="line"><span>ibs_op_ctl: 000005410007f424 MaxCnt   1000000 L3MissOnly 1 En 1 Val 1 CntCtl 0=cycles CurCnt      1345</span></span>
<span class="line"><span>IbsOpRip: ffffffff81143526</span></span>
<span class="line"><span>ibs_op_data: 0000000004f70200 CompToRetCtr   512 TagToRetCtr  1271 BrnRet 0  RipInvalid 0 BrnFuse 0 Microcode 0</span></span>
<span class="line"><span>ibs_op_data2: 0000000000000023 RmtNode 0 DataSrc 3=DRAM</span></span>
<span class="line"><span>ibs_op_data3: 000001dc14d700a1 LdOp 1 StOp 0 DcL1TlbMiss 0 DcL2TlbMiss 0 DcL1TlbHit2M 0 DcL1TlbHit1G 1 DcL2TlbHit2M 0 DcMiss 1 DcMisAcc 0 DcWcMemAcc 0 DcUcMemAcc 0 DcLockedOp 0 DcMissNoMabAlloc 1 DcLinAddrValid 1 DcPhyAddrValid 1 DcL2TlbHit1G 0 L2Miss 1 SwPf 0 OpMemWidth  4 bytes OpDcMissOpenMemReqs  5 DcMissLat   476 TlbRefillLat     0</span></span>
<span class="line"><span>IbsDCLinAd: ffff899f7c3b5784</span></span>
<span class="line"><span>IbsDCPhysAd: 0000011f7c3b5784</span></span>
<span class="line"><span>0 118629299983995 0x17e310 [0x78]: PERF_RECORD_SAMPLE(IP, 0x4001): 0/0: 0xffffffff81143526 period: 1000000 addr: 0</span></span>
<span class="line"><span> ... thread: swapper:0</span></span>
<span class="line"><span> ...... dso: /proc/kcore</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>样本结构简要概览：</p><table><thead><tr><th><strong>字段</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>event: 9</td><td>表示 PERF_RECORD_SAMPLE 类型事件</td></tr><tr><td>raw event: size 120 bytes</td><td>原始样本数据大小</td></tr><tr><td>ibs_op_ctl</td><td>IBS 控制字段：采样周期、是否只采样 L3 miss、当前计数等</td></tr><tr><td>IbsOpRip</td><td>被采样指令的虚拟地址（RIP）</td></tr><tr><td>ibs_op_data</td><td>包含分支、指令完成到 retire 的延迟等</td></tr><tr><td>ibs_op_data2</td><td>数据来源（如 DRAM、本地/远程 node）</td></tr><tr><td>ibs_op_data3</td><td>包括访存类型、是否 miss、是否 locked、延迟等详细信息</td></tr><tr><td>IbsDCLinAd</td><td>访存指令的 virtual address</td></tr><tr><td>IbsDCPhysAd</td><td>访存指令的 physical address</td></tr><tr><td>PERF_RECORD_SAMPLE</td><td>样本事件总结，包括指令地址、触发周期、线程等</td></tr></tbody></table><p>接下来进行逐行解析：</p><h3 id="_5-2-ibs-op-ctl" tabindex="-1"><a class="header-anchor" href="#_5-2-ibs-op-ctl"><span>5.2. ibs_op_ctl</span></a></h3><blockquote><p>ibs_op_ctl: 000005410007f424 MaxCnt 1000000 L3MissOnly 1 En 1 Val 1 CntCtl 0=cycles CurCnt 1345</p></blockquote><p>属于控制字段，拆解如下：</p><table><thead><tr><th><strong>位字段</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>MaxCnt = 1000000</td><td>设置每采样一次需执行的指令数（周期）</td></tr><tr><td>L3MissOnly = 1</td><td><strong>只采样 L3 miss 的访存指令</strong></td></tr><tr><td>En = 1</td><td>采样启用</td></tr><tr><td>Val = 1</td><td>当前样本有效</td></tr><tr><td>CurCnt = 1345</td><td>当前样本指令周期倒数计数（用于调节分布）</td></tr><tr><td>CntCtl 0 = cycles</td><td>使用周期控制采样（而非 retired 指令数）</td></tr></tbody></table><h3 id="_5-3-ibsoprip" tabindex="-1"><a class="header-anchor" href="#_5-3-ibsoprip"><span>5.3. IbsOpRip</span></a></h3><blockquote><p>IbsOpRip: ffffffff81143526</p></blockquote><p>采样到的 <strong>指令虚拟地址（RIP）</strong>：</p><ul><li><p>该例子对应内核空间：ffffffff81xxxxxx，可能是某个内核函数中发生的访存</p></li><li><p>可用 <code>addr2line -e /boot/vmlinux ffffffff81143526</code> 映射函数名</p></li></ul><h3 id="_5-4-ibs-op-data" tabindex="-1"><a class="header-anchor" href="#_5-4-ibs-op-data"><span>5.4. ibs_op_data</span></a></h3><blockquote><p>ibs_op_data: 0000000004f70200 CompToRetCtr 512 TagToRetCtr 1271 BrnRet 0 RipInvalid 0 BrnFuse 0 Microcode 0</p></blockquote><table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>CompToRetCtr = 512</td><td>指令完成到 retire 的延迟</td></tr><tr><td>TagToRetCtr = 1271</td><td>分派到 retire 之间的延迟（可能表示 pipeline stall）</td></tr><tr><td>BrnRet = 0</td><td>非分支指令</td></tr><tr><td>Microcode = 0</td><td>非 microcode 执行</td></tr><tr><td>RipInvalid = 0</td><td>RIP 有效</td></tr></tbody></table><h3 id="_5-5-ibs-op-data2" tabindex="-1"><a class="header-anchor" href="#_5-5-ibs-op-data2"><span>5.5. ibs_op_data2</span></a></h3><blockquote><p>ibs_op_data2: 0000000000000023 RmtNode 0 DataSrc 3=DRAM</p></blockquote><table><thead><tr><th><strong>字段</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>RmtNode = 0</td><td>本地 NUMA node</td></tr><tr><td>DataSrc = 3</td><td><strong>数据来源是 DRAM</strong>（常见编码：3=DRAM，4=远程，6=IO 等）</td></tr></tbody></table><h3 id="_5-6-ibs-op-data3" tabindex="-1"><a class="header-anchor" href="#_5-6-ibs-op-data3"><span>5.6. ibs_op_data3</span></a></h3><blockquote><p>ibs_op_data3: 000001dc14d700a1 LdOp 1 StOp 0 DcL1TlbMiss 0 DcL2TlbMiss 0 DcL1TlbHit2M 0 DcL1TlbHit1G 1 DcL2TlbHit2M 0 DcMiss 1 DcMisAcc 0 DcWcMemAcc 0 DcUcMemAcc 0 DcLockedOp 0 DcMissNoMabAlloc 1 DcLinAddrValid 1 DcPhyAddrValid 1 DcL2TlbHit1G 0 L2Miss 1 SwPf 0 OpMemWidth 4 bytes OpDcMissOpenMemReqs 5 DcMissLat 476 TlbRefillLat 0</p></blockquote><p>这是最关键的字段之一，包含了 memory 延迟与 miss 类型，逐项如下：</p><table><thead><tr><th><strong>字段</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>LdOp = 1</td><td>是 load 指令</td></tr><tr><td>StOp = 0</td><td>非 store 指令</td></tr><tr><td>DcMiss = 1</td><td>数据 cache miss</td></tr><tr><td>L2Miss = 1</td><td>L2 miss</td></tr><tr><td><mark>DcMissLat = 476</mark></td><td><strong>内存访问延迟为 476 cycles</strong>（重点）</td></tr><tr><td>OpMemWidth = 4</td><td>操作内存宽度为 4 字节</td></tr><tr><td>OpDcMissOpenMemReqs = 5</td><td>此时 memory pipeline 有 5 个 outstanding 请求</td></tr><tr><td>DcLockedOp = 0</td><td>非锁操作</td></tr><tr><td>DcLinAddrValid = 1 / DcPhyAddrValid = 1</td><td>地址有效</td></tr><tr><td>TlbRefillLat = 0</td><td>没有 TLB refill latency</td></tr><tr><td>DcL1TlbMiss = 0 / DcL2TlbMiss = 0</td><td>没有 TLB miss</td></tr></tbody></table><h3 id="_5-7-ibsdclinad-ibsdcphysad" tabindex="-1"><a class="header-anchor" href="#_5-7-ibsdclinad-ibsdcphysad"><span>5.7. IbsDCLinAd / IbsDCPhysAd</span></a></h3><blockquote><p>IbsDCLinAd: ffff899f7c3b5784 IbsDCPhysAd: 0000011f7c3b5784</p></blockquote><table><thead><tr><th><strong>字段</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>IbsDCLinAd = ffff899f7c3b5784</td><td>访存虚拟地址</td></tr><tr><td>IbsDCPhysAd = 0000011f7c3b5784</td><td>映射物理地址（可结合页表分析内存 node）</td></tr></tbody></table><h3 id="_5-8-perf-record-sample-ip" tabindex="-1"><a class="header-anchor" href="#_5-8-perf-record-sample-ip"><span>5.8. PERF_RECORD_SAMPLE(IP...)</span></a></h3><blockquote><p>0 118629299983995 0x17e310 [0x78]: PERF_RECORD_SAMPLE(IP, 0x4001): 0/0: 0xffffffff81143526 period: 1000000 addr: 0 ... thread: swapper:0 ...... dso: /proc/kcore</p></blockquote><p>这是 perf 报告格式，概括该采样点：</p><ul><li><p>PERF_RECORD_SAMPLE(IP, 0x4001)：采样事件，包含指令地址</p></li><li><p>thread: swapper:0：发生于 idle thread</p></li><li><p>dso: /proc/kcore：说明是在内核执行过程中被采样（非用户态）</p></li></ul><h2 id="_6-监控使能" tabindex="-1"><a class="header-anchor" href="#_6-监控使能"><span>6. 监控使能</span></a></h2><p>对于在日常监控中使能 IBS 并且监控 DcMissLat 指标，有两种方式，分别是使用 perf_event_open + raw IBS 事件和 MSR 直接访问。</p><h3 id="_6-1-使用-perf-event-open-raw-ibs-事件" tabindex="-1"><a class="header-anchor" href="#_6-1-使用-perf-event-open-raw-ibs-事件"><span>6.1. 使用 perf_event_open + raw IBS 事件</span></a></h3><p>Linux 的 perf 子系统支持 IBS 的硬件事件，<strong>通过 perf_event_open() 系统调用直接启用 ibs_op 类型事件</strong>，然后从 ring buffer 中读取采样样本，包括 DcMissLat。</p><blockquote><p>目前正在咨询 ARM Light Spe 是如何实现监控的，将来可以作为参考。</p></blockquote><p>下面是我列举的一个 demo，用于调用接口：</p><p>打开 perf_event_open 配置 ibs_op:</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">include</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#8FBCBB;">linux/perf_event.h</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">include</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#8FBCBB;">asm/unistd.h</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">include</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#8FBCBB;">sys/ioctl.h</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">include</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#8FBCBB;">unistd.h</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">include</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#8FBCBB;">fcntl.h</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-weight:inherit;--shiki-dark:#5E81AC;--shiki-dark-font-weight:bold;">#</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">include</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#8FBCBB;">string.h</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> fd</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> perf_event_attr attr</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">memset</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">attr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> perf_event_attr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">attr.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> PERF_TYPE_RAW</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">   // 对于 IBS，用 RAW 类型</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">attr.size </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> perf_event_attr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">attr.config </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> 0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">           // 0x1 = IBS_OP（ibs_op 控制器）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">attr.sample_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> PERF_SAMPLE_IP </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> PERF_SAMPLE_RAW</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">attr.sample_period </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 1000000</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">attr.exclude_kernel </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">attr.exclude_user </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">attr.disabled </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">attr.read_format </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">fd </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> syscall</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">__NR_perf_event_open</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">attr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>读取 ring buffer 中的采样样本，需要 mmap 一个 ring buffer，然后循环从中读取：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> buf </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> mmap</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#81A1C1;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> mmap_size</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> PROT_READ </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> PROT_WRITE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> MAP_SHARED</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> fd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// 解析 perf_event_header，并从中获取 raw sample 中的 DcMissLat</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>raw sample 是个结构体，DcMissLat 在 <code>ibs_op_data3</code> 字段里，需要解析其中的 bit field：<code>DcMissLat = (ibs_op_data3 &gt;&gt; 32) &amp; 0xFFFF</code></p><h3 id="_6-2-msr-直接访问" tabindex="-1"><a class="header-anchor" href="#_6-2-msr-直接访问"><span>6.2. MSR 直接访问</span></a></h3><p>可以访问 IBS 的硬件 MSR（model specific registers）来启用采样：</p><table><thead><tr><th><strong>名称</strong></th><th><strong>编号</strong></th><th><strong>说明</strong></th><th></th></tr></thead><tbody><tr><td>IBS_OP_CTL</td><td>0xC0011033</td><td>控制器寄存器</td><td></td></tr><tr><td>IBS_OP_DATA3</td><td>0xC001103B</td><td>包含 DcMissLat 等信息</td><td></td></tr><tr><td>IBS_OP_RIP</td><td>0xC0011035</td><td>指令地址</td><td></td></tr><tr><td>IBS_OP_DATA</td><td>0xC0011036</td><td>执行状态</td><td></td></tr></tbody></table><p>可以通过 rdmsr_on_cpu() + 定时中断轮询方式采集，但这种方法依赖内核权限。</p>`,76)]))}const r=i(e,[["render",l]]),k=JSON.parse('{"path":"/architecture/ibs.html","title":"AMD IBS","lang":"zh-CN","frontmatter":{"title":"AMD IBS","date":"2025-05-07T00:00:00.000Z","tags":["architecture","x86"],"description":"AMD IBS（Instruction-Based Sampling，基于指令采样）是 AMD 处理器中一项硬件级性能分析技术，用于监控和记录处理器执行的指令流，为开发者和系统管理员提供细粒度的性能洞察。 1. IBS? IBS 是一种基于已执行指令的硬件采样技术。与传统基于事件计数的采样（如周期、缓存未命中等）不同，IBS 能够采集指令级别的丰富信息...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"AMD IBS\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-05-07T00:00:00.000Z\\",\\"dateModified\\":\\"2025-05-12T08:59:22.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Someone\\",\\"url\\":\\"https://www.weigao.cc\\"}]}"],["meta",{"property":"og:url","content":"https://vueblog.weigao.cc/architecture/ibs.html"}],["meta",{"property":"og:site_name","content":"weigao"}],["meta",{"property":"og:title","content":"AMD IBS"}],["meta",{"property":"og:description","content":"AMD IBS（Instruction-Based Sampling，基于指令采样）是 AMD 处理器中一项硬件级性能分析技术，用于监控和记录处理器执行的指令流，为开发者和系统管理员提供细粒度的性能洞察。 1. IBS? IBS 是一种基于已执行指令的硬件采样技术。与传统基于事件计数的采样（如周期、缓存未命中等）不同，IBS 能够采集指令级别的丰富信息..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-05-12T08:59:22.000Z"}],["meta",{"property":"article:tag","content":"x86"}],["meta",{"property":"article:tag","content":"architecture"}],["meta",{"property":"article:published_time","content":"2025-05-07T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-05-12T08:59:22.000Z"}]]},"git":{"createdTime":1746610036000,"updatedTime":1747040362000,"contributors":[{"name":"weigao","username":"weigao","email":"weigao.cwg","commits":1,"url":"https://github.com/weigao"},{"name":"xiaocheng","username":"xiaocheng","email":"weigao.cwg","commits":1,"url":"https://github.com/xiaocheng"}]},"readingTime":{"minutes":7.68,"words":2305},"filePathRelative":"architecture/ibs.md","excerpt":"<p>AMD IBS（Instruction-Based Sampling，基于指令采样）是 AMD 处理器中一项硬件级性能分析技术，用于监控和记录处理器执行的指令流，为开发者和系统管理员提供细粒度的性能洞察。</p>\\n<h2>1. IBS?</h2>\\n<p>IBS 是一种<strong>基于已执行指令</strong>的硬件采样技术。与传统基于事件计数的采样（如周期、缓存未命中等）不同，IBS 能够采集<strong>指令级别</strong>的丰富信息，比如：</p>\\n<ul>\\n<li>\\n<p>每条采样指令是否命中 L1/L2/L3 缓存</p>\\n</li>\\n<li>\\n<p>是否发生 TLB miss</p>\\n</li>\\n<li>\\n<p>分支预测是否成功</p>\\n</li>\\n<li>\\n<p>指令类型（load、store、branch、ret 等）</p>\\n</li>\\n<li>\\n<p>执行延迟、流水线 stalls 情况</p>\\n</li>\\n<li>\\n<p>内存地址访问路径（可选）</p>\\n</li>\\n</ul>","autoDesc":true}');export{r as comp,k as data};
