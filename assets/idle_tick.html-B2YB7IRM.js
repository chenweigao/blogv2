import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as t,d as i,e as l,r as h,o as k}from"./app-11Vuyqh7.js";const e={};function p(d,s){const a=h("Mermaid");return k(),t("div",null,[s[0]||(s[0]=i('<h2 id="abstract" tabindex="-1"><a class="header-anchor" href="#abstract"><span>Abstract</span></a></h2><p>本文研究 tick, 在 kernel 的 idle 流程中，会出现对 tick 的调用，用于进行 idle 状态时钟的控制等。由于其机制复杂，代码量大，故将其单独进行研究。</p><p>本文主要针对于 idle 流程中涉及到的 tick 进行简单研究。</p><h2 id="tick-nohz-idle-stop-tick" tabindex="-1"><a class="header-anchor" href="#tick-nohz-idle-stop-tick"><span>tick_nohz_idle_stop_tick</span></a></h2><p>当出现需要处理的中断时，CPU 将从无操作系统状态恢复到正常运行状态，并执行 <code>tick_nohz_idle_stop_tick</code> 函数来重新启用时钟事件处理器。</p><p><code>tick_nohz_stop_tick</code> 的作用类似。</p><div class="hint-container note"><p class="hint-container-title">tick</p><p>tick 是周期性产生的 timer 中断事件，在系统中断的时候，不想产生周期性的中断，提出了动态时钟的概念，在系统空闲的阶段停掉周期性的时钟达到节省功耗的目的。</p><p>内核可以通过配置项 CONFIG_NO_HZ 及 CONFIG_NO_HZ_IDLE 来打开该功能，这样在系统空闲的时候就可以停掉 tick 一段时间，但并不是完全没有 tick 了，当有除了 idle 进程之外的其它进程运行的时候会恢复 tick[^2] 。</p><p>tick_device_mode 有两种模式：TICKDEV_MODE_PERIODIC 和 TICKDEV_MODE_ONESHOT，即周期模式和单触发模式。</p></div><h2 id="tick-broadcast-oneshot-control" tabindex="-1"><a class="header-anchor" href="#tick-broadcast-oneshot-control"><span>tick_broadcast_oneshot_control()</span></a></h2><p>在研究之前，我们先给出调用关系图：</p>',9)),l(a,{id:"mermaid-35",code:"eJyNzDEPgjAQhuHdX9ERBxwYHUygZSAmmmAHE2OaWo7QSCgpJzr0x1upEybqTTc831u35q4aaZFwtiD+0pPqb7pqQUCHYMWAEuFM4nhDsgi1uoqLNbJScsAglmEWRPJBHhqDyCbhemnlmvCCbkVW7lNG0wMX+Y7npSN0vjYdDI1BoUyH1rTvUPKtdCy4D02QTo5FQvyTZS/tdE1muIJRK1jBiP5zJPe5n70n1K5w9w=="}),s[1]||(s[1]=i(`<p>该函数代码的作用是打开或者关闭本地定时器。当 CPU 要进入需要关闭 local timer 的 idle 状态的时候，会调用<code>tick_broadcast_enter()</code>函数，从而告诉 tick 广播层属于本 CPU 的本地定时事件设备就要停止掉了，需要广播层提供服务。相反的，如果要退出某种 idle 状态之后，会调用 <code>tick_broadcast_exit()</code> 函数，恢复本 CPU 的本地定时事件设备，停止针对本 CPU 的 tick 广播服务。</p><p>这两个函数的代码如下：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> inline</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> tick_broadcast_enter</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> tick_broadcast_oneshot_control</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">TICK_BROADCAST_ENTER</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> inline</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> tick_broadcast_exit</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">	tick_broadcast_oneshot_control</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">TICK_BROADCAST_EXIT</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从中我们可以看出，这两个函数都是调用了 <code>tick_broadcast_oneshot_control</code>(我们本小节的主角函数)，只不过是传入了不同的 state 参数，该函数的实现如下：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// in kernel/linux-5.10/kernel/time/tick-common.c</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> tick_broadcast_oneshot_control</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">enum</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> tick_broadcast_state </span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> tick_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">td </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> this_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tick_cpu_device</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">td</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">evtdev</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">features</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> CLOCK_EVT_FEAT_C3STOP</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		return</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> __tick_broadcast_oneshot_control</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">EXPORT_SYMBOL_GPL</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tick_broadcast_oneshot_control</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>函数首先那倒本地的 tick 设备，然后判断如果本 CPU 的 tick 设备不支持 <code>CLOCK_EVT_FEAT_C3STOP</code> 也就是 C3_STOP 状态的话直接退出。否则会调用 <code>__tick_broadcast_oneshot_control</code> 函数，我们继续看其实现：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">// kernel/linux-5.10/kernel/time/tick-broadcast.c</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> __tick_broadcast_oneshot_control</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">enum</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> tick_broadcast_state </span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> tick_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">td </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> this_cpu_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tick_cpu_device</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cpu </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> smp_processor_id</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">tick_oneshot_wakeup_control</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> td</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		return</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">tick_broadcast_device</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">evtdev</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> ___tick_broadcast_oneshot_control</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> td</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">	/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">	 * If there is no broadcast or wakeup device, tell the caller not</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">	 * to go into deep idle.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">	 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	return</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">EBUSY</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该函数分为两个大的部分:</p><ul><li><code>tick_oneshot_wakeup_control</code></li><li><code>___tick_broadcast_oneshot_control</code></li></ul><p>我们在后文进行分析。</p><h3 id="tick-oneshot-wakeup-control" tabindex="-1"><a class="header-anchor" href="#tick-oneshot-wakeup-control"><span>tick_oneshot_wakeup_control</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> tick_oneshot_wakeup_control</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">enum</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> tick_broadcast_state </span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">				       struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> tick_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">td</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">				       int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> clock_event_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">dev</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">wd</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	dev </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> td</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">evtdev</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">td</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">mode</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> !=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TICKDEV_MODE_ONESHOT</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		return</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">EINVAL</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">	wd </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> tick_get_oneshot_wakeup_device</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">wd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		return</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ENODEV</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	switch</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TICK_BROADCAST_ENTER</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">		clockevents_switch_state</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">dev</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> CLOCK_EVT_STATE_ONESHOT_STOPPED</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">		clockevents_switch_state</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">wd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> CLOCK_EVT_STATE_ONESHOT</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">		clockevents_program_event</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">wd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> dev</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">next_event</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		break</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	case</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TICK_BROADCAST_EXIT</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">		/* We may have transitioned to oneshot mode while idle */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">clockevent_get_state</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">wd</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> !=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> CLOCK_EVT_STATE_ONESHOT</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">			return</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ENODEV</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	return</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="tick-broadcast-oneshot-control-1" tabindex="-1"><a class="header-anchor" href="#tick-broadcast-oneshot-control-1"><span>___tick_broadcast_oneshot_control</span></a></h3><p>这段代码很长，不在此进行全部列举。</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> ___tick_broadcast_oneshot_control</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">enum</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> tick_broadcast_state </span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">					     struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> tick_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">td</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">					     int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">    raw_spin_lock</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tick_broadcast_lock</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">state </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TICK_BROADCAST_ENTER</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> else</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">out:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">	raw_spin_unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tick_broadcast_lock</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> ret</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>函数的整体框架如上所示，按照传入的 state 进行划分，我们在上文说过，state 可以分为 TICK_BROADCAST_ENTER 和 TICK_BROADCAST_EXIT。</p><p>后续会使用到的两个设备变量分别为：<code>struct clock_event_device *bc, *dev = td-&gt;evtdev;</code></p><ul><li>bc: <code>clock_event_device</code> 结构体，<code>bc = tick_broadcast_device.evtdev;</code> 表示 tick <em>广播</em> 设备；</li><li>dev: <code>clock_event_device</code> 结构体，<code>*dev = td-&gt;evtdev</code>, td 来自于函数传参，是一个 tick 设备，这里指代的是待休眠(本) CPU 上面的 tick 设备。</li></ul><p>下文我们先对传入的两个 state 进行研究。</p><h4 id="tick-broadcast-enter" tabindex="-1"><a class="header-anchor" href="#tick-broadcast-enter"><span>TICK_BROADCAST_ENTER</span></a></h4><p>该 state 表征的是当前 CPU 要进入 idle 状态。其步骤可以分解为以下的：</p><p>➡️➡️ 判断当前 CPU 能否进入（更深层次的）休眠状态。</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> broadcast_needs_cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">bc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ret</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    goto</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> out</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>If the current CPU owns the hrtimer broadcast mechanism, it cannot go deep idle and we do not add the CPU to the broadcast mask. We don&#39;t have to go through the EXIT path as the local timer is not shutdown.</p></blockquote><p>如果当前的 CPU 不支持广播模式的话，就不能使能更深层次的 idle 状态，故直接退出。判断是否可以支持 broadcast 使用下面的逻辑：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> broadcast_needs_cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> clock_event_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">bc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">bc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">features</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> CLOCK_EVT_FEAT_HRTIMER</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		return</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">bc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">next_event</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> KTIME_MAX</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">		return</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">	return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> bc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">bound_on</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cpu </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">?</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">EBUSY </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>➡️➡️ TICKDEV_MODE_PERIODIC, 如果 tick 广播设备还在周期触发模式（与之对立的就是 one shot 模式）的话，执行以下逻辑：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">tick_broadcast_device.mode </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> TICKDEV_MODE_PERIODIC</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    /* If it is a hrtimer based broadcast, return busy */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">bc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">features</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> CLOCK_EVT_FEAT_HRTIMER</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">        ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">EBUSY</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    goto</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> out</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当 tick 广播设备是由高分辨率定时器模拟的则返回 -EBUSY.</p><p>➡️➡️ one shot 模式 下面的处理逻辑，是设置 tick_broadcast_oneshot_mask 中当前 CPU 对应的位。</p><div class="hint-container warning"><p class="hint-container-title">tick_broadcast_oneshot_mask</p><p>需要留意到 tick_broadcast_oneshot_mask 这个变量能否使用 <code>__cpumask_var_read_mostly</code> 进行修饰！后续遇到的变量也应当注意。</p></div><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">cpumask_test_and_set_cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> tick_broadcast_oneshot_mask</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">			WARN_ON_ONCE</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">cpumask_test_cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> tick_broadcast_pending_mask</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">			/* Conditionally shut down the local timer. */</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    		// 尝试关闭本 CPU 上的定时事件设备</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">			broadcast_shutdown_local</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">bc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> dev</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">			/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">			 * We only reprogram the broadcast timer if we</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">			 * did not mark ourself in the force mask and</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">			 * if the cpu local event is earlier than the</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">			 * broadcast event. If the current CPU is in</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">			 * the force mask, then we are going to be</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">			 * woken by the IPI right away; we return</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">			 * busy, so the CPU does not try to go deep</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">			 * idle.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">			 */</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    		// 如果 tick_broadcast_force_mask 中对应当前 CPU 的位被设置了</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">cpumask_test_cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> tick_broadcast_force_mask</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">				ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">EBUSY</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"> // 在此返回 -EBUSY 说明其暂时不能进入 idle</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            /* 当前休眠 CPU 上的 tick 设备到期事件早于 tick 广播设备到期时间;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">             * 如果该条件发生的话，则需要用当前 CPU 上 tick 设备的到期时间</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">             * 去更新 tick 广播</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">            */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">			}</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> else</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">dev</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">next_event</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> bc</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">next_event</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">				tick_broadcast_set_event</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">bc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> dev</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">next_event</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">				/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">				 * In case of hrtimer broadcasts the</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">				 * programming might have moved the</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">				 * timer to this cpu. If yes, remove</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">				 * us from the broadcast mask and</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">				 * return busy.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">				 */</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">                // 这边有个二次判断，很难理解</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">				ret </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> broadcast_needs_cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">bc</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">ret</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">                    // 如果不支持广播模式的话，就清除掉当前 CPU 对应的那一位</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">					cpumask_clear_cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">						tick_broadcast_oneshot_mask</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">				}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面对每一行代码进行了解析，总结以下，总共做了以下的事情：</p><ol><li>关闭本地 CPU 的定时设备，主要的任务；</li><li>关闭后设置 tick_broadcast_force_mask 中本 CPU 对应的标志位；这边可能会存在一个竞态，所以会查询一次看是否设置成功；</li><li>在设置成功的前提下，调用 tick_broadcast_set_event, 设置 broadcast 事件；这个设置的前提是本 cpu 的 tick 事件早于广播的下一个事件（很好理解，否则我就用广播的事件时间就可以了）</li><li>在此判断是否支持 broadcase, 为何要再次判断呢？这就涉及到了 hrtimer broadcasts 机制的运行原理，需要进行更加详细的研究。</li></ol><h4 id="tick-broadcast-exit" tabindex="-1"><a class="header-anchor" href="#tick-broadcast-exit"><span>TICK_BROADCAST_EXIT</span></a></h4><p>@todo</p>`,36))])}const c=n(e,[["render",p]]),g=JSON.parse('{"path":"/linux/kernel/idle_tick.html","title":"Tick in Idle","lang":"zh-CN","frontmatter":{"title":"Tick in Idle","shortTitle":"Idle Tick","date":"2023-06-25T00:00:00.000Z","author":"weigao","category":["Kernel"],"description":"Abstract 本文研究 tick, 在 kernel 的 idle 流程中，会出现对 tick 的调用，用于进行 idle 状态时钟的控制等。由于其机制复杂，代码量大，故将其单独进行研究。 本文主要针对于 idle 流程中涉及到的 tick 进行简单研究。 tick_nohz_idle_stop_tick 当出现需要处理的中断时，CPU 将从无操作...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Tick in Idle\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2023-06-25T00:00:00.000Z\\",\\"dateModified\\":\\"2023-07-18T14:42:53.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"weigao\\"}]}"],["meta",{"property":"og:url","content":"https://vueblog.weigao.cc/linux/kernel/idle_tick.html"}],["meta",{"property":"og:site_name","content":"weigao"}],["meta",{"property":"og:title","content":"Tick in Idle"}],["meta",{"property":"og:description","content":"Abstract 本文研究 tick, 在 kernel 的 idle 流程中，会出现对 tick 的调用，用于进行 idle 状态时钟的控制等。由于其机制复杂，代码量大，故将其单独进行研究。 本文主要针对于 idle 流程中涉及到的 tick 进行简单研究。 tick_nohz_idle_stop_tick 当出现需要处理的中断时，CPU 将从无操作..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2023-07-18T14:42:53.000Z"}],["meta",{"property":"article:author","content":"weigao"}],["meta",{"property":"article:published_time","content":"2023-06-25T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2023-07-18T14:42:53.000Z"}]]},"git":{"createdTime":1687701088000,"updatedTime":1689691373000,"contributors":[{"name":"chenweigao","username":"chenweigao","email":"297859260@qq.com","commits":2,"url":"https://github.com/chenweigao"}]},"readingTime":{"minutes":5.76,"words":1728},"filePathRelative":"linux/kernel/idle_tick.md","excerpt":"<h2>Abstract</h2>\\n<p>本文研究 tick, 在 kernel 的 idle 流程中，会出现对 tick 的调用，用于进行 idle 状态时钟的控制等。由于其机制复杂，代码量大，故将其单独进行研究。</p>\\n<p>本文主要针对于 idle 流程中涉及到的 tick 进行简单研究。</p>\\n<h2>tick_nohz_idle_stop_tick</h2>\\n<p>当出现需要处理的中断时，CPU 将从无操作系统状态恢复到正常运行状态，并执行 <code>tick_nohz_idle_stop_tick</code> 函数来重新启用时钟事件处理器。</p>\\n<p><code>tick_nohz_stop_tick</code> 的作用类似。</p>","autoDesc":true}');export{c as comp,g as data};
