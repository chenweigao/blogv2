import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,d as n,o as e}from"./app-11Vuyqh7.js";const l={};function h(t,s){return e(),a("div",null,s[0]||(s[0]=[n(`<h2 id="abstract" tabindex="-1"><a class="header-anchor" href="#abstract"><span>Abstract</span></a></h2><p>Celery 是一个基于分布式消息传输的异步任务队列，它专注于实时处理，同时也支持任务调度。</p><p><a href="http://docs.celeryproject.org/en/latest/index.html" target="_blank" rel="noopener noreferrer">官方文档</a></p><p>安装 python 版本：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -U</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> Celery</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>或者可以安装 Celery 的一个或多个扩展：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> celery[librabbitmq,</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> redis,</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> auth,</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> msgpack]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="config" tabindex="-1"><a class="header-anchor" href="#config"><span>Config</span></a></h2><ul><li><p>使用 Redis 作为消息代理和后端存储，序列化和反序列化使用 msgpack, 也可以使用 json, msgpack 相比 json 是一个二进制的类 json 的序列化方式，比 json 的数据结构更小、更快</p></li><li><p>安装 Redis 可视化软件 RDM(redis desktop manager)</p></li></ul><h2 id="初始化" tabindex="-1"><a class="header-anchor" href="#初始化"><span>初始化</span></a></h2><p>初始化时指定消息代理和存储：</p><div class="language-py line-numbers-mode" data-highlighter="shiki" data-ext="py" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"># app.py</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">from</span><span style="--shiki-light:#005CC5;--shiki-dark:#D8DEE9FF;"> __future__</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> import</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> absolute_import</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> unicode_literals</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> celery </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> Celery</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">app </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#88C0D0;"> Celery</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">    &#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">myapp</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">    broker</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">redis://localhost:6379/0</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    # ## add result backend here if needed.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">    # backend=&#39;rpc&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ECEFF4;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D08770;">app</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#D08770;">task</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;">x</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9;"> y</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> y</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">if</span><span style="--shiki-light:#005CC5;--shiki-dark:#D8DEE9FF;"> __name__</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;"> ==</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;"> &#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">__main__</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#88C0D0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">()</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后再命令行中启动：</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">celery</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -A</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> app</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> worker</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -l</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> info</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="调用-task" tabindex="-1"><a class="header-anchor" href="#调用-task"><span>调用 Task</span></a></h2><p>参考这篇文章：<a href="https://mp.weixin.qq.com/s/kxwlLQ5H479PXCKuS4ZueA" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/kxwlLQ5H479PXCKuS4ZueA</a></p><p>celery 调用 task 有三种方式：</p><ol><li><p><code>apply_async(args[, kwargs[, …]])</code>, 这种方式会往消息队列发送消息, 并支持各种参数使用</p></li><li><p><code>delay(*args, **kwargs)</code>, 是apply_async 一种简明调用方式，但是不支持很多额外的参数</p></li><li><p><code>calling ( __call__)</code>, 应用支持调用API的对象，例如add(2,2), 意味着任务将在当前进程中执行，而不是由worker执行（不会发送消息）</p></li></ol><p>示例：</p><div class="language-py line-numbers-mode" data-highlighter="shiki" data-ext="py" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">说明：本例中的 T 即为 task 名称</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"># 相当于apply_async 的简单调用方式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#88C0D0;">delay</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">arg</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> kwarg</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#88C0D0;">apply_async</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">((</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">arg</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> ),</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">kwarg</span><span style="--shiki-light:#032F62;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"># 任务会在10s 后开始执行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#88C0D0;">apply_async</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">countdown</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"># 任务会在 now 之后的10秒开始执行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#88C0D0;">apply_async</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">eta</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">now </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#88C0D0;"> timedelta</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">seconds</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"># 任务会在一分钟之后执行，在两分钟后过期</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#88C0D0;">apply_async</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">countdown</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">60</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;"> expires</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">120</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"># 任务会在now之后的两天过期</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#88C0D0;">apply_async</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">expires</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">now </span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#88C0D0;"> timedelta</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#D8DEE9;">days</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">))</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,20)]))}const r=i(l,[["render",h]]),d=JSON.parse('{"path":"/blogs/Frameworks/celery.html","title":"Celery：分布式消息传输的异步任务队列","lang":"zh-CN","frontmatter":{"title":"Celery：分布式消息传输的异步任务队列","date":"2018-08-10T00:00:00.000Z","tag":["redis"],"category":["Frameworks"],"description":"Abstract Celery 是一个基于分布式消息传输的异步任务队列，它专注于实时处理，同时也支持任务调度。 官方文档 安装 python 版本： 或者可以安装 Celery 的一个或多个扩展： Config 使用 Redis 作为消息代理和后端存储，序列化和反序列化使用 msgpack, 也可以使用 json, msgpack 相比 json 是一...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Celery：分布式消息传输的异步任务队列\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2018-08-10T00:00:00.000Z\\",\\"dateModified\\":\\"2022-09-27T15:26:02.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Someone\\",\\"url\\":\\"https://www.weigao.cc\\"}]}"],["meta",{"property":"og:url","content":"https://vueblog.weigao.cc/blogs/Frameworks/celery.html"}],["meta",{"property":"og:site_name","content":"weigao"}],["meta",{"property":"og:title","content":"Celery：分布式消息传输的异步任务队列"}],["meta",{"property":"og:description","content":"Abstract Celery 是一个基于分布式消息传输的异步任务队列，它专注于实时处理，同时也支持任务调度。 官方文档 安装 python 版本： 或者可以安装 Celery 的一个或多个扩展： Config 使用 Redis 作为消息代理和后端存储，序列化和反序列化使用 msgpack, 也可以使用 json, msgpack 相比 json 是一..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2022-09-27T15:26:02.000Z"}],["meta",{"property":"article:tag","content":"redis"}],["meta",{"property":"article:published_time","content":"2018-08-10T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2022-09-27T15:26:02.000Z"}]]},"git":{"createdTime":1644237761000,"updatedTime":1664292362000,"contributors":[{"name":"chenweigao","username":"chenweigao","email":"297859260@qq.com","commits":5,"url":"https://github.com/chenweigao"}]},"readingTime":{"minutes":1.58,"words":473},"filePathRelative":"blogs/Frameworks/celery.md","excerpt":"<h2>Abstract</h2>\\n<p>Celery 是一个基于分布式消息传输的异步任务队列，它专注于实时处理，同时也支持任务调度。</p>\\n<p><a href=\\"http://docs.celeryproject.org/en/latest/index.html\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">官方文档</a></p>\\n<p>安装 python 版本：</p>\\n<div class=\\"language-bash line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"bash\\" style=\\"--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff\\"><pre class=\\"shiki shiki-themes github-light nord vp-code\\"><code><span class=\\"line\\"><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">pip</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\"> install</span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#A3BE8C\\"> -U</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\"> Celery</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{r as comp,d as data};
