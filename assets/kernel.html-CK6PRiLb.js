import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,d as e,o as n}from"./app-11Vuyqh7.js";const l={};function h(t,i){return n(),a("div",null,i[0]||(i[0]=[e(`<h2 id="_1-预备工作" tabindex="-1"><a class="header-anchor" href="#_1-预备工作"><span>1. 预备工作</span></a></h2><p>阿里云开源镜像站下载内核：<a href="http://mirrors.aliyun.com/" target="_blank" rel="noopener noreferrer">阿里云</a>。下载内核和patch包。</p><p>安装必要的软件</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">#安装必要的软件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> kernel-package</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> build-essential</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> libncurses5-dev</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> fakeroot</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">#解压缩内核</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">tar</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -xzf</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> linux-4.x.x.tar.gz</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>把内核目录linux-4.x.x和补丁patch都复制到/usr/src，然后进入/usr/src</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> linux-x.x</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> /usr/src</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -rf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> patch-x.x</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> /user/src</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#88C0D0;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> /usr/src</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-准备编译" tabindex="-1"><a class="header-anchor" href="#_2-准备编译"><span>2. 准备编译</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">#复制当前内核的config文件到linux-x.x/下</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> linux-headers-</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">uname</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -r</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">/.config</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> linux-x.x/</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#88C0D0;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> linux-x.x/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> menuconfig</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>选择load→OK→Save→OK→EXIT→EXIT的执行顺序。</p><h2 id="_3-开始编译" tabindex="-1"><a class="header-anchor" href="#_3-开始编译"><span>3. 开始编译</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"># 编译启动映像，N表示CPU核数，单核为2.双核为4，以此类推</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> bzImage</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -jN</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">#编译模块</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> modules</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -jN</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">#安装模块</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> modules-install</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;">#安装内核</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> install</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-更新grub" tabindex="-1"><a class="header-anchor" href="#_4-更新grub"><span>4. 更新grub</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#616E88;"># 4.5.0为版本号</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">mkinitramfs</span><span style="--shiki-light:#005CC5;--shiki-dark:#B48EAD;"> 4.5.0</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> /boot/initrd.img-4.5.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">update-grub2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="内核与内核模块" tabindex="-1"><a class="header-anchor" href="#内核与内核模块"><span>内核与内核模块</span></a></h2><h3 id="内核模块" tabindex="-1"><a class="header-anchor" href="#内核模块"><span>内核模块</span></a></h3><p>一般内核模块放置在<code>lib/modules/$(uname -r)/kernel</code>当中，包括arch, drivers和net等子文件。</p><p>在新建模块的时候，会遇到模块的依赖性问题，在 <code>lib/modules/$(uname -r/modules.dep)</code> 文件中存储，这个文件的创建使用 <code>depmod [-Ane]</code> 命令：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">depmod</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> [-Ane]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">-A:</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> 查找到新模块再更新该文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">-n:</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> 不写入modules,</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> 但在屏幕上输出</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">-e:</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> 显示出当前已加载但不可执行的模块名称</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>举例：如果我做好了一个网卡驱动程序，文件名为a.ko，则更新内核模块：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> a.ko</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> /lib/modules/</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">uname</span><span style="--shiki-light:#005CC5;--shiki-dark:#A3BE8C;"> -r</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;"> )</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;">/kernel/drivers/net</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">depmod</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="内核模块的查看" tabindex="-1"><a class="header-anchor" href="#内核模块的查看"><span>内核模块的查看</span></a></h3><p><code>lsmod</code>命令可查看已加载的模块，查看内核模块的信息，使用<code>modinfo</code></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">modinfo</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> [-adln] </span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">module_name</span><span style="--shiki-light:#D73A49;--shiki-dark:#81A1C1;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;">filename</span><span style="--shiki-light:#24292E;--shiki-dark:#ECEFF4;">]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">-a:</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> 仅列出作者名称</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">-d:</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> 仅description</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">-l:</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> 仅列出授权</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">-n:</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> 列出该模块的详细路径</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>e.g. 列出ath模块的路径：<code>modinfo -n ath</code></p><h3 id="内核模块的加载与删除" tabindex="-1"><a class="header-anchor" href="#内核模块的加载与删除"><span>内核模块的加载与删除</span></a></h3><p><code>modprobe</code>命令可解决依赖性并决定需要加载的模块，优于<code>insmod</code></p><p>对于删除模块：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">rmmmod</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> [-fw] module_name</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">-f:</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> 强势删除，无论是否被使用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">-w:</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> 若该模块在使用，则等待该模块使用完后再删除</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是通常情况下，不推荐使用<code>insmod</code>和<code>rmmod</code>命令，万一模块存在依赖属性的问题时，将无法直接加载或删除该模块，所以使用<code>modprobe</code>来处理加载模块的问题：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff;"><pre class="shiki shiki-themes github-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">modprobe</span><span style="--shiki-light:#24292E;--shiki-dark:#D8DEE9FF;"> [-lcfr] module_name</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">-r:</span><span style="--shiki-light:#032F62;--shiki-dark:#A3BE8C;"> 删除某个模块</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div>`,31)]))}const p=s(l,[["render",h]]),k=JSON.parse('{"path":"/blogs/Cloud_Server/kernel.html","title":"Linux Kernel Build：Linux 内核编译","lang":"zh-CN","frontmatter":{"title":"Linux Kernel Build：Linux 内核编译","date":"2018-06-08T00:00:00.000Z","tag":["Linux"],"category":["Server","Linux"],"description":"1. 预备工作 阿里云开源镜像站下载内核：阿里云。下载内核和patch包。 安装必要的软件 把内核目录linux-4.x.x和补丁patch都复制到/usr/src，然后进入/usr/src 2. 准备编译 选择load→OK→Save→OK→EXIT→EXIT的执行顺序。 3. 开始编译 4. 更新grub 内核与内核模块 内核模块 一般内核模块放置...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Linux Kernel Build：Linux 内核编译\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2018-06-08T00:00:00.000Z\\",\\"dateModified\\":\\"2022-09-27T15:26:02.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Someone\\",\\"url\\":\\"https://www.weigao.cc\\"}]}"],["meta",{"property":"og:url","content":"https://vueblog.weigao.cc/blogs/Cloud_Server/kernel.html"}],["meta",{"property":"og:site_name","content":"weigao"}],["meta",{"property":"og:title","content":"Linux Kernel Build：Linux 内核编译"}],["meta",{"property":"og:description","content":"1. 预备工作 阿里云开源镜像站下载内核：阿里云。下载内核和patch包。 安装必要的软件 把内核目录linux-4.x.x和补丁patch都复制到/usr/src，然后进入/usr/src 2. 准备编译 选择load→OK→Save→OK→EXIT→EXIT的执行顺序。 3. 开始编译 4. 更新grub 内核与内核模块 内核模块 一般内核模块放置..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2022-09-27T15:26:02.000Z"}],["meta",{"property":"article:tag","content":"Linux"}],["meta",{"property":"article:published_time","content":"2018-06-08T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2022-09-27T15:26:02.000Z"}]]},"git":{"createdTime":1644237761000,"updatedTime":1664292362000,"contributors":[{"name":"chenweigao","username":"chenweigao","email":"297859260@qq.com","commits":5,"url":"https://github.com/chenweigao"}]},"readingTime":{"minutes":2.04,"words":612},"filePathRelative":"blogs/Cloud&Server/kernel.md","excerpt":"<!--more-->\\n<h2>1. 预备工作</h2>\\n<p>阿里云开源镜像站下载内核：<a href=\\"http://mirrors.aliyun.com/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">阿里云</a>。下载内核和patch包。</p>\\n<p>安装必要的软件</p>\\n<div class=\\"language-shell line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"shell\\" style=\\"--shiki-light:#24292e;--shiki-dark:#d8dee9ff;--shiki-light-bg:#fff;--shiki-dark-bg:#2e3440ff\\"><pre class=\\"shiki shiki-themes github-light nord vp-code\\"><code><span class=\\"line\\"><span style=\\"--shiki-light:#6A737D;--shiki-dark:#616E88\\">#安装必要的软件</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">apt-get</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\"> install</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\"> kernel-package</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\"> build-essential</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\"> libncurses5-dev</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\"> fakeroot</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6A737D;--shiki-dark:#616E88\\">#解压缩内核</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#88C0D0\\">tar</span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#A3BE8C\\"> -xzf</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#A3BE8C\\"> linux-4.x.x.tar.gz</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{p as comp,k as data};
