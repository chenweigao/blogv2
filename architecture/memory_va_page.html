<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.22" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.85" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Virtual Memory and Page","image":["https://github.com/user-attachments/assets/4b755807-4f0e-4372-89ca-539a484d77fe \"1\"","https://github.com/user-attachments/assets/9afb65e2-758a-4c23-8ab8-db04bbba5f8d"],"datePublished":"2022-08-25T00:00:00.000Z","dateModified":"2025-05-12T08:59:22.000Z","author":[{"@type":"Person","name":"Someone","url":"https://www.weigao.cc"}]}</script><meta property="og:url" content="https://vueblog.weigao.cc/architecture/memory_va_page.html"><meta property="og:site_name" content="weigao"><meta property="og:title" content="Virtual Memory and Page"><meta property="og:description" content="1. Abstract 本文主要讲述和理解虚拟内存（后文简称 VM， VA 等）、Page、TLB 的概念，行文可能较为跳跃，需要特别注意。 2. Virtual Memory 什么是虚拟内存？ Virtual memory is a technique used by operating systems to enable programs to u..."><meta property="og:type" content="article"><meta property="og:image" content="https://github.com/user-attachments/assets/4b755807-4f0e-4372-89ca-539a484d77fe "1""><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-05-12T08:59:22.000Z"><meta property="article:tag" content="Page"><meta property="article:tag" content="TLB"><meta property="article:published_time" content="2022-08-25T00:00:00.000Z"><meta property="article:modified_time" content="2025-05-12T08:59:22.000Z"><link rel="stylesheet" href="//at.alicdn.com/t/font_2410206_mfj6e1vbwo.css"><link rel="icon" href="modx-icon.svg"><title>Virtual Memory and Page | weigao</title><meta name="description" content="1. Abstract 本文主要讲述和理解虚拟内存（后文简称 VM， VA 等）、Page、TLB 的概念，行文可能较为跳跃，需要特别注意。 2. Virtual Memory 什么是虚拟内存？ Virtual memory is a technique used by operating systems to enable programs to u...">
    <link rel="preload" href="/assets/style-DTwT6W5F.css" as="style"><link rel="stylesheet" href="/assets/style-DTwT6W5F.css">
    <link rel="modulepreload" href="/assets/app-11Vuyqh7.js"><link rel="modulepreload" href="/assets/memory_va_page.html-5P5LJy5i.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-zxK26moD.js" as="script"><link rel="prefetch" href="/assets/home.html-BOnf4GSZ.js" as="script"><link rel="prefetch" href="/assets/intro.html-KS-cxLYt.js" as="script"><link rel="prefetch" href="/assets/Drawing 2025-05-11 16.01.37 - GPU Arch.excalidraw.html-D86SW3G_.js" as="script"><link rel="prefetch" href="/assets/index.html-9EJ8q5CX.js" as="script"><link rel="prefetch" href="/assets/backtrack.html-83ZdyZ5D.js" as="script"><link rel="prefetch" href="/assets/binary_search.html-DpY6Hoxi.js" as="script"><link rel="prefetch" href="/assets/binary_tree.html-D67RRWdZ.js" as="script"><link rel="prefetch" href="/assets/dfs_bfs.html-BsfdmS2n.js" as="script"><link rel="prefetch" href="/assets/dp.html-oH8dA_N7.js" as="script"><link rel="prefetch" href="/assets/lcs.html-BjogI-T-.js" as="script"><link rel="prefetch" href="/assets/package.html-DFFA-SQW.js" as="script"><link rel="prefetch" href="/assets/presum.html-CuPnfyr6.js" as="script"><link rel="prefetch" href="/assets/slide_window.html-D2_tiEom.js" as="script"><link rel="prefetch" href="/assets/snappet.html-yBWaHH5N.js" as="script"><link rel="prefetch" href="/assets/sort.html-C_BgcWBM.js" as="script"><link rel="prefetch" href="/assets/MMU.html-CWbjpvX2.js" as="script"><link rel="prefetch" href="/assets/index.html-CVlNLbCw.js" as="script"><link rel="prefetch" href="/assets/cache.html-CqGv_8n7.js" as="script"><link rel="prefetch" href="/assets/ibs.html-DTyyhLLw.js" as="script"><link rel="prefetch" href="/assets/numa_socket.html-CYJ0cZIb.js" as="script"><link rel="prefetch" href="/assets/pipline.html-DCmp_e2x.js" as="script"><link rel="prefetch" href="/assets/x86_inst.html-D6ZWLxHA.js" as="script"><link rel="prefetch" href="/assets/index.html-BX-AnLMZ.js" as="script"><link rel="prefetch" href="/assets/index.html-CVbDMppB.js" as="script"><link rel="prefetch" href="/assets/apt.html-qA4mcNMO.js" as="script"><link rel="prefetch" href="/assets/index.html-CDUQEHd-.js" as="script"><link rel="prefetch" href="/assets/coroutines.html-CrGtibvH.js" as="script"><link rel="prefetch" href="/assets/crontab.html-Cd60F1z2.js" as="script"><link rel="prefetch" href="/assets/effective-python.html-BtB3Tmhk.js" as="script"><link rel="prefetch" href="/assets/hash.html-BoUIu4An.js" as="script"><link rel="prefetch" href="/assets/io.html-6jQ1WNw8.js" as="script"><link rel="prefetch" href="/assets/itertools.html-BMJNoro8.js" as="script"><link rel="prefetch" href="/assets/log.html-xUzl6582.js" as="script"><link rel="prefetch" href="/assets/pandas.html-C1dM82Yf.js" as="script"><link rel="prefetch" href="/assets/pip.html-Dypw9pNA.js" as="script"><link rel="prefetch" href="/assets/py-data-struct.html-kooI_52N.js" as="script"><link rel="prefetch" href="/assets/py-file.html-FIIZ-YbS.js" as="script"><link rel="prefetch" href="/assets/py-tools.html-D5bcsaO-.js" as="script"><link rel="prefetch" href="/assets/pytest.html-OgGE0eTo.js" as="script"><link rel="prefetch" href="/assets/python-function.html-CYOGmL4g.js" as="script"><link rel="prefetch" href="/assets/python-oo.html-CmZSSSvl.js" as="script"><link rel="prefetch" href="/assets/python_c.html-BvFWfxpn.js" as="script"><link rel="prefetch" href="/assets/virtualenv.html-DiNpud0U.js" as="script"><link rel="prefetch" href="/assets/hashmap.html-Dz2CKlaD.js" as="script"><link rel="prefetch" href="/assets/linkedlist.html-C7OAeKS9.js" as="script"><link rel="prefetch" href="/assets/index.html-BOnZ5GuX.js" as="script"><link rel="prefetch" href="/assets/stack.html-DjhAUPSF.js" as="script"><link rel="prefetch" href="/assets/string.html-Bz3FwYEy.js" as="script"><link rel="prefetch" href="/assets/tree.html-Br-a9aoF.js" as="script"><link rel="prefetch" href="/assets/index.html-Ba4rXWD0.js" as="script"><link rel="prefetch" href="/assets/arm_inline_assembly.html-B0KAke9u.js" as="script"><link rel="prefetch" href="/assets/arm_ins.html-D9h5RQ0O.js" as="script"><link rel="prefetch" href="/assets/index.html-BFYYmxE-.js" as="script"><link rel="prefetch" href="/assets/SAC - ISCA 23.html-09AA0ObK.js" as="script"><link rel="prefetch" href="/assets/gpu_arch.html-WvJWZ39h.js" as="script"><link rel="prefetch" href="/assets/gpu_communication.html-DXzHPo0o.js" as="script"><link rel="prefetch" href="/assets/index.html-C1Zp2-vr.js" as="script"><link rel="prefetch" href="/assets/vp_hpca14.html-CJYCI2Qm.js" as="script"><link rel="prefetch" href="/assets/vp_value_prediction.html-rqjKqjzS.js" as="script"><link rel="prefetch" href="/assets/Docker.html-MudQ_TKE.js" as="script"><link rel="prefetch" href="/assets/design-pattern.html-CiYAVGBb.js" as="script"><link rel="prefetch" href="/assets/gc.html-DwDdbuPt.js" as="script"><link rel="prefetch" href="/assets/huawei_cloud.html-CCZ0gW2z.js" as="script"><link rel="prefetch" href="/assets/jvm.html-Uyi34U3e.js" as="script"><link rel="prefetch" href="/assets/jvm_art.html-ITo72_c2.js" as="script"><link rel="prefetch" href="/assets/kernel.html-CK6PRiLb.js" as="script"><link rel="prefetch" href="/assets/kvm.html-CBLf4nNV.js" as="script"><link rel="prefetch" href="/assets/linux_os.html-CnVgO5VK.js" as="script"><link rel="prefetch" href="/assets/nginx.html-Cq_uSALv.js" as="script"><link rel="prefetch" href="/assets/openresty.html-BVsqn9s8.js" as="script"><link rel="prefetch" href="/assets/snap.html-CnWdZnr8.js" as="script"><link rel="prefetch" href="/assets/mongodb.html-DJN7sRQP.js" as="script"><link rel="prefetch" href="/assets/mysql.html-B3bc5n7F.js" as="script"><link rel="prefetch" href="/assets/peewee.html-p9gb8JFw.js" as="script"><link rel="prefetch" href="/assets/redis.html-ACAEk0k1.js" as="script"><link rel="prefetch" href="/assets/celery.html-cDD9IPkc.js" as="script"><link rel="prefetch" href="/assets/flask.html-BVjFlLLQ.js" as="script"><link rel="prefetch" href="/assets/spring.html-D5s6F21i.js" as="script"><link rel="prefetch" href="/assets/chartsjs.html-_Hi8cUhq.js" as="script"><link rel="prefetch" href="/assets/css.html-DOgGeuCI.js" as="script"><link rel="prefetch" href="/assets/jsnote.html-D_jaGu96.js" as="script"><link rel="prefetch" href="/assets/node_install.html-CmtBQ1rX.js" as="script"><link rel="prefetch" href="/assets/vue.html-Dqt1Gblp.js" as="script"><link rel="prefetch" href="/assets/epoll.html-Bcw8HLHg.js" as="script"><link rel="prefetch" href="/assets/http.html-hQEs5kwH.js" as="script"><link rel="prefetch" href="/assets/networks.html-CN9xVKX7.js" as="script"><link rel="prefetch" href="/assets/code_life.html-CDQGU-NF.js" as="script"><link rel="prefetch" href="/assets/new.html-D7TkZNlV.js" as="script"><link rel="prefetch" href="/assets/paper_report.html-BWxBZGu5.js" as="script"><link rel="prefetch" href="/assets/soft_skills.html-CoR5flex.js" as="script"><link rel="prefetch" href="/assets/thoughts-2018.html-Cl_wNRe8.js" as="script"><link rel="prefetch" href="/assets/worklog.html-CbEAWpO4.js" as="script"><link rel="prefetch" href="/assets/zen_of_python.html-DjjNB24O.js" as="script"><link rel="prefetch" href="/assets/blog_plan.html-BUH5W6bZ.js" as="script"><link rel="prefetch" href="/assets/jekyll.html-Dl6vWkhw.js" as="script"><link rel="prefetch" href="/assets/kilo.html-DRtf-EN5.js" as="script"><link rel="prefetch" href="/assets/qqbot.html-CHBL4Maf.js" as="script"><link rel="prefetch" href="/assets/vueblog.html-BO53P7n5.js" as="script"><link rel="prefetch" href="/assets/ArrayTrack.html-yho5LwA0.js" as="script"><link rel="prefetch" href="/assets/RF-Pose.html-D6K6uIBj.js" as="script"><link rel="prefetch" href="/assets/cnn.html-BIebAlXT.js" as="script"><link rel="prefetch" href="/assets/csitool.html-E-MBdb_8.js" as="script"><link rel="prefetch" href="/assets/cvpr.html-BJfAtlTw.js" as="script"><link rel="prefetch" href="/assets/face_recognition.html-DoB8VJ3H.js" as="script"><link rel="prefetch" href="/assets/information_theory.html-DtmkkHAs.js" as="script"><link rel="prefetch" href="/assets/latex.html-BQsiUShC.js" as="script"><link rel="prefetch" href="/assets/mnist.html-COmKsga0.js" as="script"><link rel="prefetch" href="/assets/opencv.html-CEtNG21b.js" as="script"><link rel="prefetch" href="/assets/splicer.html-lIbOq7tr.js" as="script"><link rel="prefetch" href="/assets/tensorflow.html-CyTbLA2F.js" as="script"><link rel="prefetch" href="/assets/tensorflowio.html-BGFIhNlc.js" as="script"><link rel="prefetch" href="/assets/bat_win.html-Bk9ILE1R.js" as="script"><link rel="prefetch" href="/assets/git.html-k3Fl1prN.js" as="script"><link rel="prefetch" href="/assets/vim.html-CXoTbNJo.js" as="script"><link rel="prefetch" href="/assets/vps.html-BrH7irnU.js" as="script"><link rel="prefetch" href="/assets/adb.html-Dmc5qPtT.js" as="script"><link rel="prefetch" href="/assets/binder.html-C-Y6MnwP.js" as="script"><link rel="prefetch" href="/assets/binder_01.html-CLjTtG51.js" as="script"><link rel="prefetch" href="/assets/binder_02.html-CM-GPvY7.js" as="script"><link rel="prefetch" href="/assets/ipc.html-DefEdPpM.js" as="script"><link rel="prefetch" href="/assets/parcel.html-DpaAgCw2.js" as="script"><link rel="prefetch" href="/assets/art_create.html-D9EGoxVV.js" as="script"><link rel="prefetch" href="/assets/art_dex2oat.html-DYkXljq2.js" as="script"><link rel="prefetch" href="/assets/art_jni.html-C12CGD_h.js" as="script"><link rel="prefetch" href="/assets/gc_art_01.html-DZc-fvJ4.js" as="script"><link rel="prefetch" href="/assets/01_jvm_memory.html-DfNV7Kn7.js" as="script"><link rel="prefetch" href="/assets/gc_g1.html-DKO2CbK6.js" as="script"><link rel="prefetch" href="/assets/jvm_inst.html-rS5qNZ14.js" as="script"><link rel="prefetch" href="/assets/reflection.html-DcakEpls.js" as="script"><link rel="prefetch" href="/assets/index.html-CgR7FO1Z.js" as="script"><link rel="prefetch" href="/assets/c-pointer.html-DfESFfVY.js" as="script"><link rel="prefetch" href="/assets/cmake.html-CoiUro2O.js" as="script"><link rel="prefetch" href="/assets/cmake_makefile.html-B7fwZ60E.js" as="script"><link rel="prefetch" href="/assets/command.html-CxyvSJNj.js" as="script"><link rel="prefetch" href="/assets/linkers_loaders.html-BYhVf0Nx.js" as="script"><link rel="prefetch" href="/assets/size_t.html-P_VhBC4I.js" as="script"><link rel="prefetch" href="/assets/BL31.html-BVGIdJE1.js" as="script"><link rel="prefetch" href="/assets/index.html-Cw7hBeaV.js" as="script"><link rel="prefetch" href="/assets/THP.html-BgszrdN2.js" as="script"><link rel="prefetch" href="/assets/i2c.html-Cdv6sklB.js" as="script"><link rel="prefetch" href="/assets/idle.html-ChJzhS5K.js" as="script"><link rel="prefetch" href="/assets/idle_tick.html-B2YB7IRM.js" as="script"><link rel="prefetch" href="/assets/notifier.html-amrxXrsW.js" as="script"><link rel="prefetch" href="/assets/pthread.html-BT7_v0kx.js" as="script"><link rel="prefetch" href="/assets/rcu.html-FfJx3phg.js" as="script"><link rel="prefetch" href="/assets/thermal.html-VVfuHC0a.js" as="script"><link rel="prefetch" href="/assets/thermal_init.html-BRrhQCR8.js" as="script"><link rel="prefetch" href="/assets/thermal_init_h.html-BlLhRbva.js" as="script"><link rel="prefetch" href="/assets/xv6.html-C2L34VUt.js" as="script"><link rel="prefetch" href="/assets/Marketing.html-uf-E19-U.js" as="script"><link rel="prefetch" href="/assets/code_simple.html-BShYgCfA.js" as="script"><link rel="prefetch" href="/assets/index.html-Puvv2PvI.js" as="script"><link rel="prefetch" href="/assets/review.html-C5fwjz46.js" as="script"><link rel="prefetch" href="/assets/bpytop.html-Co8G0OAa.js" as="script"><link rel="prefetch" href="/assets/gem.html-Du88YrMP.js" as="script"><link rel="prefetch" href="/assets/on-my-zsh.html-Dak2rqxa.js" as="script"><link rel="prefetch" href="/assets/others.html-BrVHU_kI.js" as="script"><link rel="prefetch" href="/assets/index.html-CFa_f4_8.js" as="script"><link rel="prefetch" href="/assets/tools.html-JgwufGBY.js" as="script"><link rel="prefetch" href="/assets/vps.html-VWZX_1v1.js" as="script"><link rel="prefetch" href="/assets/yarn.html-Dpf1xqOG.js" as="script"><link rel="prefetch" href="/assets/404.html-DGwkcVIS.js" as="script"><link rel="prefetch" href="/assets/index.html-L-6zRB91.js" as="script"><link rel="prefetch" href="/assets/index.html-CYNsqs1h.js" as="script"><link rel="prefetch" href="/assets/index.html-DYe54yC2.js" as="script"><link rel="prefetch" href="/assets/index.html-BhUeJixe.js" as="script"><link rel="prefetch" href="/assets/index.html-lnwOVy3X.js" as="script"><link rel="prefetch" href="/assets/index.html-0Kzu24fa.js" as="script"><link rel="prefetch" href="/assets/index.html-DIEXX-3a.js" as="script"><link rel="prefetch" href="/assets/index.html-Bwb7X5To.js" as="script"><link rel="prefetch" href="/assets/index.html-Bpy2tFs7.js" as="script"><link rel="prefetch" href="/assets/index.html-A9YGej71.js" as="script"><link rel="prefetch" href="/assets/index.html-DpQxhiFJ.js" as="script"><link rel="prefetch" href="/assets/index.html-CMelKNBC.js" as="script"><link rel="prefetch" href="/assets/index.html-CQzOsDLT.js" as="script"><link rel="prefetch" href="/assets/index.html-a_I1I-PL.js" as="script"><link rel="prefetch" href="/assets/index.html-JwjjRDi4.js" as="script"><link rel="prefetch" href="/assets/index.html-C-bqHIny.js" as="script"><link rel="prefetch" href="/assets/index.html-trE1Ziu_.js" as="script"><link rel="prefetch" href="/assets/index.html-C05kIRim.js" as="script"><link rel="prefetch" href="/assets/index.html-hdvtbUSo.js" as="script"><link rel="prefetch" href="/assets/index.html-C8cWcl0p.js" as="script"><link rel="prefetch" href="/assets/index.html-u3pkU2-U.js" as="script"><link rel="prefetch" href="/assets/index.html-Dp_ja6pe.js" as="script"><link rel="prefetch" href="/assets/index.html-DL7RerrT.js" as="script"><link rel="prefetch" href="/assets/index.html-nZWaW2sa.js" as="script"><link rel="prefetch" href="/assets/index.html-BLueIjZK.js" as="script"><link rel="prefetch" href="/assets/index.html-QbIv_0P9.js" as="script"><link rel="prefetch" href="/assets/index.html-khWvmriZ.js" as="script"><link rel="prefetch" href="/assets/index.html-DTTh2g2g.js" as="script"><link rel="prefetch" href="/assets/index.html-B7I8Ik06.js" as="script"><link rel="prefetch" href="/assets/index.html-DFhkPmmQ.js" as="script"><link rel="prefetch" href="/assets/index.html-BNsBrDLd.js" as="script"><link rel="prefetch" href="/assets/index.html-DG40OQm-.js" as="script"><link rel="prefetch" href="/assets/index.html-DG1wzJml.js" as="script"><link rel="prefetch" href="/assets/index.html-BGcwbbEd.js" as="script"><link rel="prefetch" href="/assets/index.html-D_9h0pHQ.js" as="script"><link rel="prefetch" href="/assets/index.html-DL7RerrT.js" as="script"><link rel="prefetch" href="/assets/index.html-DfysevBq.js" as="script"><link rel="prefetch" href="/assets/index.html-DBzZyRhs.js" as="script"><link rel="prefetch" href="/assets/index.html-N-vwOs3N.js" as="script"><link rel="prefetch" href="/assets/index.html-D2SnN9re.js" as="script"><link rel="prefetch" href="/assets/index.html-CP-oJQZk.js" as="script"><link rel="prefetch" href="/assets/index.html-DmkT3Q_4.js" as="script"><link rel="prefetch" href="/assets/index.html-oSxiMd2n.js" as="script"><link rel="prefetch" href="/assets/index.html-BO--K8hH.js" as="script"><link rel="prefetch" href="/assets/index.html-DRlow2_v.js" as="script"><link rel="prefetch" href="/assets/index.html-CIvTE1R-.js" as="script"><link rel="prefetch" href="/assets/index.html-ECAz77Os.js" as="script"><link rel="prefetch" href="/assets/index.html-BKpHmwGa.js" as="script"><link rel="prefetch" href="/assets/index.html-Kz4F9_sJ.js" as="script"><link rel="prefetch" href="/assets/index.html-BCgGyJ6n.js" as="script"><link rel="prefetch" href="/assets/index.html-DdcPewlV.js" as="script"><link rel="prefetch" href="/assets/index.html-B67UQrwL.js" as="script"><link rel="prefetch" href="/assets/index.html-B7xCWEXZ.js" as="script"><link rel="prefetch" href="/assets/index.html-DOEYPJMu.js" as="script"><link rel="prefetch" href="/assets/index.html-WNAVKcvg.js" as="script"><link rel="prefetch" href="/assets/index.html-DOEYPJMu.js" as="script"><link rel="prefetch" href="/assets/index.html-Be-5T_XY.js" as="script"><link rel="prefetch" href="/assets/index.html-BrB2oU8y.js" as="script"><link rel="prefetch" href="/assets/index.html-CTGzFNDH.js" as="script"><link rel="prefetch" href="/assets/index.html-PnmPKqdn.js" as="script"><link rel="prefetch" href="/assets/index.html-Z0Dd8uwb.js" as="script"><link rel="prefetch" href="/assets/index.html-W4MI9YUO.js" as="script"><link rel="prefetch" href="/assets/index.html-BrB2oU8y.js" as="script"><link rel="prefetch" href="/assets/index.html-aKzoM5Np.js" as="script"><link rel="prefetch" href="/assets/index.html-DuoWM8kk.js" as="script"><link rel="prefetch" href="/assets/index.html-C5tYZ9WE.js" as="script"><link rel="prefetch" href="/assets/index.html-1A31cbow.js" as="script"><link rel="prefetch" href="/assets/index.html-SI3Co-Gr.js" as="script"><link rel="prefetch" href="/assets/index.html-Uy5m97KV.js" as="script"><link rel="prefetch" href="/assets/index.html--r4aQEjh.js" as="script"><link rel="prefetch" href="/assets/index.html-Clsdwxzd.js" as="script"><link rel="prefetch" href="/assets/index.html-D-UwJTvB.js" as="script"><link rel="prefetch" href="/assets/index.html-8zTIKicp.js" as="script"><link rel="prefetch" href="/assets/index.html-8eqwGHJO.js" as="script"><link rel="prefetch" href="/assets/index.html-DrRuMq6U.js" as="script"><link rel="prefetch" href="/assets/index.html-BrXWuUm5.js" as="script"><link rel="prefetch" href="/assets/index.html-zSZk-Y8F.js" as="script"><link rel="prefetch" href="/assets/index.html-BPzdk3Uv.js" as="script"><link rel="prefetch" href="/assets/index.html-Bs5eld_8.js" as="script"><link rel="prefetch" href="/assets/index.html-CBPpfPLC.js" as="script"><link rel="prefetch" href="/assets/index.html-DtD-VJQg.js" as="script"><link rel="prefetch" href="/assets/index.html-B3-AZZLB.js" as="script"><link rel="prefetch" href="/assets/index.html-BUvx7RyV.js" as="script"><link rel="prefetch" href="/assets/index.html-DeCPz8wv.js" as="script"><link rel="prefetch" href="/assets/index.html-BoF-ao4T.js" as="script"><link rel="prefetch" href="/assets/index.html-BrIT_EuW.js" as="script"><link rel="prefetch" href="/assets/index.html-oGmch48D.js" as="script"><link rel="prefetch" href="/assets/index.html-CSlK9Gdr.js" as="script"><link rel="prefetch" href="/assets/index.html-OXZaufv4.js" as="script"><link rel="prefetch" href="/assets/index.html-BYvVkuV1.js" as="script"><link rel="prefetch" href="/assets/index.html-ClJfYtOd.js" as="script"><link rel="prefetch" href="/assets/index.html-CFFrJF7J.js" as="script"><link rel="prefetch" href="/assets/index.html-LX6b_Ctd.js" as="script"><link rel="prefetch" href="/assets/index.html-Dy7gLI01.js" as="script"><link rel="prefetch" href="/assets/index.html-BVmOSuLb.js" as="script"><link rel="prefetch" href="/assets/index.html-Do59p0gD.js" as="script"><link rel="prefetch" href="/assets/index.html-XfcX9Qfg.js" as="script"><link rel="prefetch" href="/assets/index.html-CzCxSuG7.js" as="script"><link rel="prefetch" href="/assets/index.html-CyL6-bq0.js" as="script"><link rel="prefetch" href="/assets/index.html-PnmPKqdn.js" as="script"><link rel="prefetch" href="/assets/index.html-DkS71JnZ.js" as="script"><link rel="prefetch" href="/assets/index.html-M_VMkmfA.js" as="script"><link rel="prefetch" href="/assets/index.html-Cn2hMPQ7.js" as="script"><link rel="prefetch" href="/assets/auto-C3mEb9gQ.js" as="script"><link rel="prefetch" href="/assets/mermaid.esm.min-BeePAOX2.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-DXWKOczD.js" as="script"><link rel="prefetch" href="/assets/giscus-1zs_z9NH.js" as="script"><link rel="prefetch" href="/assets/SearchResult-CuoDb2Js.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container external-link-icon pure has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/" aria-label="带我回家"><img class="vp-nav-logo" src="/excellence.png" alt><!----><span class="vp-site-name hide-in-pad">weigao</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="博客主页"><!--[--><iconify-icon class="vp-icon" icon="material-symbols:book-2" height="1em" sizing="height"></iconify-icon><!--]-->博客主页<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/home.html" aria-label="项目主页"><!--[--><iconify-icon class="vp-icon" icon="material-symbols:home-and-garden" height="1em" sizing="height"></iconify-icon><!--]-->项目主页<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/category/" aria-label="Blog"><!--[--><iconify-icon class="vp-icon" icon="material-symbols:book-ribbon" height="1em" sizing="height"></iconify-icon><!--]-->Blog<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/algorithm/" aria-label="Algorithm"><!--[--><iconify-icon class="vp-icon" icon="fluent-emoji-high-contrast:thinking-face" height="1em" sizing="height"></iconify-icon><!--]-->Algorithm<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/python/" aria-label="Python"><!--[--><iconify-icon class="vp-icon" icon="akar-icons:python-fill" height="1em" sizing="height"></iconify-icon><!--]-->Python<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/linux/" aria-label="Linux"><!--[--><iconify-icon class="vp-icon" icon="fluent-mdl2:linux-logo-32" height="1em" sizing="height"></iconify-icon><!--]-->Linux<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/architecture/" aria-label="Arch"><!--[--><iconify-icon class="vp-icon" icon="oui:compute" height="1em" sizing="height"></iconify-icon><!--]-->Arch<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/java/" aria-label="Java"><!--[--><iconify-icon class="vp-icon" icon="ri:java-line" height="1em" sizing="height"></iconify-icon><!--]-->Java<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/timeline/" aria-label="TimeLine"><!--[--><iconify-icon class="vp-icon" icon="icon-park-outline:timeline" height="1em" sizing="height"></iconify-icon><!--]-->TimeLine<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Others"><!--[--><iconify-icon class="vp-icon" icon="basil:other-1-outline" height="1em" sizing="height"></iconify-icon>Others<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/others/tools/" aria-label="Tools"><!--[--><iconify-icon class="vp-icon" icon="mdi:tools" width="1em" height="1em" sizing="both"></iconify-icon><!--]-->Tools<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/others/tmp/" aria-label="Temp"><!--[--><iconify-icon class="vp-icon" icon="carbon:prompt-template" width="1em" height="1em" sizing="both"></iconify-icon><!--]-->Temp<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="auto-link external-link" href="https://theme-hope.vuejs.press/zh/" aria-label="主题文档" rel="noopener noreferrer" target="_blank"><!--[--><iconify-icon class="vp-icon" icon="material-symbols:zoom-out-map" height="1em" sizing="height"></iconify-icon><!--]-->主题文档<!----></a></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/chenweigao" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="slimsearch-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="slimsearch-placeholder">搜索</div><div class="slimsearch-key-hints"><kbd class="slimsearch-key">Ctrl</kbd><kbd class="slimsearch-key">K</kbd></div></button><!--]--><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/architecture/" aria-label="Architecture"><!---->Architecture<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Arm</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Papers</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">GPU &amp; AI</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/architecture/pipline.html" aria-label="Pipeline"><!---->Pipeline<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/architecture/memory_va_page.html" aria-label="Virtual Memory and Page"><!---->Virtual Memory and Page<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/architecture/numa_socket.html" aria-label="Numa and Socket"><!---->Numa and Socket<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/architecture/cache.html" aria-label="Cache"><!---->Cache<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/architecture/x86_inst.html" aria-label="Instructions of x86"><!---->Instructions of x86<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/architecture/MMU.html" aria-label="MMU"><!---->MMU<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/architecture/ibs.html" aria-label="AMD IBS"><!---->AMD IBS<!----></a></li></ul><!----></aside><!--[--><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Virtual Memory and Page</h1><div class="page-info"><span class="page-author-info" aria-label="作者"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://www.weigao.cc" target="_blank" rel="noopener noreferrer">Someone</a></span><span property="author" content="Someone"></span></span><!----><span class="page-date-info" aria-label="写作日期"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2022/8/25</span><meta property="datePublished" content="2022-08-25T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 24 分钟</span><meta property="timeRequired" content="PT24M"></span><span class="page-category-info" aria-label="分类"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item clickable" role="navigation">Arm</span><span class="page-category-item clickable" role="navigation">Computer Architecture</span><!--]--><meta property="articleSection" content="Arm,Computer Architecture"></span><span class="page-tag-info" aria-label="标签"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item clickable" role="navigation">TLB</span><span class="page-tag-item clickable" role="navigation">Page</span><!--]--><meta property="keywords" content="TLB,Page"></span></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><h2 id="_1-abstract" tabindex="-1"><a class="header-anchor" href="#_1-abstract"><span>1. Abstract</span></a></h2><p>本文主要讲述和理解虚拟内存（后文简称 VM， VA 等）、Page、TLB 的概念，行文可能较为跳跃，需要特别注意。</p><h2 id="_2-virtual-memory" tabindex="-1"><a class="header-anchor" href="#_2-virtual-memory"><span>2. Virtual Memory</span></a></h2><p>什么是虚拟内存？</p><blockquote><p>Virtual memory is a technique used by operating systems to enable programs to <strong>use more memory than is physically available</strong> in the system. When a program accesses memory, the address it uses is a virtual address, which is <strong>translated by the hardware into a physical address</strong> that corresponds to a location in physical memory. This <strong>translation process can be slow</strong>, especially if it has to be performed every time the program accesses memory.</p></blockquote><ol><li>虚拟内存的存在使得程序可以使用比可用物理内存更多的存储空间（程序员想要无限多的存储空间）<em>-- use more memory than is physically available</em></li><li>虚拟地址是由物理地址转化而来的 <em>-- translated by the hardware into a physical address</em></li><li>这种转换过程一般会比较缓慢（引出后续 TLB）<em>-- translation process can be slow</em></li></ol><h3 id="_2-1-虚拟内存与进程-进程隔离" tabindex="-1"><a class="header-anchor" href="#_2-1-虚拟内存与进程-进程隔离"><span>2.1. 虚拟内存与进程（进程隔离）</span></a></h3><div class="hint-container important"><p class="hint-container-title">重要</p><p>虚拟内存是保证进程之间隔离的重要机制之一。</p></div><p>内核使用<strong>虚拟内存和进程控制块</strong>来保证进程之间的隔离。</p><p>对于虚拟内存而言，每个进程都有自己的地址空间，其中包含代码、数据和栈。这样，每个进程之间的内存空间都是相互隔离的，一个进程无法访问另一个进程的内存。</p><p>虚拟内存具体是如何实现进程之间的隔离的？虚拟内存为每个进程提供了<strong>单独的地址空间</strong>，以实现进程之间的隔离。这种隔离是把物理内存分成大小相等的<strong>页</strong>来实现的（从虚拟内存的角度看，页就是内存的最小单位）；当进程访问其虚拟地址空间中的某个页时，操作系统会加载虚拟页对应的物理页（MMU: 将虚拟地址转化为物理地址），在这个过程中，操作系统会检查当前进程是否有权限访问该页面。也就是说：一个进程无法访问其他进程的地址空间。</p><div class="hint-container note"><p class="hint-container-title">注</p><p><strong>问题：两个进程的虚拟地址空间可能会是什么样子的？</strong></p><p>进程 A 的虚拟地址空间：</p><ul><li>0x00000000 ~ 0x7fffffff 用户空间</li><li>0x80000000 ~ 0xffffffff 内核空间</li></ul><p>进程 B 的虚拟地址空间：</p><ul><li>0x00000000 ~ 0x7fffffff 用户空间</li><li>0x80000000 ~ 0xffffffff 内核空间</li></ul><p>A, B 是两个独立的进程，所以虽然用户空间的地址范围相同，但是使用的虚拟地址是不同的；哪怕虚拟地址相同，也会对应不同的物理地址。</p></div><h3 id="_2-2-页表" tabindex="-1"><a class="header-anchor" href="#_2-2-页表"><span>2.2. 页表</span></a></h3><p>我们上面说，进程隔离的一个很重要的机制保证就是虚拟内存，那么从底层来看，是怎么实现的呢？答案是<strong>页表</strong>。</p><p>每个进程都拥有自己的页表；具体而言，Linux 为每个进程都维护一个 <code>task_struct</code> 结构体（进程描述符 PCB, 无论怎么称呼），<code>task_struct -&gt; mm_struct</code> 结构体成员用来保存该进程的页表。</p><blockquote><p>在进程切换的过程中，内核把新的页表的地址写入 <mark>CR3 控制寄存器</mark>。CR3 中含有页目录表的<mark>物理内存基地址</mark>，因此该寄存器也被称为页目录基地址寄存器 PDBR(Page-Directory Base address Register)<sup class="footnote-ref"><a href="#footnote1">[1]</a><a class="footnote-anchor" id="footnote-ref1"></a></sup></p></blockquote><p>每个进程（线程）绑定到自己的页表，页表不同意味着物理页不同（MMU 负责地址转换，不同的页表无法对应到一个物理页）</p><p>对于一个进程而言，操作系统如何保证其访问权限？检查当前操作系统进程是否可以访问目标内存地址，具体到指令级别：<strong>验证当前指令是否允许访问特定内存地址；这个过程的实现是通过 MMU 来做的</strong>：CPU 生成一个虚拟地址，虚拟地址经过 MMU 进行转换，将虚拟地址分解为<strong>页号和页内偏移</strong>，然后 MMU 查找页表，计算出最终的物理地址，查找时会检测非法或者权限。</p><p>对于 4K 页表，网络上有一个非常好的解释如下<sup class="footnote-ref"><a href="#footnote2">[2]</a><a class="footnote-anchor" id="footnote-ref2"></a></sup>:</p><figure><img src="https://github.com/user-attachments/assets/4b755807-4f0e-4372-89ca-539a484d77fe" alt="image" tabindex="0" loading="lazy"><figcaption>1</figcaption></figure><blockquote><p>页表的本质其实就是一个物理内存页，一张页表 4K 大小；也就是说，这 4K == 图中 1024 个 entry * 每个 entry 4B 大小。</p></blockquote><p>更进一步，64 位系统使用 4 级页表的结构如下<sup class="footnote-ref"><a href="#footnote3">[3]</a><a class="footnote-anchor" id="footnote-ref3"></a></sup>：</p><figure><img src="/assets/pages_kernel-QgcYrE-D.png" alt="pages kernel" tabindex="0" loading="lazy"><figcaption>pages kernel</figcaption></figure><p>Linux 内存提供的<strong>大页机制</strong>，上图的 4 级页表中，每个 PTE entry 映射的物理页就是 4K，如果采用 PMD entry 直接映射物理页，则一次 Page Fault 可以直接分配并映射 2M 的大页，并且只需要一个 TLB entry 即可存储这 2M 内存的映射关系，<strong>这样可以大幅提升内存分配与地址翻译的速度</strong>。</p><div class="hint-container note"><p class="hint-container-title">注</p><p>可以使用 perf 工具对比进程使用大页前后的 PageFault 次数的变化：</p><p><code>perf stat -e page-faults -p &lt;pid&gt; --sleep 5</code></p></div><h3 id="_2-3-summary" tabindex="-1"><a class="header-anchor" href="#_2-3-summary"><span>2.3. Summary</span></a></h3><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div style="display:flex;align-items:center;justify-content:center;height:96px;" class="mermaid-loading"><span style="--loading-icon: url(&quot;data:image/svg+xml;utf8,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39; viewBox=&#39;25 25 50 50&#39;%3E%3CanimateTransform attributeName=&#39;transform&#39; type=&#39;rotate&#39; dur=&#39;2s&#39; keyTimes=&#39;0;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;360&#39;%3E%3C/animateTransform%3E%3Ccircle cx=&#39;50&#39; cy=&#39;50&#39; r=&#39;20&#39; fill=&#39;none&#39; stroke=&#39;currentColor&#39; stroke-width=&#39;4&#39; stroke-linecap=&#39;round&#39;%3E%3Canimate attributeName=&#39;stroke-dasharray&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;1,200;90,200;1,200&#39;%3E%3C/animate%3E%3Canimate attributeName=&#39;stroke-dashoffset&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;-35px;-125px&#39;%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E&quot;);--icon-size: 48px;display: inline-block;width: var(--icon-size);height: var(--icon-size);background-color: currentcolor;-webkit-mask-image: var(--loading-icon);mask-image: var(--loading-icon)"></span></div></div><!--]--><ul><li><p>虚拟内存可以理解成在主存和辅存（磁盘、硬盘）之间进行数据缓存管理的一级存储层次。</p><blockquote><p>Virtual memory is the name for the level of memory hierarchy that manages <strong>caching</strong> between the <strong>main memory</strong> and <strong>secondary memory</strong>.</p></blockquote><p>从这个原文中我们理解，其本质还是可以理解为一个 cache.</p></li><li><p>虚拟内存允许单个程序将其地址空间扩展到超出主存的限制。</p><p>这句话我是这么理解的：虚拟内存一般可以设置为主存的 1.5 倍大小（建议值），主存也可以理解为辅存的 cache, 所以说虚拟内存在主存和辅存之间，其最大的大小限制应该是辅存的大小。</p><p>虽然虚拟存储是为了小容量的存储看起来像大容量的存储，但是主存和辅存之间的性能差异意味着，如果程序经常访问比它拥有的物理存储更多的虚拟存储，程序运行会非常慢。这样的程序会不停的在主存和辅存之间交换页面，这种情况称作：<strong>thrashing</strong></p></li><li><p>虚拟内存支持以<strong>受保护的方式</strong>在多个同时活跃的进程之间共享主存。</p><p>为什么要用受保护的方式，其原因有 2 点：</p><ol><li>保护多个应用程序不会同时访问到同一块物理地址。（官方行文：允许多个进程共享一个主存；保护机制确保：一个恶意进程不能写另一个用户进程或者操作系统的地址空间）</li><li>防止一个进程读另一个进程的数据</li></ol></li></ul><h2 id="_3-context-switch" tabindex="-1"><a class="header-anchor" href="#_3-context-switch"><span>3. Context Switch</span></a></h2><p>在进程切换时，页表的处理是操作系统内存管理的重要部分。不同的进程拥有不同的虚拟地址空间，而页表用于将虚拟地址转换为物理地址，因此在进程切换时需要进行页表切换。具体的处理过程如下：</p><ol><li><p><strong>保存当前进程的上下文</strong>：当操作系统决定从当前进程 P1 切换到另一个进程 P2 时，需要保存当前进程 P1 的硬件上下文，包括：CPU 寄存器、程序计数器（PC）、页表基地址寄存器（Page Table Base Register，PTBR）或相关控制寄存器；这些信息被保存在 P1 的进程控制块（PCB）中。</p></li><li><p><strong>加载新进程的页表</strong>：当操作系统切换到进程 P2 时，需要恢复 P2 的上下文信息：</p><ul><li>从 P2 的 PCB 中加载页表基地址到页表基地址寄存器（PTBR）</li><li>如果系统支持多级页表或页表缓存在硬件中（例如 TLB 缓存），操作系统还需要清空或重新配置这些缓存。</li></ul></li><li><p><strong>刷新 TLB</strong>：TLB 用于缓存最近访问的页表项，加速地址转换。在进程切换时，由于不同的进程页表不同，TLB 中的条目通常会失效（因为它们对应的是旧进程的虚拟地址空间），操作系统通常通过 <u>TLB 刷新或上下文标识符（ASID）</u> 机制来确保页表转换正确。</p></li><li><p><strong>更新 MMU</strong>：现代 CPU 使用内存管理单元（MMU） 完成地址转换，操作系统在进程切换时将新页表基地址通知 MMU，MMU 会自动根据新的页表基地址完成虚拟地址到物理地址的转换。</p></li><li><p><strong>地址空间的保护</strong>：由于不同的进程使用各自的页表，每个进程的虚拟地址空间是相互隔离的。页表的切换确保了进程只能访问属于自己的地址空间，以及防止跨进程的内存访问，从而提供内存保护。</p></li></ol><p>不同的体系结构和操作系统对页表的处理可能有细微差别：</p><ol><li>X86 架构：页表基地址通过 CR3 寄存器加载，切换进程时修改 CR3，并触发 TLB 刷新。</li><li>ARM 架构：类似地，使用页表基地址寄存器（例如 TTBR0/TTBR1）切换页表。</li><li>上下文标识符（ASID）：一些硬件支持 ASID，可以减少 TLB 刷新的开销。</li></ol><p>总结来说，进程切换时页表的处理步骤主要包括：</p><ol><li>保存旧进程的页表基地址（PTBR）和上下文。</li><li>加载新进程的页表基地址到 PTBR。</li><li>刷新 TLB 或使用 ASID 机制区分页表。</li><li>通知 MMU 使用新的页表进行地址转换。</li></ol><p>页表的切换是确保各进程虚拟地址空间隔离和正确运行的核心机制。</p><h2 id="_4-mmu" tabindex="-1"><a class="header-anchor" href="#_4-mmu"><span>4. MMU</span></a></h2><p>具体的专题分析见文章： <a class="route-link" href="/architecture/MMU.html">MMU</a>。</p><h2 id="_5-tlb" tabindex="-1"><a class="header-anchor" href="#_5-tlb"><span>5. TLB</span></a></h2><h3 id="_5-1-what-is-tlb" tabindex="-1"><a class="header-anchor" href="#_5-1-what-is-tlb"><span>5.1. What is TLB?</span></a></h3><blockquote><p>TLB stands for <strong>Translation Lookaside Buffer</strong>, and it is a <strong>hardware cache</strong> that is used in computer architecture to <strong>speed up virtual memory access.</strong></p><p>The TLB is a cache that stores recently used virtual-to-physical address translations, making it possible to <strong>quickly retrieve the physical address</strong> for a given virtual address. When a program requests a memory access, the hardware first checks the TLB to see if it contains the translation for the virtual address. If the translation is in the TLB, the hardware can use it to quickly access the corresponding physical address. If the translation is not in the TLB, the hardware has to perform the translation, which takes more time.</p></blockquote><p>对上述描述的简单理解：</p><ol><li>TLB 存储了最近使用过的 <em>virtual-to-physical</em> 地址转换；这也印证了为什么有些说法称 TLB 就像缓存中的一个条目，TLB 就是缓存了这一转换信息</li><li>程序访存请求过来以后，硬件会首先检查 TLB, 命中的话，很快返回虚拟地址对应的物理地址；如果缺失的话，就需要花费较多的时间进行地址转换</li></ol><p>也可以这么称呼：<strong>加快地址转化：TLB</strong>。TLB 的一些描述可以参考如下：</p><ul><li><p>页表存储在主存中，所以程序的每次访存请求至少需要两次访问：查页表获得物理地址、获得物理地址中的数据。</p></li><li><p>现代处理器设计了一个特殊的 cache 用于追踪最近使用过的地址转化（应用局部性原理），这个 cache 结构称为快表（TLB）</p><p>简而言之：TLB 作为页表的 cache 而存在（注意页表是在主存中，方便理解 ）</p></li></ul><h3 id="_5-2-tlb-miss" tabindex="-1"><a class="header-anchor" href="#_5-2-tlb-miss"><span>5.2. TLB Miss</span></a></h3><blockquote><p>A TLB miss occurs when the hardware attempts to translate a virtual memory address into a physical memory address and <strong>cannot find the translation in the Translation Lookaside Buffer (TLB)</strong>. When this happens, the hardware has to <strong>perform a full page table walk</strong> to find the translation, which is a more time-consuming process than using the TLB.</p></blockquote><p>TLB 失效，顾名思义就是 TLB 中没有表项能与虚拟地址匹配。按照上面的说法就是，TLB 失效是在 TLB 中没有找到地址转换。</p><p>TLB 失效表明两种可能性之一：</p><ol><li>页在内存中，但是 TLB 中没有创建</li><li>页不在内存中，需要把控制权转接给操作系统处理缺页失效</li></ol><blockquote><p>TLB misses can happen for several reasons. For example, if a <strong>program accesses memory that has not been recently accessed</strong>, the corresponding translation may have been evicted from the TLB due to space constraints. Similarly, TLB misses can occur when the <strong>operating system swaps pages</strong> in and out of physical memory, or when a program executes a system call that causes a context switch.</p></blockquote><p>TLB 失效的原因可能是：</p><ol><li><p>程序访问的地址近期没有被访问过，由于 TLB 空间的限制，这个 translation 可能就没有被存储在 TLB 中（page 在内存中）</p></li><li><p>操作系统 swap pages (page 没在内存中)</p><p>这两者就可以对应上述两点 TLB 失效的两种可能。</p></li></ol><div class="hint-container note"><p class="hint-container-title">注</p><p><strong>如何处理缺页失效或者 TLB 失效？</strong></p><ul><li>核心：通过<strong>例外机制</strong>来中断活跃进程，将控制转移到操作系统，然后再恢复执行被中断的进程。</li><li>两个特殊的控制寄存器：SEPC 和 SCAUSE.</li></ul></div><p>除此之外，如果我们检测到某个系统的 TLB Miss 比较高的话，可以使用如下的措施：</p><blockquote><p>To mitigate the impact of TLB misses, modern processors often employ techniques such as <strong>multi-level TLBs</strong>, <strong>TLB prefetching</strong>, and <strong>hardware page table walkers</strong>, which can reduce the likelihood and latency of TLB misses. Additionally, operating systems can optimize memory management strategies to minimize the number of TLB misses, such as using <strong>huge pages</strong> or transparent huge pages to reduce the size of page tables and increase TLB hit rates.</p></blockquote><ol><li>Multi-level TLBs (two-level page table structure in arm)</li><li>TLB prefetching</li><li>Hardware page table walkers</li><li>Huge pages, THP, hugetext.. (reduce page table size, increase TLB hit)</li></ol><h3 id="_5-3-tlb-and-l1-icache-vipt" tabindex="-1"><a class="header-anchor" href="#_5-3-tlb-and-l1-icache-vipt"><span>5.3. TLB and L1 ICache (VIPT)</span></a></h3><figure><img src="/assets/20241213105941-BElnN5Tr.jpg" alt="alt text" tabindex="0" loading="lazy"><figcaption>alt text</figcaption></figure><p>如图所示，解释一下 L1 ICache VIPT：</p><ol><li>64 位虚拟地址在逻辑上被分为虚拟页号与页内偏移：virtual pagenumber &amp; page offset</li><li>页内偏移的高位被发送到 L1 ICache 用作索引</li><li>如果 TLB 匹配命中，则将物理页号发送到 L1 缓存标记 (L1 cache tag), 检查是否匹配</li><li>如果匹配，则是 L1 缓存命中</li><li>L1 Miss 的话则使用物理地址尝试 L2 缓存</li></ol><h3 id="_5-4-tlb-walk-vs-tlb-miss" tabindex="-1"><a class="header-anchor" href="#_5-4-tlb-walk-vs-tlb-miss"><span>5.4. TLB Walk vs. TLB Miss</span></a></h3><p><strong>ITLB Miss</strong>：ITLB 中没有找到所需的地址映射；</p><p><strong>ITLB Walk</strong>：为解决 ITLB Miss 而触发的页表遍历过程；ITLB Walk 的触发必须是建立在 L1/L2... TLB Miss 的前提下，在 Intel 平台（8 代）由于是 L1 ITLB -&gt; STLB 的架构，故发生 ITLB Walk 意味着在 STLB 也 Miss 然后触发了 Page Table Walk. 此时代价较大，需要多次内存访问页表，影响性能。</p><blockquote><p>(Intel) An instruction TLB miss first goes to the L2 TLB, which contains 1536 PTEs of 4 KiB page sizes and is 12-way set associative. It takes 8 clock cycles to load the L1 TLB from the L2 TLB, which leads to the 9-cycle miss penalty including the initial clock cycle to access the L1 TLB. <strong>If the L2 TLB misses</strong>, a hardware algorithm is used to <strong>walk the page table</strong> and update the TLB entry.<mark><strong>L2 TLB Miss 导致 page table walk</strong></mark></p><p>Sections L.5 and L.6 of online Appendix L describe page table walkers and page structure caches. In the worst case, the page is not in memory, and the operating system gets the page from secondary storage. Because millions of instructions could execute during a <strong>page fault</strong>, the operating system will swap in another process if one is waiting to run. Otherwise, if there is no TLB exception, the instruction cache access continues.</p></blockquote><h2 id="_6-page-进阶" tabindex="-1"><a class="header-anchor" href="#_6-page-进阶"><span>6. Page 进阶</span></a></h2><h3 id="_6-1-页面大小的权衡" tabindex="-1"><a class="header-anchor" href="#_6-1-页面大小的权衡"><span>6.1. 页面大小的权衡</span></a></h3><p>页面大小是比较常见的体系结构参数。如果选择一个偏大的页面的话，其优点可以如下所示：</p><ol><li>页表的大小与页面的大小成反比；增大页面的大小可以节省存储器；</li><li>较大页面可使得缓存更大；</li><li>传递较大页面效率更高；</li><li>TLB 的条目数量有限，较大页面意味着可以高效地映射更多存储器，最终可以减少 TLB 缺失</li></ol><p>较小页面则可以节省内存，防止内部碎片化；还有一个问题就是较大的页面可能会延长调用一个进程的时间，因为进程启动的时候，很多进程很小。</p><p><strong>页表和 TLB 的关系</strong>：TLB 用于加速虚拟地址到物理地址的映射过程，而页表是实现虚拟内存管理的核心数据结构之一。如果 TLB 中没有缓存映射关系的话，CPU 就需要对页表进行查找，并将这个映射关系添加到 TLB 中以供下次使用。</p><h3 id="_6-2-thp" tabindex="-1"><a class="header-anchor" href="#_6-2-thp"><span>6.2. THP</span></a></h3><p>详细的 THP 软件分析参见 <a class="route-link" href="/linux/kernel/THP.html">THP Software Analysis</a></p><p>目前内核提供了两种大页机制：<strong>静态大页和透明大页</strong>。</p><p>静态大页通常需要应用程序显式指定预留的大小和数量，而透明大页 (THP, Transparent Huge Page) 的分配过程用户不感知，所以对用户透明，其过程如下： 在 THP <strong>always 模式</strong>下，会在 Page Fault 过程中，为符合要求的 vma 尽量分配大页进行映射；如果此时分配大页失败，比如整机物理内存碎片化严重，无法分配出连续的大页内存，那么就会 fallback 到普通的 4K 进行映射，但会记录下该进程的地址空间 mm_struct；然后 THP 会在后台启动 khugepaged 线程，定期扫描这些记录的 mm_struct，并进行合页操作。因为此时可能已经能分配出大页内存了，那么就可以将此前 fallback 的 4K 小页映射转换为大页映射，以提高程序性能。整个过程完全不需要用户进程参与，对用户进程是透明的，因此称为透明大页。</p><p>THP 还支持 <strong>madvise 模式</strong>，该模式需要应用程序指定使用大页的地址范围，内核只对指定的地址范围做 THP 相关的操作。这样可以更加针对性、更加细致地优化特定应用程序的性能，又不至于造成反向的负面影响。</p><h3 id="_6-3-ipc-与页表" tabindex="-1"><a class="header-anchor" href="#_6-3-ipc-与页表"><span>6.3. IPC 与页表</span></a></h3><p>OK，现在有一个很重要的问题：进程间通信的时候，我们都需要把数据 copy 到 kernel space, 因为进程的地址空间是隔离的，而 kernel space 是进程共享的；如果说，我们要绕过 kernel 直接进行进程间通信，需要解决以下问题：</p><ol><li>如何在用户态能看到其他进程的页表？（假设现在我们不用 Linux, 我们自己是可以实现这样的机制的）</li><li>如果说直接访问其他进程的页表有安全隐患，那么我们是否可以在用户态创建一个共享的页表？</li></ol><p>在用户态访问其他进程的页表，或者创建共享的页表，需要考虑操作系统的内存管理机制、进程隔离、安全性以及硬件支持。以下是一些可能的实现思路：</p><ol><li><p><strong>访问其他进程的页表</strong></p><p>在 Linux 中，用户态进程无法直接访问其他进程的页表，因为 MMU（内存管理单元）和内核都严格控制进程间的地址空间隔离。然而，在一个自定义操作系统中，如果我们希望允许这种访问，需要解决以下几个问题：</p><p><strong>页表的地址暴露</strong>：传统的 CR3 寄存器（在 x86 架构上）指向当前进程的页表基地址，其他进程的页表基地址通常无法直接访问。我们可以提供一个特权接口，让某个进程能够查询其他进程的页表地址。</p><p><strong>权限管理</strong>：如果允许进程访问其他进程的页表，必须建立访问控制机制，比如定义一个权限列表，只有特定进程可以共享页表信息，否则会导致进程间的任意访问，造成安全漏洞。</p><p><strong>页表格式</strong>：需要提供一个机制让用户态能解析内核管理的页表，比如暴露一个 syscall，将目标进程的页表映射到调用进程的用户态地址空间。</p></li><li><p><strong>在用户态创建共享的页表</strong></p><p>如果直接访问其他进程的页表有安全隐患，我们可以考虑在用户态创建一个共享的页表，实现类似 Linux 共享内存 (shm) 的机制：</p><p><strong>共享页表入口</strong>：允许多个进程映射相同的物理页，并且使用相同的页表项，使得不同进程的虚拟地址空间可以共享部分内存。例如，某个用户态进程可以创建一个“全局页表”结构，允许多个进程在相同的虚拟地址范围内共享相同的物理内存。</p><p><strong>用户态管理 TLB（Translation Lookaside Buffer）刷新</strong>：一般情况下，页表的修改需要通过内核来刷新 TLB，但如果用户态管理自己的共享页表，可能需要提供类似 TLB shootdown 机制，以确保所有 CPU 核心都能感知到页表变化。</p><p><strong>硬件支持</strong>：某些 CPU（比如 RISC-V、x86 EPT、ARM SMMU）提供了用户态管理的地址转换机制（如 x86 上的 User-mode paging 或 MPK 机制），可以用来加速进程间的地址空间共享，而不需要频繁切换到内核模式。</p></li><li><p><strong>可能的优化方式</strong></p><p>如果想要避免传统进程间通信的 copy to kernel space，可以考虑：</p><p><strong>使用 mmap + MAP_SHARED</strong>：多个进程共享同一块物理内存，通过 mmap 进行映射。</p><p><strong>用户态 RDMA（Remote Direct Memory Access）</strong>：绕过 CPU 和内核，直接让设备（如网卡、PCIe 设备）访问物理内存，实现高效的进程间通信。</p><p><strong>用户态 memfd_create</strong>：创建匿名共享内存，并通过 sendmsg 传递文件描述符给其他进程，从而实现零拷贝通信。</p></li></ol><p>如果你想自己实现一个支持用户态共享页表的机制，关键点在于如何在用户态安全地管理页表，同时确保不同进程的权限控制。如果你打算构建一个高性能的进程间通信机制，可以结合 RDMA、共享内存以及 TLB 优化来减少 syscall 和数据拷贝的开销。</p><h3 id="_6-4-page-fault" tabindex="-1"><a class="header-anchor" href="#_6-4-page-fault"><span>6.4. Page Fault</span></a></h3><ul><li><p>如果 virtual page 的有效位无效，那么就发生缺页失效。其本质是程序在执行过程中中需要访问的某一页数据或者代码不在内存中。</p></li><li><p>缺页失效发生的时候，如果内存中的所有页表都在使用的话，需要选择一页进行替换。</p></li><li><p>替换的时候使用近似 LRU 算法，因为实现完整的 LRU 算法代价太高。ARM V8 使用了一个 access bit 来实现这个。</p></li></ul><h3 id="_6-5-virtual-page-number-and-page-offset" tabindex="-1"><a class="header-anchor" href="#_6-5-virtual-page-number-and-page-offset"><span>6.5. Virtual page number and Page offset</span></a></h3><p>Virtual Address 可以分为两个部分：Virtual page number 和 Page offset, 可以翻译为虚拟页号和页内偏移量。</p><h4 id="_6-5-1-virtual-page-number" tabindex="-1"><a class="header-anchor" href="#_6-5-1-virtual-page-number"><span>6.5.1. Virtual Page Number</span></a></h4><p>Virtual Page Number (VPN) 是用于标识要访问的 page, 这个字段会用于虚拟地址到物理地址的转换。</p><p>VPN 的大小取决于虚拟地址空间的和虚拟存储系统使用的 page 大小；举例而言，一个系统有 32-bit 虚拟地址，4KB page, 则 VPN 的大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>20</mn></msup></mrow><annotation encoding="application/x-tex">2^{20}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">20</span></span></span></span></span></span></span></span></span></span></span></span> bit, 其需要在地址空间中表示 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>20</mn></msup></mrow><annotation encoding="application/x-tex">2^{20}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">20</span></span></span></span></span></span></span></span></span></span></span></span> 个 page. 对于为什么需要 20 bit, 其计算方法就是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>32</mn><mo>−</mo><mn>12</mn><mo>=</mo><mn>20</mn></mrow><annotation encoding="application/x-tex">32 - 12 = 20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">32</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">12</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">20</span></span></span></span>, 其中 4KB 的 page 占用了 12 bit 的标识，剩下的 20 位就留给了 VPN.</p><p>VPN 和 TLB 之间的关系需要加以理解：</p><blockquote><p>When a program accesses a virtual memory address, the processor extracts the virtual page number from the address and uses it as the index into the TLB cache.</p></blockquote><p>从上面可知：VPN 用于索引 TLB, 即 VPN -&gt; PPN (Physical Page Number).</p><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>对于上面的解释，如果我们假定有 20 bit 用于 VPN, 那么 TLB 的 tag compare address + TLB index (这两个合起来就是 TLB entry) 的大小就为 20 bit.</p><p>(not sure) TLB index 的大小取决于 TLB 的映射方式，或者说，取决于 TLB entires 的数量 (<em>The TLB contains <strong>entries</strong> that map virtual page numbers to physical page numbers, along with other metadata such as access permissions and cache coherency information.</em>)。</p><p>当 TLB index 确定的时候，TLB tag compare address 的位数也就确定了。</p></div><h4 id="_6-5-2-page-offset" tabindex="-1"><a class="header-anchor" href="#_6-5-2-page-offset"><span>6.5.2. Page Offset</span></a></h4><p>Page Offset 用于确定页表中数据的具体位置，通常而言，其比 Virtual page number 要小。以一个 4KB 的 page 而言，其需要 12 bit 来标识在这个 4KB page 中的 byte offset.</p><h3 id="_6-6-页表的映射方式" tabindex="-1"><a class="header-anchor" href="#_6-6-页表的映射方式"><span>6.6. 页表的映射方式？</span></a></h3><p>页表通常选择使用全相联的方式，出于以下几个原因（页表使用全相联 + 额外的页表）：</p><ol><li>全相联具有优越性，因为失效代价比较高</li><li>全相联允许软件使用负责的替换策略以降低失效率</li><li>全相联很容易索引，并且不需要额外的硬件，也不需要进行查找</li></ol><h3 id="_6-7-tlb-和-cache-的映射方式" tabindex="-1"><a class="header-anchor" href="#_6-7-tlb-和-cache-的映射方式"><span>6.7. TLB 和 cache 的映射方式？</span></a></h3><p>通常选用组相连，一些系统使用直接映射，看中其访问时间短并且实现简单。</p><h2 id="_7-kernel-pages-kidled" tabindex="-1"><a class="header-anchor" href="#_7-kernel-pages-kidled"><span>7. Kernel Pages: kidled</span></a></h2><p>Kidled 是 Linux 内核中的一个后台线程，它的主要作用是扫描并标记长时间未使用的内存页（冷页），为内存回收提供更智能的策略。相比于传统的 LRU 回收方式，kidled 可以主动识别冷页，减少误删活跃页的可能性，从而降低 page fault（缺页中断）和 swap-in 开销，提高系统性能。</p><h3 id="_7-1-kidled-的核心机制" tabindex="-1"><a class="header-anchor" href="#_7-1-kidled-的核心机制"><span>7.1. Kidled 的核心机制</span></a></h3><p>Kidled 主要通过以下几个步骤来工作：</p><p><strong>1️⃣ 通过访问位（Access Bit）检测页面活跃度</strong></p><ul><li><p>Linux 内核中的页表（Page Table） 记录了每个内存页的访问状态</p></li><li><p>现代 CPU 维护 Access Bit（访问位），每当 CPU 访问某个内存页时，这个位会被自动设置为 1</p></li><li><p>Kidled 定期扫描内存页的 Access Bit，判断它是否在一段时间内未被访问：</p><ul><li><p>如果 Access Bit 为 1：说明这个页最近被访问过，是“热”页，不进行回收。</p></li><li><p>如果 Access Bit 为 0：说明这个页在扫描周期内未被访问，可能是“冷”页，标记为可回收。</p></li></ul></li></ul><p>📌 <strong>总结</strong>：</p><p>Kidled <strong>不会立即回收页，而是先进行标记，等到真正需要回收时，优先清理冷页</strong>，这样可以<strong>避免 LRU 直接误删“热”页</strong>。</p><p><strong>2️⃣ 标记冷页，并分层管理</strong></p><ul><li><p>Kidled 发现访问位为 0 的页后，不会立刻释放，而是进一步观察。</p></li><li><p>它会多次扫描这些页：</p><ul><li><p>如果连续 N 次扫描都没有被访问，则认为它是真正的冷页，可以安全回收。</p></li><li><p>如果在下一次扫描中发现它被访问了（Access Bit 变为 1），则取消回收。</p></li></ul></li></ul><p>📌 <strong>这样可以确保真正回收的都是“冷”页，而不会误删“热”页</strong>。</p><p><strong>3️⃣ 触发回收（Eviction）</strong></p><p>当系统出现内存压力时：</p><ul><li><p>Kidled 会优先回收已经标记为“冷”的页，避免影响活跃进程。</p></li><li><p>避免直接从 LRU 里回收，这样可以减少 page fault 和 swap-in。</p></li><li><p>这种方式可以提高 swap 机制的效率，让被回收的页尽可能是长期未使用的“冷”数据。</p></li></ul><p><strong>4️⃣ 交互式调优</strong></p><ul><li><p>Kidled 可以通过 sysfs 接口进行调优，例如：</p><ul><li><p>调整扫描间隔：可以设定多长时间扫描一次。</p></li><li><p>调整回收门槛：可以设定多少次未访问才标记为冷页。</p></li></ul></li></ul><p>这样，系统管理员可以根据实际业务场景进行优化，比如：</p><ul><li><p>高吞吐的数据库系统可能需要更长的观察周期，避免回收频繁访问的数据页。</p></li><li><p>嵌入式系统或低内存环境可能需要更积极地回收冷页，腾出内存。</p></li></ul><h3 id="_7-2-vs-lru" tabindex="-1"><a class="header-anchor" href="#_7-2-vs-lru"><span>7.2. Vs. LRU</span></a></h3><table><thead><tr><th style="text-align:center;">机制</th><th style="text-align:center;">传统 LRU</th><th style="text-align:center;">kidled</th></tr></thead><tbody><tr><td style="text-align:center;">回收策略</td><td style="text-align:center;">直接基于 LRU（最近最少使用）列表回收</td><td style="text-align:center;">先通过 Access Bit 标记冷页，再回收</td></tr><tr><td style="text-align:center;">容易误删“热”页？</td><td style="text-align:center;">是<br>可能回收活跃页，导致频繁 swap-in</td><td style="text-align:center;">低<br>先标记冷页再回收，避免误删</td></tr><tr><td style="text-align:center;">page fault 影响</td><td style="text-align:center;">容易引发大量 page fault 和 swap-in</td><td style="text-align:center;">降低 page fault 发生概率</td></tr><tr><td style="text-align:center;">CPU 负担</td><td style="text-align:center;">低<br>（简单的 LRU 计算）</td><td style="text-align:center;">略高<br>（需要定期扫描 Access Bit）</td></tr><tr><td style="text-align:center;">适用于</td><td style="text-align:center;">一般场景<br>简单但可能导致 swap 过多</td><td style="text-align:center;">高负载场景<br>优化内存回收效果</td></tr></tbody></table><h3 id="_7-3-kidled-适用的场景" tabindex="-1"><a class="header-anchor" href="#_7-3-kidled-适用的场景"><span>7.3. Kidled 适用的场景</span></a></h3><p>✅ <strong>适合大内存、长时间运行的服务器</strong>，可以减少 swap-in 影响，提高系统响应速度<sup class="footnote-ref"><a href="#footnote3">[3:1]</a><a class="footnote-anchor" id="footnote-ref3:1"></a></sup>。</p><p>✅ <strong>适合内存敏感的应用（如数据库、缓存系统）</strong>，避免误删活跃数据页。</p><p>✅ <strong>适合虚拟机或容器环境</strong>，减少“stolen CPU”（被 Hypervisor 抢占的 CPU 资源），优化资源利用率。</p><p>🚫 <strong>不适合极低内存的嵌入式系统</strong>，因为它会额外占用一些 CPU 资源来扫描页面。</p><h2 id="_8-reference" tabindex="-1"><a class="header-anchor" href="#_8-reference"><span>8. Reference</span></a></h2><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="footnote1" class="footnote-item"><p><a href="https://www.zhihu.com/question/63375062/answer/1403291487" target="_blank" rel="noopener noreferrer">知乎：操作系统中的多级页表到底是为了解决什么问题？</a> <a href="#footnote-ref1" class="footnote-backref">↩︎</a></p></li><li id="footnote2" class="footnote-item"><p>操作系统中的多级页表到底是为了解决什么问题？ - bin 的技术小屋的回答 - 知乎 <a href="https://www.zhihu.com/question/63375062/answer/3158720655" target="_blank" rel="noopener noreferrer">https://www.zhihu.com/question/63375062/answer/3158720655</a> <a href="#footnote-ref2" class="footnote-backref">↩︎</a></p></li><li id="footnote3" class="footnote-item"><p><a href="https://mp.weixin.qq.com/s/S0sc2aysc6aZ5kZCcpMVTw" target="_blank" rel="noopener noreferrer">Linux内核内存性能调优的一些笔记</a> <a href="#footnote-ref3" class="footnote-backref">↩︎</a> <a href="#footnote-ref3:1" class="footnote-backref">↩︎</a></p></li></ol></section></div><!----><!----><!----></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/chenweigao/edit/main/architecture/memory_va_page.md" aria-label="编辑此页" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<!----></a></div><div class="vp-meta-item git-info"><!----><div class="contributors"><span class="vp-meta-label">贡献者: </span><!--[--><!--[--><span class="vp-meta-info" title="email: weigao_1995@yeah.net">weigao chen</span>,<!--]--><!--[--><span class="vp-meta-info" title="email: 297859260@qq.com">chenweigao</span>,<!--]--><!--[--><span class="vp-meta-info" title="email: weigao.cwg">weigao</span>,<!--]--><!--[--><span class="vp-meta-info" title="email: weigao.cwg">xiaocheng</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/architecture/pipline.html" aria-label="Pipeline"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->Pipeline</div></a><a class="route-link auto-link next" href="/architecture/numa_socket.html" aria-label="Numa and Socket"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">Numa and Socket<!----></div></a></nav><div id="comment" class="giscus-wrapper input-top vp-comment" vp-comment style="display:block;"><div style="display: flex;align-items: center;justify-content: center;height: 96px"><span style="--loading-icon: url(&quot;data:image/svg+xml;utf8,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39; viewBox=&#39;25 25 50 50&#39;%3E%3CanimateTransform attributeName=&#39;transform&#39; type=&#39;rotate&#39; dur=&#39;2s&#39; keyTimes=&#39;0;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;360&#39;%3E%3C/animateTransform%3E%3Ccircle cx=&#39;50&#39; cy=&#39;50&#39; r=&#39;20&#39; fill=&#39;none&#39; stroke=&#39;currentColor&#39; stroke-width=&#39;4&#39; stroke-linecap=&#39;round&#39;%3E%3Canimate attributeName=&#39;stroke-dasharray&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;1,200;90,200;1,200&#39;%3E%3C/animate%3E%3Canimate attributeName=&#39;stroke-dashoffset&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;-35px;-125px&#39;%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E&quot;);--icon-size: 48px;display: inline-block;width: var(--icon-size);height: var(--icon-size);background-color: currentcolor;-webkit-mask-image: var(--loading-icon);mask-image: var(--loading-icon)"></span></div></div><!----><!--]--></main><!--]--><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">2017-2023</div><div class="vp-copyright">Copyright © 2025 Someone </div></footer></div><!--]--><!--]--><!--[--><!----><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-11Vuyqh7.js" defer></script>
  </body>
</html>
