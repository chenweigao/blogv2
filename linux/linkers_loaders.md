# Linkers & Loaders

## Abstract

本文章主要是《程序员的自我修养》的读书笔记。

## 目标文件

### 目标文件的格式

- `.o`: 目标文件，就是编译后但是还未链接的那些中间文件。
- `.so`: Linux 下的动态链接库。
- `.elf`: Linux 下的可执行文件。
- `.a`: Linux 下的静态链接库。

这些都是按照可执行文件的格式存储的。

为了更加直观，我们把书中的表格也引用过来：

| ELF 文件类型                      | 说明                                                         | 实例                |
| --------------------------------- | ------------------------------------------------------------ | ------------------- |
| 可重定位文件<br />*Relocatable*   | 包含了代码和数据，可以被用来链接成可执行文件或者共享目标文件；静态链接库也可以属于这一类 | .o, .obj            |
| 可执行文件<br />*Executable*      | 包含了可以直接执行的文件，一般都没有扩展名                   | elf, /bin/bash, exe |
| 共享目标文件<br />*Shared Object* | 包含了代码和数据，可以在以下两种情况中应用：<br />1. 链接器使用这种文件跟其他的可重定位文件和共享目录链接，产生新的目标文件；<br />2. 动态连接器将几个这种文件与可执行文件结合，作为进程映像的一部分来执行。 | .so, DLL            |
| 核心转储文件                      | core dump file, 当进程意外终止的时候，系统可以将该进程的地址空间的内容及终止时的一些其他信息转储到核心转储文件 | core dump           |

如果在遇到不确定的情况下，可以在命令行中使用 `file` 命令来查看相应的文件格式。

注意到以上表格中的文件格式都可统一称为**目标文件**。

### Segement

那么目标文件中都有什么呢？除了必须有的编译后的机器指令代码和数据之外，还包括了链接时所需要的一些信息：符号表、调试信息、字符串等。这些链接所需要的信息都被存储在**段(Segment)**中，也可以称作节(Section).

程序代码编译后的机器指令经常被放在**代码段**中，代码段常见的名字有 .code 和 .text; 全局遍历和静态变量数据经常被放在**数据段**中，一般的名字都叫做 .data. 除此之外，还有一个 BSS 段，其中主要保存的就是未初始化的全局变量和局部静态变量。

| 段            | 含义                                                         |
| ------------- | ------------------------------------------------------------ |
| File Header   | 描述了整个文件的属性。<br />除此之外，还会包括一个段表，用于描述文件中各个段的数组，其内容是各个段在该文件中的偏移位置以及段的属性。 |
| .text section | 编译后的机器代码。                                           |
| .data section | 已初始化的全局变量和局部静态变量。                           |
| .bss section  | 未初始化的全局变量和局部静态变量。                           |

分段的原因和优点如下列举：

- 程序被装载后，数据段是可读写的，而代码段（指令区域）是只读的；

- 将代码段和数据段分开，有助于利用到现在计算机的 icache 和 dcache.
- 有利于代码段的共享；

需要注意，有时候会遇到 .rodata 段，这个段中存放的是只读数据，即对这个段的所有操作都当作非法处理；其次还在语义上支持了 C++ 的 `const` 关键字。

### objdump

```bash
objdump -h xxx.o
```

上述的 -h 选项是可以打印出 elf 文件每个段的基本信息。其中需要注意的是，CONTENTS 属性用来表示该段在文件中存在，如果没有这个属性的字段或者是 0, 我们就可以认为这个属性段在文件中是不存在的。

```bash
objdump -s -d xxx.o
```

-s 参数可以将所有段的内容以 16 进制的方式打印出来；

-d 参数可以将所有包含指令的段反汇编。

```bash
objdump -s -d -x xxx.o
```

-x 参数可以打印出详细信息，比如说这个文件里面的段，每个段具体的内容等。

